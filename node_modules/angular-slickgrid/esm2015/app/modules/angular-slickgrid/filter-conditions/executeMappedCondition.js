import { booleanFilterCondition } from './booleanFilterCondition';
import { collectionSearchFilterCondition } from './collectionSearchFilterCondition';
import { numberFilterCondition } from './numberFilterCondition';
import { objectFilterCondition } from './objectFilterCondition';
import { stringFilterCondition } from './stringFilterCondition';
import { FieldType, OperatorType } from '../models/index';
import { mapMomentDateFormatWithFieldType } from './../services/utilities';
import { testFilterCondition } from './filterUtilities';
import * as moment_ from 'moment-mini';
const moment = moment_; // patch to fix rollup "moment has no default export" issue, document here https://github.com/rollup/rollup/issues/670
export const executeMappedCondition = (options) => {
    // when using a multi-select ('IN' operator) we will not use the field type but instead go directly with a collection search
    const operator = options && options.operator && options.operator.toUpperCase();
    if (operator === 'IN' || operator === 'NIN' || operator === 'IN_CONTAINS' || operator === 'NIN_CONTAINS') {
        return collectionSearchFilterCondition(options);
    }
    // execute the mapped type, or default to String condition check
    switch (options.fieldType) {
        case FieldType.boolean:
            return booleanFilterCondition(options);
        case FieldType.date:
        case FieldType.dateIso:
        case FieldType.dateUtc:
        case FieldType.dateTime:
        case FieldType.dateTimeIso:
        case FieldType.dateTimeIsoAmPm:
        case FieldType.dateTimeIsoAM_PM:
        case FieldType.dateTimeShortIso:
        case FieldType.dateEuro:
        case FieldType.dateEuroShort:
        case FieldType.dateTimeShortEuro:
        case FieldType.dateTimeEuro:
        case FieldType.dateTimeEuroAmPm:
        case FieldType.dateTimeEuroAM_PM:
        case FieldType.dateTimeEuroShort:
        case FieldType.dateTimeEuroShortAmPm:
        case FieldType.dateTimeEuroShortAM_PM:
        case FieldType.dateUs:
        case FieldType.dateUsShort:
        case FieldType.dateTimeShortUs:
        case FieldType.dateTimeUs:
        case FieldType.dateTimeUsAmPm:
        case FieldType.dateTimeUsAM_PM:
        case FieldType.dateTimeUsShort:
        case FieldType.dateTimeUsShortAmPm:
        case FieldType.dateTimeUsShortAM_PM:
            return executeAssociatedDateCondition(options);
        case FieldType.integer:
        case FieldType.float:
        case FieldType.number:
            return numberFilterCondition(options);
        case FieldType.object:
            return objectFilterCondition(options);
        case FieldType.string:
        default:
            return stringFilterCondition(options);
    }
};
/**
 * Execute Date filter condition and use correct date format depending on it's field type (or filterSearchType when that is provided)
 * @param options
 */
function executeAssociatedDateCondition(options) {
    const filterSearchType = options && (options.filterSearchType || options.fieldType) || FieldType.dateIso;
    const FORMAT = mapMomentDateFormatWithFieldType(filterSearchType);
    const searchTerms = Array.isArray(options.searchTerms) && options.searchTerms || [];
    let isRangeSearch = false;
    let dateSearch1;
    let dateSearch2;
    // return when cell value is not a valid date
    if (searchTerms.length === 0 || searchTerms[0] === '' || searchTerms[0] === null || !moment(options.cellValue, FORMAT, true).isValid()) {
        return false;
    }
    // cell value in moment format
    const dateCell = moment(options.cellValue, FORMAT, true);
    if (searchTerms.length === 2 || (searchTerms[0].indexOf('..') > 0)) {
        isRangeSearch = true;
        const searchValues = (searchTerms.length === 2) ? searchTerms : searchTerms[0].split('..');
        const searchValue1 = (Array.isArray(searchValues) && searchValues[0] || '');
        const searchValue2 = (Array.isArray(searchValues) && searchValues[1] || '');
        const searchTerm1 = moment(searchValue1, FORMAT, true);
        const searchTerm2 = moment(searchValue2, FORMAT, true);
        // return if any of the 2 values are invalid dates
        if (!moment(searchTerm1, FORMAT, true).isValid() || !moment(searchTerm2, FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerm1, FORMAT, true);
        dateSearch2 = moment(searchTerm2, FORMAT, true);
    }
    else {
        // return if the search term is an invalid date
        if (!moment(searchTerms[0], FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerms[0], FORMAT, true);
    }
    // run the filter condition with date in Unix Timestamp format
    if (isRangeSearch) {
        const isInclusive = options.operator && options.operator === OperatorType.rangeInclusive;
        const resultCondition1 = testFilterCondition((isInclusive ? '>=' : '>'), parseInt(dateCell.format('X'), 10), parseInt(dateSearch1.format('X'), 10));
        const resultCondition2 = testFilterCondition((isInclusive ? '<=' : '<'), parseInt(dateCell.format('X'), 10), parseInt(dateSearch2.format('X'), 10));
        return (resultCondition1 && resultCondition2);
    }
    return testFilterCondition(options.operator || '==', parseInt(dateCell.format('X'), 10), parseInt(dateSearch1.format('X'), 10));
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvZmlsdGVyLWNvbmRpdGlvbnMvZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVoRSxPQUFPLEVBQUUsU0FBUyxFQUEwQyxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNsRyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEtBQUssT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUV2QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxzSEFBc0g7QUFFOUksTUFBTSxDQUFDLE1BQU0sc0JBQXNCLEdBQW9CLENBQUMsT0FBOEIsRUFBRSxFQUFFO0lBQ3hGLDRIQUE0SDtJQUM1SCxNQUFNLFFBQVEsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9FLElBQUksUUFBUSxLQUFLLElBQUksSUFBSSxRQUFRLEtBQUssS0FBSyxJQUFJLFFBQVEsS0FBSyxhQUFhLElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtRQUN4RyxPQUFP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LFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNwSixPQUFPLENBQUMsZ0JBQWdCLElBQUksZ0JBQWdCLENBQUMsQ0FBQztLQUMvQztJQUNELE9BQU8sbUJBQW1CLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxJQUFJLEVBQUUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNsSSxDQUFDO0FBQUEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJvb2xlYW5GaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL2Jvb2xlYW5GaWx0ZXJDb25kaXRpb24nO1xyXG5pbXBvcnQgeyBjb2xsZWN0aW9uU2VhcmNoRmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9jb2xsZWN0aW9uU2VhcmNoRmlsdGVyQ29uZGl0aW9uJztcclxuaW1wb3J0IHsgbnVtYmVyRmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9udW1iZXJGaWx0ZXJDb25kaXRpb24nO1xyXG5pbXBvcnQgeyBvYmplY3RGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL29iamVjdEZpbHRlckNvbmRpdGlvbic7XHJcbmltcG9ydCB7IHN0cmluZ0ZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vc3RyaW5nRmlsdGVyQ29uZGl0aW9uJztcclxuXHJcbmltcG9ydCB7IEZpZWxkVHlwZSwgRmlsdGVyQ29uZGl0aW9uLCBGaWx0ZXJDb25kaXRpb25PcHRpb24sIE9wZXJhdG9yVHlwZSB9IGZyb20gJy4uL21vZGVscy9pbmRleCc7XHJcbmltcG9ydCB7IG1hcE1vbWVudERhdGVGb3JtYXRXaXRoRmllbGRUeXBlIH0gZnJvbSAnLi8uLi9zZXJ2aWNlcy91dGlsaXRpZXMnO1xyXG5pbXBvcnQgeyB0ZXN0RmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9maWx0ZXJVdGlsaXRpZXMnO1xyXG5pbXBvcnQgKiBhcyBtb21lbnRfIGZyb20gJ21vbWVudC1taW5pJztcclxuXHJcbmNvbnN0IG1vbWVudCA9IG1vbWVudF87IC8vIHBhdGNoIHRvIGZpeCByb2xsdXAgXCJtb21lbnQgaGFzIG5vIGRlZmF1bHQgZXhwb3J0XCIgaXNzdWUsIGRvY3VtZW50IGhlcmUgaHR0cHM6Ly9naXRodWIuY29tL3JvbGx1cC9yb2xsdXAvaXNzdWVzLzY3MFxyXG5cclxuZXhwb3J0IGNvbnN0IGV4ZWN1dGVNYXBwZWRDb25kaXRpb246IEZpbHRlckNvbmRpdGlvbiA9IChvcHRpb25zOiBGaWx0ZXJDb25kaXRpb25PcHRpb24pID0+IHtcclxuICAvLyB3aGVuIHVzaW5nIGEgbXVsdGktc2VsZWN0ICgnSU4nIG9wZXJhdG9yKSB3ZSB3aWxsIG5vdCB1c2UgdGhlIGZpZWxkIHR5cGUgYnV0IGluc3RlYWQgZ28gZGlyZWN0bHkgd2l0aCBhIGNvbGxlY3Rpb24gc2VhcmNoXHJcbiAgY29uc3Qgb3BlcmF0b3IgPSBvcHRpb25zICYmIG9wdGlvbnMub3BlcmF0b3IgJiYgb3B0aW9ucy5vcGVyYXRvci50b1VwcGVyQ2FzZSgpO1xyXG4gIGlmIChvcGVyYXRvciA9PT0gJ0lOJyB8fCBvcGVyYXRvciA9PT0gJ05JTicgfHwgb3BlcmF0b3IgPT09ICdJTl9DT05UQUlOUycgfHwgb3BlcmF0b3IgPT09ICdOSU5fQ09OVEFJTlMnKSB7XHJcbiAgICByZXR1cm4gY29sbGVjdGlvblNlYXJjaEZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIC8vIGV4ZWN1dGUgdGhlIG1hcHBlZCB0eXBlLCBvciBkZWZhdWx0IHRvIFN0cmluZyBjb25kaXRpb24gY2hlY2tcclxuICBzd2l0Y2ggKG9wdGlvbnMuZmllbGRUeXBlKSB7XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5ib29sZWFuOlxyXG4gICAgICByZXR1cm4gYm9vbGVhbkZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGU6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlSXNvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVV0YzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVJc286XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUlzb0FtUG06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUlzb0FNX1BNOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVTaG9ydElzbzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVFdXJvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZUV1cm9TaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lU2hvcnRFdXJvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvQW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb0FNX1BNOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvU2hvcnQ6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9TaG9ydEFtUG06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9TaG9ydEFNX1BNOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVVzOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVVzU2hvcnQ6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVNob3J0VXM6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVVc0FtUG06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzQU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzU2hvcnQ6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzU2hvcnRBbVBtOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVVc1Nob3J0QU1fUE06XHJcbiAgICAgIHJldHVybiBleGVjdXRlQXNzb2NpYXRlZERhdGVDb25kaXRpb24ob3B0aW9ucyk7XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5pbnRlZ2VyOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZmxvYXQ6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5udW1iZXI6XHJcbiAgICAgIHJldHVybiBudW1iZXJGaWx0ZXJDb25kaXRpb24ob3B0aW9ucyk7XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5vYmplY3Q6XHJcbiAgICAgIHJldHVybiBvYmplY3RGaWx0ZXJDb25kaXRpb24ob3B0aW9ucyk7XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5zdHJpbmc6XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gc3RyaW5nRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBFeGVjdXRlIERhdGUgZmlsdGVyIGNvbmRpdGlvbiBhbmQgdXNlIGNvcnJlY3QgZGF0ZSBmb3JtYXQgZGVwZW5kaW5nIG9uIGl0J3MgZmllbGQgdHlwZSAob3IgZmlsdGVyU2VhcmNoVHlwZSB3aGVuIHRoYXQgaXMgcHJvdmlkZWQpXHJcbiAqIEBwYXJhbSBvcHRpb25zXHJcbiAqL1xyXG5mdW5jdGlvbiBleGVjdXRlQXNzb2NpYXRlZERhdGVDb25kaXRpb24ob3B0aW9uczogRmlsdGVyQ29uZGl0aW9uT3B0aW9uKTogYm9vbGVhbiB7XHJcbiAgY29uc3QgZmlsdGVyU2VhcmNoVHlwZSA9IG9wdGlvbnMgJiYgKG9wdGlvbnMuZmlsdGVyU2VhcmNoVHlwZSB8fCBvcHRpb25zLmZpZWxkVHlwZSkgfHwgRmllbGRUeXBlLmRhdGVJc287XHJcbiAgY29uc3QgRk9STUFUID0gbWFwTW9tZW50RGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUoZmlsdGVyU2VhcmNoVHlwZSk7XHJcbiAgY29uc3Qgc2VhcmNoVGVybXMgPSBBcnJheS5pc0FycmF5KG9wdGlvbnMuc2VhcmNoVGVybXMpICYmIG9wdGlvbnMuc2VhcmNoVGVybXMgfHwgW107XHJcblxyXG4gIGxldCBpc1JhbmdlU2VhcmNoID0gZmFsc2U7XHJcbiAgbGV0IGRhdGVTZWFyY2gxOiBhbnk7XHJcbiAgbGV0IGRhdGVTZWFyY2gyOiBhbnk7XHJcblxyXG4gIC8vIHJldHVybiB3aGVuIGNlbGwgdmFsdWUgaXMgbm90IGEgdmFsaWQgZGF0ZVxyXG4gIGlmIChzZWFyY2hUZXJtcy5sZW5ndGggPT09IDAgfHwgc2VhcmNoVGVybXNbMF0gPT09ICcnIHx8IHNlYXJjaFRlcm1zWzBdID09PSBudWxsIHx8ICFtb21lbnQob3B0aW9ucy5jZWxsVmFsdWUsIEZPUk1BVCwgdHJ1ZSkuaXNWYWxpZCgpKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICAvLyBjZWxsIHZhbHVlIGluIG1vbWVudCBmb3JtYXRcclxuICBjb25zdCBkYXRlQ2VsbCA9IG1vbWVudChvcHRpb25zLmNlbGxWYWx1ZSwgRk9STUFULCB0cnVlKTtcclxuXHJcbiAgaWYgKHNlYXJjaFRlcm1zLmxlbmd0aCA9PT0gMiB8fCAoKHNlYXJjaFRlcm1zWzBdIGFzIHN0cmluZykuaW5kZXhPZignLi4nKSA+IDApKSB7XHJcbiAgICBpc1JhbmdlU2VhcmNoID0gdHJ1ZTtcclxuICAgIGNvbnN0IHNlYXJjaFZhbHVlcyA9IChzZWFyY2hUZXJtcy5sZW5ndGggPT09IDIpID8gc2VhcmNoVGVybXMgOiAoc2VhcmNoVGVybXNbMF0gYXMgc3RyaW5nKS5zcGxpdCgnLi4nKTtcclxuICAgIGNvbnN0IHNlYXJjaFZhbHVlMSA9IChBcnJheS5pc0FycmF5KHNlYXJjaFZhbHVlcykgJiYgc2VhcmNoVmFsdWVzWzBdIHx8ICcnKSBhcyBEYXRlIHwgc3RyaW5nO1xyXG4gICAgY29uc3Qgc2VhcmNoVmFsdWUyID0gKEFycmF5LmlzQXJyYXkoc2VhcmNoVmFsdWVzKSAmJiBzZWFyY2hWYWx1ZXNbMV0gfHwgJycpIGFzIERhdGUgfCBzdHJpbmc7XHJcbiAgICBjb25zdCBzZWFyY2hUZXJtMSA9IG1vbWVudChzZWFyY2hWYWx1ZTEsIEZPUk1BVCwgdHJ1ZSk7XHJcbiAgICBjb25zdCBzZWFyY2hUZXJtMiA9IG1vbWVudChzZWFyY2hWYWx1ZTIsIEZPUk1BVCwgdHJ1ZSk7XHJcblxyXG4gICAgLy8gcmV0dXJuIGlmIGFueSBvZiB0aGUgMiB2YWx1ZXMgYXJlIGludmFsaWQgZGF0ZXNcclxuICAgIGlmICghbW9tZW50KHNlYXJjaFRlcm0xLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSB8fCAhbW9tZW50KHNlYXJjaFRlcm0yLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBkYXRlU2VhcmNoMSA9IG1vbWVudChzZWFyY2hUZXJtMSwgRk9STUFULCB0cnVlKTtcclxuICAgIGRhdGVTZWFyY2gyID0gbW9tZW50KHNlYXJjaFRlcm0yLCBGT1JNQVQsIHRydWUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICAvLyByZXR1cm4gaWYgdGhlIHNlYXJjaCB0ZXJtIGlzIGFuIGludmFsaWQgZGF0ZVxyXG4gICAgaWYgKCFtb21lbnQoc2VhcmNoVGVybXNbMF0gYXMgRGF0ZSB8IHN0cmluZywgRk9STUFULCB0cnVlKS5pc1ZhbGlkKCkpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgZGF0ZVNlYXJjaDEgPSBtb21lbnQoc2VhcmNoVGVybXNbMF0gYXMgRGF0ZSB8IHN0cmluZywgRk9STUFULCB0cnVlKTtcclxuICB9XHJcblxyXG4gIC8vIHJ1biB0aGUgZmlsdGVyIGNvbmRpdGlvbiB3aXRoIGRhdGUgaW4gVW5peCBUaW1lc3RhbXAgZm9ybWF0XHJcbiAgaWYgKGlzUmFuZ2VTZWFyY2gpIHtcclxuICAgIGNvbnN0IGlzSW5jbHVzaXZlID0gb3B0aW9ucy5vcGVyYXRvciAmJiBvcHRpb25zLm9wZXJhdG9yID09PSBPcGVyYXRvclR5cGUucmFuZ2VJbmNsdXNpdmU7XHJcbiAgICBjb25zdCByZXN1bHRDb25kaXRpb24xID0gdGVzdEZpbHRlckNvbmRpdGlvbigoaXNJbmNsdXNpdmUgPyAnPj0nIDogJz4nKSwgcGFyc2VJbnQoZGF0ZUNlbGwuZm9ybWF0KCdYJyksIDEwKSwgcGFyc2VJbnQoZGF0ZVNlYXJjaDEuZm9ybWF0KCdYJyksIDEwKSk7XHJcbiAgICBjb25zdCByZXN1bHRDb25kaXRpb24yID0gdGVzdEZpbHRlckNvbmRpdGlvbigoaXNJbmNsdXNpdmUgPyAnPD0nIDogJzwnKSwgcGFyc2VJbnQoZGF0ZUNlbGwuZm9ybWF0KCdYJyksIDEwKSwgcGFyc2VJbnQoZGF0ZVNlYXJjaDIuZm9ybWF0KCdYJyksIDEwKSk7XHJcbiAgICByZXR1cm4gKHJlc3VsdENvbmRpdGlvbjEgJiYgcmVzdWx0Q29uZGl0aW9uMik7XHJcbiAgfVxyXG4gIHJldHVybiB0ZXN0RmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMub3BlcmF0b3IgfHwgJz09JywgcGFyc2VJbnQoZGF0ZUNlbGwuZm9ybWF0KCdYJyksIDEwKSwgcGFyc2VJbnQoZGF0ZVNlYXJjaDEuZm9ybWF0KCdYJyksIDEwKSk7XHJcbn07XHJcbiJdfQ==