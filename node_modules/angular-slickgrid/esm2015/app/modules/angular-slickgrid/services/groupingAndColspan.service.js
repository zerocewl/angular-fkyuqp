import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { ResizerService } from './resizer.service';
let GroupingAndColspanService = class GroupingAndColspanService {
    constructor(resizerService, translate) {
        this.resizerService = resizerService;
        this.translate = translate;
        this._eventHandler = new Slick.EventHandler();
    }
    /** Getter of the SlickGrid Event Handler */
    get eventHandler() {
        return this._eventHandler;
    }
    /** Getter for the Grid Options pulled through the Grid Object */
    get _gridOptions() {
        return (this._grid && this._grid.getOptions) ? this._grid.getOptions() : {};
    }
    /** Getter for the Column Definitions pulled through the Grid Object */
    get _columnDefinitions() {
        return (this._grid && this._grid.getColumns) ? this._grid.getColumns() : [];
    }
    init(grid, dataView) {
        this._grid = grid;
        if (grid && this._gridOptions) {
            // When dealing with Pre-Header Grouping colspan, we need to re-create the pre-header in multiple occasions
            // for all these events, we have to trigger a re-create
            if (this._gridOptions.createPreHeaderPanel) {
                // on all following events, call the
                this._eventHandler.subscribe(grid.onSort, () => this.renderPreHeaderRowGroupingTitles());
                this._eventHandler.subscribe(grid.onColumnsResized, () => this.renderPreHeaderRowGroupingTitles());
                this._eventHandler.subscribe(grid.onColumnsReordered, () => this.renderPreHeaderRowGroupingTitles());
                this._eventHandler.subscribe(dataView.onRowCountChanged, () => this.renderPreHeaderRowGroupingTitles());
                this.resizerService.onGridAfterResize.subscribe(() => this.renderPreHeaderRowGroupingTitles());
                // if we use Translation, we need to re-translate the keys after a language change
                if (this._gridOptions.enableTranslate) {
                    this.translate.onLangChange.subscribe(() => {
                        const currentColumnDefinitions = this._grid.getColumns();
                        this.translateItems(currentColumnDefinitions, 'columnGroupKey', 'columnGroup');
                        this._grid.setColumns(currentColumnDefinitions);
                        this.renderPreHeaderRowGroupingTitles();
                    });
                }
                // also not sure why at this point, but it seems that I need to call the 1st create in a delayed execution
                // probably some kind of timing issues and delaying it until the grid is fully ready does help
                setTimeout(() => this.renderPreHeaderRowGroupingTitles(), 50);
            }
        }
    }
    dispose() {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
    }
    /** Create or Render the Pre-Header Row Grouping Titles */
    renderPreHeaderRowGroupingTitles() {
        if (this._gridOptions && this._gridOptions.frozenColumn !== undefined && this._gridOptions.frozenColumn >= 0) {
            // Add column groups to left panel
            let $preHeaderPanel = $(this._grid.getPreHeaderPanelLeft());
            this.renderHeaderGroups($preHeaderPanel, 0, this._gridOptions.frozenColumn + 1);
            // Add column groups to right panel
            $preHeaderPanel = $(this._grid.getPreHeaderPanelRight());
            this.renderHeaderGroups($preHeaderPanel, this._gridOptions.frozenColumn + 1, this._columnDefinitions.length);
        }
        else {
            // regular grid (not a frozen grid)
            const $preHeaderPanel = $(this._grid.getPreHeaderPanel());
            this.renderHeaderGroups($preHeaderPanel, 0, this._columnDefinitions.length);
        }
    }
    renderHeaderGroups(preHeaderPanel, start, end) {
        preHeaderPanel.empty()
            .addClass('slick-header-columns')
            .css('left', '-1000px')
            .width(this._grid.getHeadersWidth());
        preHeaderPanel.parent().addClass('slick-header');
        const headerColumnWidthDiff = this._grid.getHeaderColumnWidthDiff();
        let colDef;
        let header;
        let lastColumnGroup = '';
        let widthTotal = 0;
        for (let i = start; i < end; i++) {
            colDef = this._columnDefinitions[i];
            if (colDef) {
                if (lastColumnGroup === colDef.columnGroup && i > 0) {
                    widthTotal += colDef.width || 0;
                    if (header && header.width) {
                        header.width(widthTotal - headerColumnWidthDiff);
                    }
                }
                else {
                    widthTotal = colDef.width || 0;
                    header = $(`<div class="ui-state-default slick-header-column" />`)
                        .html(`<span class="slick-column-name">${colDef.columnGroup || ''}</span>`)
                        .width(widthTotal - headerColumnWidthDiff)
                        .appendTo(preHeaderPanel);
                }
                lastColumnGroup = colDef.columnGroup || '';
            }
        }
    }
    /** Translate the an array of items from an input key and assign to the output key */
    translateItems(items, inputKey, outputKey) {
        if (Array.isArray(items)) {
            for (const item of items) {
                if (item[inputKey]) {
                    item[outputKey] = this.translate && this.translate && this.translate.instant && this.translate.instant(item[inputKey]);
                }
            }
        }
    }
};
GroupingAndColspanService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(1, Optional()),
    tslib_1.__metadata("design:paramtypes", [ResizerService, TranslateService])
], GroupingAndColspanService);
export { GroupingAndColspanService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXBpbmdBbmRDb2xzcGFuLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL3NlcnZpY2VzL2dyb3VwaW5nQW5kQ29sc3Bhbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFTbkQsSUFBYSx5QkFBeUIsR0FBdEMsTUFBYSx5QkFBeUI7SUFJcEMsWUFBb0IsY0FBOEIsRUFBc0IsU0FBMkI7UUFBL0UsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQXNCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQ2pHLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUVELDRDQUE0QztJQUM1QyxJQUFJLFlBQVk7UUFDZCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDNUIsQ0FBQztJQUVELGlFQUFpRTtJQUNqRSxJQUFZLFlBQVk7UUFDdEIsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzlFLENBQUM7SUFFRCx1RUFBdUU7SUFDdkUsSUFBWSxrQkFBa0I7UUFDNUIsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxV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ZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgQ29sdW1uLCBHcmlkT3B0aW9uLCBTbGlja0V2ZW50SGFuZGxlciB9IGZyb20gJy4vLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgUmVzaXplclNlcnZpY2UgfSBmcm9tICcuL3Jlc2l6ZXIuc2VydmljZSc7XHJcblxyXG4vLyB1c2luZyBleHRlcm5hbCBub24tdHlwZWQganMgbGlicmFyaWVzXHJcbmRlY2xhcmUgbGV0ICQ6IGFueTtcclxuXHJcbi8vIHVzaW5nIGV4dGVybmFsIG5vbi10eXBlZCBqcyBsaWJyYXJpZXNcclxuZGVjbGFyZSB2YXIgU2xpY2s6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEdyb3VwaW5nQW5kQ29sc3BhblNlcnZpY2Uge1xyXG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlcjogU2xpY2tFdmVudEhhbmRsZXI7XHJcbiAgcHJpdmF0ZSBfZ3JpZDogYW55O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlc2l6ZXJTZXJ2aWNlOiBSZXNpemVyU2VydmljZSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UpIHtcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlciA9IG5ldyBTbGljay5FdmVudEhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIC8qKiBHZXR0ZXIgb2YgdGhlIFNsaWNrR3JpZCBFdmVudCBIYW5kbGVyICovXHJcbiAgZ2V0IGV2ZW50SGFuZGxlcigpOiBTbGlja0V2ZW50SGFuZGxlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRIYW5kbGVyO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldHRlciBmb3IgdGhlIEdyaWQgT3B0aW9ucyBwdWxsZWQgdGhyb3VnaCB0aGUgR3JpZCBPYmplY3QgKi9cclxuICBwcml2YXRlIGdldCBfZ3JpZE9wdGlvbnMoKTogR3JpZE9wdGlvbiB7XHJcbiAgICByZXR1cm4gKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZC5nZXRPcHRpb25zKSA/IHRoaXMuX2dyaWQuZ2V0T3B0aW9ucygpIDoge307XHJcbiAgfVxyXG5cclxuICAvKiogR2V0dGVyIGZvciB0aGUgQ29sdW1uIERlZmluaXRpb25zIHB1bGxlZCB0aHJvdWdoIHRoZSBHcmlkIE9iamVjdCAqL1xyXG4gIHByaXZhdGUgZ2V0IF9jb2x1bW5EZWZpbml0aW9ucygpOiBDb2x1bW5bXSB7XHJcbiAgICByZXR1cm4gKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZC5nZXRDb2x1bW5zKSA/IHRoaXMuX2dyaWQuZ2V0Q29sdW1ucygpIDogW107XHJcbiAgfVxyXG5cclxuICBpbml0KGdyaWQ6IGFueSwgZGF0YVZpZXc6IGFueSkge1xyXG4gICAgdGhpcy5fZ3JpZCA9IGdyaWQ7XHJcblxyXG4gICAgaWYgKGdyaWQgJiYgdGhpcy5fZ3JpZE9wdGlvbnMpIHtcclxuICAgICAgLy8gV2hlbiBkZWFsaW5nIHdpdGggUHJlLUhlYWRlciBHcm91cGluZyBjb2xzcGFuLCB3ZSBuZWVkIHRvIHJlLWNyZWF0ZSB0aGUgcHJlLWhlYWRlciBpbiBtdWx0aXBsZSBvY2Nhc2lvbnNcclxuICAgICAgLy8gZm9yIGFsbCB0aGVzZSBldmVudHMsIHdlIGhhdmUgdG8gdHJpZ2dlciBhIHJlLWNyZWF0ZVxyXG4gICAgICBpZiAodGhpcy5fZ3JpZE9wdGlvbnMuY3JlYXRlUHJlSGVhZGVyUGFuZWwpIHtcclxuICAgICAgICAvLyBvbiBhbGwgZm9sbG93aW5nIGV2ZW50cywgY2FsbCB0aGVcclxuICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKGdyaWQub25Tb3J0LCAoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUoZ3JpZC5vbkNvbHVtbnNSZXNpemVkLCAoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUoZ3JpZC5vbkNvbHVtbnNSZW9yZGVyZWQsICgpID0+IHRoaXMucmVuZGVyUHJlSGVhZGVyUm93R3JvdXBpbmdUaXRsZXMoKSk7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZShkYXRhVmlldy5vblJvd0NvdW50Q2hhbmdlZCwgKCkgPT4gdGhpcy5yZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygpKTtcclxuICAgICAgICB0aGlzLnJlc2l6ZXJTZXJ2aWNlLm9uR3JpZEFmdGVyUmVzaXplLnN1YnNjcmliZSgoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG5cclxuICAgICAgICAvLyBpZiB3ZSB1c2UgVHJhbnNsYXRpb24sIHdlIG5lZWQgdG8gcmUtdHJhbnNsYXRlIHRoZSBrZXlzIGFmdGVyIGEgbGFuZ3VhZ2UgY2hhbmdlXHJcbiAgICAgICAgaWYgKHRoaXMuX2dyaWRPcHRpb25zLmVuYWJsZVRyYW5zbGF0ZSkge1xyXG4gICAgICAgICAgdGhpcy50cmFuc2xhdGUub25MYW5nQ2hhbmdlLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5EZWZpbml0aW9ucyA9IHRoaXMuX2dyaWQuZ2V0Q29sdW1ucygpO1xyXG4gICAgICAgICAgICB0aGlzLnRyYW5zbGF0ZUl0ZW1zKGN1cnJlbnRDb2x1bW5EZWZpbml0aW9ucywgJ2NvbHVtbkdyb3VwS2V5JywgJ2NvbHVtbkdyb3VwJyk7XHJcbiAgICAgICAgICAgIHRoaXMuX2dyaWQuc2V0Q29sdW1ucyhjdXJyZW50Q29sdW1uRGVmaW5pdGlvbnMpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGFsc28gbm90IHN1cmUgd2h5IGF0IHRoaXMgcG9pbnQsIGJ1dCBpdCBzZWVtcyB0aGF0IEkgbmVlZCB0byBjYWxsIHRoZSAxc3QgY3JlYXRlIGluIGEgZGVsYXllZCBleGVjdXRpb25cclxuICAgICAgICAvLyBwcm9iYWJseSBzb21lIGtpbmQgb2YgdGltaW5nIGlzc3VlcyBhbmQgZGVsYXlpbmcgaXQgdW50aWwgdGhlIGdyaWQgaXMgZnVsbHkgcmVhZHkgZG9lcyBoZWxwXHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCksIDUwKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIC8vIHVuc3Vic2NyaWJlIGFsbCBTbGlja0dyaWQgZXZlbnRzXHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIudW5zdWJzY3JpYmVBbGwoKTtcclxuICB9XHJcblxyXG4gIC8qKiBDcmVhdGUgb3IgUmVuZGVyIHRoZSBQcmUtSGVhZGVyIFJvdyBHcm91cGluZyBUaXRsZXMgKi9cclxuICByZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygpIHtcclxuICAgIGlmICh0aGlzLl9ncmlkT3B0aW9ucyAmJiB0aGlzLl9ncmlkT3B0aW9ucy5mcm96ZW5Db2x1bW4gIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9ncmlkT3B0aW9ucy5mcm96ZW5Db2x1bW4gPj0gMCkge1xyXG4gICAgICAvLyBBZGQgY29sdW1uIGdyb3VwcyB0byBsZWZ0IHBhbmVsXHJcbiAgICAgIGxldCAkcHJlSGVhZGVyUGFuZWwgPSAkKHRoaXMuX2dyaWQuZ2V0UHJlSGVhZGVyUGFuZWxMZWZ0KCkpO1xyXG4gICAgICB0aGlzLnJlbmRlckhlYWRlckdyb3VwcygkcHJlSGVhZGVyUGFuZWwsIDAsIHRoaXMuX2dyaWRPcHRpb25zLmZyb3plbkNvbHVtbiArIDEpO1xyXG5cclxuICAgICAgLy8gQWRkIGNvbHVtbiBncm91cHMgdG8gcmlnaHQgcGFuZWxcclxuICAgICAgJHByZUhlYWRlclBhbmVsID0gJCh0aGlzLl9ncmlkLmdldFByZUhlYWRlclBhbmVsUmlnaHQoKSk7XHJcbiAgICAgIHRoaXMucmVuZGVySGVhZGVyR3JvdXBzKCRwcmVIZWFkZXJQYW5lbCwgdGhpcy5fZ3JpZE9wdGlvbnMuZnJvemVuQ29sdW1uICsgMSwgdGhpcy5fY29sdW1uRGVmaW5pdGlvbnMubGVuZ3RoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIHJlZ3VsYXIgZ3JpZCAobm90IGEgZnJvemVuIGdyaWQpXHJcbiAgICAgIGNvbnN0ICRwcmVIZWFkZXJQYW5lbCA9ICQodGhpcy5fZ3JpZC5nZXRQcmVIZWFkZXJQYW5lbCgpKTtcclxuICAgICAgdGhpcy5yZW5kZXJIZWFkZXJHcm91cHMoJHByZUhlYWRlclBhbmVsLCAwLCB0aGlzLl9jb2x1bW5EZWZpbml0aW9ucy5sZW5ndGgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVuZGVySGVhZGVyR3JvdXBzKHByZUhlYWRlclBhbmVsOiBhbnksIHN0YXJ0OiBudW1iZXIsIGVuZDogbnVtYmVyKSB7XHJcbiAgICBwcmVIZWFkZXJQYW5lbC5lbXB0eSgpXHJcbiAgICAgIC5hZGRDbGFzcygnc2xpY2staGVhZGVyLWNvbHVtbnMnKVxyXG4gICAgICAuY3NzKCdsZWZ0JywgJy0xMDAwcHgnKVxyXG4gICAgICAud2lkdGgodGhpcy5fZ3JpZC5nZXRIZWFkZXJzV2lkdGgoKSk7XHJcbiAgICBwcmVIZWFkZXJQYW5lbC5wYXJlbnQoKS5hZGRDbGFzcygnc2xpY2staGVhZGVyJyk7XHJcblxyXG4gICAgY29uc3QgaGVhZGVyQ29sdW1uV2lkdGhEaWZmID0gdGhpcy5fZ3JpZC5nZXRIZWFkZXJDb2x1bW5XaWR0aERpZmYoKTtcclxuXHJcbiAgICBsZXQgY29sRGVmO1xyXG4gICAgbGV0IGhlYWRlcjtcclxuICAgIGxldCBsYXN0Q29sdW1uR3JvdXAgPSAnJztcclxuICAgIGxldCB3aWR0aFRvdGFsID0gMDtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykge1xyXG4gICAgICBjb2xEZWYgPSB0aGlzLl9jb2x1bW5EZWZpbml0aW9uc1tpXTtcclxuICAgICAgaWYgKGNvbERlZikge1xyXG4gICAgICAgIGlmIChsYXN0Q29sdW1uR3JvdXAgPT09IGNvbERlZi5jb2x1bW5Hcm91cCAmJiBpID4gMCkge1xyXG4gICAgICAgICAgd2lkdGhUb3RhbCArPSBjb2xEZWYud2lkdGggfHwgMDtcclxuICAgICAgICAgIGlmIChoZWFkZXIgJiYgaGVhZGVyLndpZHRoKSB7XHJcbiAgICAgICAgICAgIGhlYWRlci53aWR0aCh3aWR0aFRvdGFsIC0gaGVhZGVyQ29sdW1uV2lkdGhEaWZmKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgd2lkdGhUb3RhbCA9IGNvbERlZi53aWR0aCB8fCAwO1xyXG4gICAgICAgICAgaGVhZGVyID0gJChgPGRpdiBjbGFzcz1cInVpLXN0YXRlLWRlZmF1bHQgc2xpY2staGVhZGVyLWNvbHVtblwiIC8+YClcclxuICAgICAgICAgICAgLmh0bWwoYDxzcGFuIGNsYXNzPVwic2xpY2stY29sdW1uLW5hbWVcIj4ke2NvbERlZi5jb2x1bW5Hcm91cCB8fCAnJ308L3NwYW4+YClcclxuICAgICAgICAgICAgLndpZHRoKHdpZHRoVG90YWwgLSBoZWFkZXJDb2x1bW5XaWR0aERpZmYpXHJcbiAgICAgICAgICAgIC5hcHBlbmRUbyhwcmVIZWFkZXJQYW5lbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxhc3RDb2x1bW5Hcm91cCA9IGNvbERlZi5jb2x1bW5Hcm91cCB8fCAnJztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIFRyYW5zbGF0ZSB0aGUgYW4gYXJyYXkgb2YgaXRlbXMgZnJvbSBhbiBpbnB1dCBrZXkgYW5kIGFzc2lnbiB0byB0aGUgb3V0cHV0IGtleSAqL1xyXG4gIHRyYW5zbGF0ZUl0ZW1zKGl0ZW1zOiBhbnlbXSwgaW5wdXRLZXk6IHN0cmluZywgb3V0cHV0S2V5OiBzdHJpbmcpIHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW1zKSkge1xyXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHtcclxuICAgICAgICBpZiAoaXRlbVtpbnB1dEtleV0pIHtcclxuICAgICAgICAgIGl0ZW1bb3V0cHV0S2V5XSA9IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChpdGVtW2lucHV0S2V5XSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==