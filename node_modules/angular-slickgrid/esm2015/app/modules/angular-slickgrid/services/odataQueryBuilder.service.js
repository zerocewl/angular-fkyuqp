import { CaseType } from '../models/index';
import { titleCase } from './utilities';
export class OdataQueryBuilderService {
    constructor() {
        this._odataOptions = {
            filterQueue: [],
            orderBy: ''
        };
        this._defaultSortBy = '';
        this._columnFilters = {};
    }
    /*
      * Build the OData query string from all the options provided
      * @return string OData query
      */
    buildQuery() {
        if (!this._odataOptions) {
            throw new Error('Odata Service requires certain options like "top" for it to work');
        }
        this._odataOptions.filterQueue = [];
        const queryTmpArray = [];
        // When enableCount is set, add it to the OData query
        if (this._odataOptions.enableCount === true) {
            const countQuery = (this._odataOptions.version >= 4) ? '$count=true' : '$inlinecount=allpages';
            queryTmpArray.push(countQuery);
        }
        if (this._odataOptions.top) {
            queryTmpArray.push(`$top=${this._odataOptions.top}`);
        }
        if (this._odataOptions.skip) {
            queryTmpArray.push(`$skip=${this._odataOptions.skip}`);
        }
        if (this._odataOptions.orderBy) {
            let argument = '';
            if (Array.isArray(this._odataOptions.orderBy)) {
                argument = this._odataOptions.orderBy.join(','); // csv, that will form a query, for example: $orderby=RoleName asc, Id desc
            }
            else {
                argument = this._odataOptions.orderBy;
            }
            queryTmpArray.push(`$orderby=${argument}`);
        }
        if (this._odataOptions.filterBy || this._odataOptions.filter) {
            const filterBy = this._odataOptions.filter || this._odataOptions.filterBy;
            if (filterBy) {
                this._filterCount = 1;
                this._odataOptions.filterQueue = [];
                let filterStr = filterBy;
                if (Array.isArray(filterBy)) {
                    this._filterCount = filterBy.length;
                    filterStr = filterBy.join(` ${this._odataOptions.filterBySeparator || 'and'} `);
                }
                if (typeof filterStr === 'string') {
                    if (!(filterStr[0] === '(' && filterStr.slice(-1) === ')')) {
                        this.addToFilterQueueWhenNotExists(`(${filterStr})`);
                    }
                    else {
                        this.addToFilterQueueWhenNotExists(filterStr);
                    }
                }
            }
        }
        if (this._odataOptions.filterQueue.length > 0) {
            const query = this._odataOptions.filterQueue.join(` ${this._odataOptions.filterBySeparator || 'and'} `);
            this._odataOptions.filter = query; // overwrite with
            queryTmpArray.push(`$filter=${query}`);
        }
        // join all the odata functions by a '&'
        return queryTmpArray.join('&');
    }
    getFilterCount() {
        return this._filterCount;
    }
    get columnFilters() {
        return this._columnFilters;
    }
    get options() {
        return this._odataOptions;
    }
    set options(options) {
        this._odataOptions = options;
    }
    removeColumnFilter(fieldName) {
        if (this._columnFilters && this._columnFilters.hasOwnProperty(fieldName)) {
            delete this._columnFilters[fieldName];
        }
    }
    saveColumnFilter(fieldName, value, searchTerms) {
        this._columnFilters[fieldName] = {
            search: searchTerms,
            value
        };
    }
    /**
     * Change any OData options that will be used to build the query
     * @param object options
     */
    updateOptions(options) {
        for (const property of Object.keys(options)) {
            if (options.hasOwnProperty(property)) {
                this._odataOptions[property] = options[property]; // replace of the property
            }
            // we need to keep the defaultSortBy for references whenever the user removes his Sorting
            // then we would revert to the defaultSortBy and the only way is to keep a hard copy here
            if (property === 'orderBy' || property === 'sortBy') {
                let sortBy = options[property];
                // make sure first char of each orderBy field is capitalize
                if (this._odataOptions.caseType === CaseType.pascalCase) {
                    if (Array.isArray(sortBy)) {
                        sortBy.forEach((field, index, inputArray) => {
                            inputArray[index] = titleCase(field);
                        });
                    }
                    else {
                        sortBy = titleCase(options[property]);
                    }
                }
                this._odataOptions.orderBy = sortBy;
                this._defaultSortBy = sortBy;
            }
        }
    }
    //
    // private functions
    // -------------------
    addToFilterQueueWhenNotExists(filterStr) {
        if (this._odataOptions.filterQueue && this._odataOptions.filterQueue.indexOf(filterStr) === -1) {
            this._odataOptions.filterQueue.push(filterStr);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGFRdWVyeUJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvc2VydmljZXMvb2RhdGFRdWVyeUJ1aWxkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFlLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV4QyxNQUFNLE9BQU8sd0JBQXdCO0lBTW5DO1FBQ0UsSUFBSSxDQUFDLGFBQWEsR0FBRztZQUNuQixXQUFXLEVBQUUsRUFBRTtZQUNmLE9BQU8sRUFBRSxFQUFFO1NBQ1osQ0FBQztRQUNGLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7O1FBR0k7SUFDSixVQUFVO1FBQ1IsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrRUFBa0UsQ0FBQyxDQUFDO1NBQ3JGO1FBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUV6QixxREFBcUQ7UUFDckQsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsS0FBSyxJQUFJLEVBQUU7WUFDM0MsTUFBTSxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyx1QkFBdUIsQ0FBQztZQUMvRixhQUFhLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ2hDO1FBRUQsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFD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QUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxFQUFFOzRCQUMxQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO3dCQUN2QyxDQUFDLENBQUMsQ0FBQztxQkFDSjt5QkFBTTt3QkFDTCxNQUFNLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO3FCQUN2QztpQkFDRjtnQkFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7Z0JBQ3BDLElBQUksQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUFDO2FBQzlCO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsRUFBRTtJQUNGLG9CQUFvQjtJQUNwQixzQkFBc0I7SUFFZCw2QkFBNkIsQ0FBQyxTQUFpQjtRQUNyRCxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUM5RixJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDaEQ7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXNlVHlwZSwgT2RhdGFPcHRpb24gfSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyB0aXRsZUNhc2UgfSBmcm9tICcuL3V0aWxpdGllcyc7XHJcblxyXG5leHBvcnQgY2xhc3MgT2RhdGFRdWVyeUJ1aWxkZXJTZXJ2aWNlIHtcclxuICBfY29sdW1uRmlsdGVyczogYW55O1xyXG4gIF9kZWZhdWx0U29ydEJ5OiBzdHJpbmc7XHJcbiAgX2ZpbHRlckNvdW50OiBudW1iZXI7XHJcbiAgX29kYXRhT3B0aW9uczogUGFydGlhbDxPZGF0YU9wdGlvbj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5fb2RhdGFPcHRpb25zID0ge1xyXG4gICAgICBmaWx0ZXJRdWV1ZTogW10sXHJcbiAgICAgIG9yZGVyQnk6ICcnXHJcbiAgICB9O1xyXG4gICAgdGhpcy5fZGVmYXVsdFNvcnRCeSA9ICcnO1xyXG4gICAgdGhpcy5fY29sdW1uRmlsdGVycyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgICogQnVpbGQgdGhlIE9EYXRhIHF1ZXJ5IHN0cmluZyBmcm9tIGFsbCB0aGUgb3B0aW9ucyBwcm92aWRlZFxyXG4gICAgKiBAcmV0dXJuIHN0cmluZyBPRGF0YSBxdWVyeVxyXG4gICAgKi9cclxuICBidWlsZFF1ZXJ5KCk6IHN0cmluZyB7XHJcbiAgICBpZiAoIXRoaXMuX29kYXRhT3B0aW9ucykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09kYXRhIFNlcnZpY2UgcmVxdWlyZXMgY2VydGFpbiBvcHRpb25zIGxpa2UgXCJ0b3BcIiBmb3IgaXQgdG8gd29yaycpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlclF1ZXVlID0gW107XHJcbiAgICBjb25zdCBxdWVyeVRtcEFycmF5ID0gW107XHJcblxyXG4gICAgLy8gV2hlbiBlbmFibGVDb3VudCBpcyBzZXQsIGFkZCBpdCB0byB0aGUgT0RhdGEgcXVlcnlcclxuICAgIGlmICh0aGlzLl9vZGF0YU9wdGlvbnMuZW5hYmxlQ291bnQgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgY291bnRRdWVyeSA9ICh0aGlzLl9vZGF0YU9wdGlvbnMudmVyc2lvbiA+PSA0KSA/ICckY291bnQ9dHJ1ZScgOiAnJGlubGluZWNvdW50PWFsbHBhZ2VzJztcclxuICAgICAgcXVlcnlUbXBBcnJheS5wdXNoKGNvdW50UXVlcnkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9vZGF0YU9wdGlvbnMudG9wKSB7XHJcbiAgICAgIHF1ZXJ5VG1wQXJyYXkucHVzaChgJHRvcD0ke3RoaXMuX29kYXRhT3B0aW9ucy50b3B9YCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fb2RhdGFPcHRpb25zLnNraXApIHtcclxuICAgICAgcXVlcnlUbXBBcnJheS5wdXNoKGAkc2tpcD0ke3RoaXMuX29kYXRhT3B0aW9ucy5za2lwfWApO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuX29kYXRhT3B0aW9ucy5vcmRlckJ5KSB7XHJcbiAgICAgIGxldCBhcmd1bWVudCA9ICcnO1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLl9vZGF0YU9wdGlvbnMub3JkZXJCeSkpIHtcclxuICAgICAgICBhcmd1bWVudCA9IHRoaXMuX29kYXRhT3B0aW9ucy5vcmRlckJ5LmpvaW4oJywnKTsgLy8gY3N2LCB0aGF0IHdpbGwgZm9ybSBhIHF1ZXJ5LCBmb3IgZXhhbXBsZTogJG9yZGVyYnk9Um9sZU5hbWUgYXNjLCBJZCBkZXNjXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXJndW1lbnQgPSB0aGlzLl9vZGF0YU9wdGlvbnMub3JkZXJCeTtcclxuICAgICAgfVxyXG4gICAgICBxdWVyeVRtcEFycmF5LnB1c2goYCRvcmRlcmJ5PSR7YXJndW1lbnR9YCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlckJ5IHx8IHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXIpIHtcclxuICAgICAgY29uc3QgZmlsdGVyQnkgPSB0aGlzLl9vZGF0YU9wdGlvbnMuZmlsdGVyIHx8IHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJCeTtcclxuICAgICAgaWYgKGZpbHRlckJ5KSB7XHJcbiAgICAgICAgdGhpcy5fZmlsdGVyQ291bnQgPSAxO1xyXG4gICAgICAgIHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJRdWV1ZSA9IFtdO1xyXG4gICAgICAgIGxldCBmaWx0ZXJTdHIgPSBmaWx0ZXJCeTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJCeSkpIHtcclxuICAgICAgICAgIHRoaXMuX2ZpbHRlckNvdW50ID0gZmlsdGVyQnkubGVuZ3RoO1xyXG4gICAgICAgICAgZmlsdGVyU3RyID0gZmlsdGVyQnkuam9pbihgICR7dGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlckJ5U2VwYXJhdG9yIHx8ICdhbmQnfSBgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgZmlsdGVyU3RyID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgaWYgKCEoZmlsdGVyU3RyWzBdID09PSAnKCcgJiYgZmlsdGVyU3RyLnNsaWNlKC0xKSA9PT0gJyknKSkge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFRvRmlsdGVyUXVldWVXaGVuTm90RXhpc3RzKGAoJHtmaWx0ZXJTdHJ9KWApO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbHRlclF1ZXVlV2hlbk5vdEV4aXN0cyhmaWx0ZXJTdHIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJRdWV1ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlclF1ZXVlLmpvaW4oYCAke3RoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJCeVNlcGFyYXRvciB8fCAnYW5kJ30gYCk7XHJcbiAgICAgIHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXIgPSBxdWVyeTsgLy8gb3ZlcndyaXRlIHdpdGhcclxuICAgICAgcXVlcnlUbXBBcnJheS5wdXNoKGAkZmlsdGVyPSR7cXVlcnl9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gam9pbiBhbGwgdGhlIG9kYXRhIGZ1bmN0aW9ucyBieSBhICcmJ1xyXG4gICAgcmV0dXJuIHF1ZXJ5VG1wQXJyYXkuam9pbignJicpO1xyXG4gIH1cclxuXHJcbiAgZ2V0RmlsdGVyQ291bnQoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9maWx0ZXJDb3VudDtcclxuICB9XHJcblxyXG4gIGdldCBjb2x1bW5GaWx0ZXJzKCk6IGFueVtdIHtcclxuICAgIHJldHVybiB0aGlzLl9jb2x1bW5GaWx0ZXJzO1xyXG4gIH1cclxuXHJcbiAgZ2V0IG9wdGlvbnMoKTogUGFydGlhbDxPZGF0YU9wdGlvbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX29kYXRhT3B0aW9ucztcclxuICB9XHJcblxyXG4gIHNldCBvcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8T2RhdGFPcHRpb24+KSB7XHJcbiAgICB0aGlzLl9vZGF0YU9wdGlvbnMgPSBvcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlQ29sdW1uRmlsdGVyKGZpZWxkTmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5fY29sdW1uRmlsdGVycyAmJiB0aGlzLl9jb2x1bW5GaWx0ZXJzLmhhc093blByb3BlcnR5KGZpZWxkTmFtZSkpIHtcclxuICAgICAgZGVsZXRlIHRoaXMuX2NvbHVtbkZpbHRlcnNbZmllbGROYW1lXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNhdmVDb2x1bW5GaWx0ZXIoZmllbGROYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIHNlYXJjaFRlcm1zPzogYW55W10pIHtcclxuICAgIHRoaXMuX2NvbHVtbkZpbHRlcnNbZmllbGROYW1lXSA9IHtcclxuICAgICAgc2VhcmNoOiBzZWFyY2hUZXJtcyxcclxuICAgICAgdmFsdWVcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDaGFuZ2UgYW55IE9EYXRhIG9wdGlvbnMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gYnVpbGQgdGhlIHF1ZXJ5XHJcbiAgICogQHBhcmFtIG9iamVjdCBvcHRpb25zXHJcbiAgICovXHJcbiAgdXBkYXRlT3B0aW9ucyhvcHRpb25zOiBQYXJ0aWFsPE9kYXRhT3B0aW9uPikge1xyXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPYmplY3Qua2V5cyhvcHRpb25zKSkge1xyXG4gICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHtcclxuICAgICAgICB0aGlzLl9vZGF0YU9wdGlvbnNbcHJvcGVydHldID0gb3B0aW9uc1twcm9wZXJ0eV07IC8vIHJlcGxhY2Ugb2YgdGhlIHByb3BlcnR5XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIHdlIG5lZWQgdG8ga2VlcCB0aGUgZGVmYXVsdFNvcnRCeSBmb3IgcmVmZXJlbmNlcyB3aGVuZXZlciB0aGUgdXNlciByZW1vdmVzIGhpcyBTb3J0aW5nXHJcbiAgICAgIC8vIHRoZW4gd2Ugd291bGQgcmV2ZXJ0IHRvIHRoZSBkZWZhdWx0U29ydEJ5IGFuZCB0aGUgb25seSB3YXkgaXMgdG8ga2VlcCBhIGhhcmQgY29weSBoZXJlXHJcbiAgICAgIGlmIChwcm9wZXJ0eSA9PT0gJ29yZGVyQnknIHx8IHByb3BlcnR5ID09PSAnc29ydEJ5Jykge1xyXG4gICAgICAgIGxldCBzb3J0QnkgPSBvcHRpb25zW3Byb3BlcnR5XTtcclxuXHJcbiAgICAgICAgLy8gbWFrZSBzdXJlIGZpcnN0IGNoYXIgb2YgZWFjaCBvcmRlckJ5IGZpZWxkIGlzIGNhcGl0YWxpemVcclxuICAgICAgICBpZiAodGhpcy5fb2RhdGFPcHRpb25zLmNhc2VUeXBlID09PSBDYXNlVHlwZS5wYXNjYWxDYXNlKSB7XHJcbiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzb3J0QnkpKSB7XHJcbiAgICAgICAgICAgIHNvcnRCeS5mb3JFYWNoKChmaWVsZCwgaW5kZXgsIGlucHV0QXJyYXkpID0+IHtcclxuICAgICAgICAgICAgICBpbnB1dEFycmF5W2luZGV4XSA9IHRpdGxlQ2FzZShmaWVsZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc29ydEJ5ID0gdGl0bGVDYXNlKG9wdGlvbnNbcHJvcGVydHldKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fb2RhdGFPcHRpb25zLm9yZGVyQnkgPSBzb3J0Qnk7XHJcbiAgICAgICAgdGhpcy5fZGVmYXVsdFNvcnRCeSA9IHNvcnRCeTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy9cclxuICAvLyBwcml2YXRlIGZ1bmN0aW9uc1xyXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgcHJpdmF0ZSBhZGRUb0ZpbHRlclF1ZXVlV2hlbk5vdEV4aXN0cyhmaWx0ZXJTdHI6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJRdWV1ZSAmJiB0aGlzLl9vZGF0YU9wdGlvbnMuZmlsdGVyUXVldWUuaW5kZXhPZihmaWx0ZXJTdHIpID09PSAtMSkge1xyXG4gICAgICB0aGlzLl9vZGF0YU9wdGlvbnMuZmlsdGVyUXVldWUucHVzaChmaWx0ZXJTdHIpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=