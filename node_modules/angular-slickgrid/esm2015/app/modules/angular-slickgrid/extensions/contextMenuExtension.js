import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { DelimiterType, ExtensionName, FileType, } from '../models/index';
import { ExtensionUtility } from './extensionUtility';
import { SharedService } from '../services/shared.service';
import { ExportService } from '../services/export.service';
import { ExcelExportService } from '../services/excelExport.service';
import { exportWithFormatterWhenDefined } from '../services/export-utilities';
let ContextMenuExtension = class ContextMenuExtension {
    constructor(excelExportService, exportService, extensionUtility, sharedService, translate) {
        this.excelExportService = excelExportService;
        this.exportService = exportService;
        this.extensionUtility = extensionUtility;
        this.sharedService = sharedService;
        this.translate = translate;
        this._eventHandler = new Slick.EventHandler();
    }
    get eventHandler() {
        return this._eventHandler;
    }
    dispose() {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu && this.sharedService.gridOptions.contextMenu.commandItems) {
            this.sharedService.gridOptions.contextMenu = this._userOriginalContextMenu;
        }
    }
    /** Get the instance of the SlickGrid addon (control or plugin). */
    getAddonInstance() {
        return this._addon;
    }
    /**
     * Create the Action Cell Menu and expose all the available hooks that user can subscribe (onCommand, onBeforeMenuShow, ...)
     * @param grid
     * @param dataView
     * @param columnDefinitions
     */
    register() {
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.enableTranslate && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            const contextMenu = this.sharedService.gridOptions.contextMenu;
            // keep original user context menu, useful when switching locale to translate
            this._userOriginalContextMenu = Object.assign({}, contextMenu);
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.contextMenu);
            this.sharedService.gridOptions.contextMenu = Object.assign({}, contextMenu);
            // sort all menu items by their position order when defined
            contextMenu.commandItems = this.addMenuCustomCommands([]);
            this.extensionUtility.sortItems(contextMenu.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(contextMenu.optionItems || [], 'positionOrder');
            this._addon = new Slick.Plugins.ContextMenu(contextMenu);
            this.sharedService.grid.registerPlugin(this._addon);
            // translate the item keys when necessary
            if (this.sharedService.gridOptions.enableTranslate) {
                this.translateContextMenu();
            }
            // hook all events
            if (this.sharedService.grid && contextMenu) {
                if (contextMenu.onExtensionRegistered) {
                    contextMenu.onExtensionRegistered(this._addon);
                }
                if (contextMenu && typeof contextMenu.onCommand === 'function') {
                    this._eventHandler.subscribe(this._addon.onCommand, (event, args) => {
                        contextMenu.onCommand(event, args);
                    });
                }
                if (contextMenu && typeof contextMenu.onOptionSelected === 'function') {
                    this._eventHandler.subscribe(this._addon.onOptionSelected, (event, args) => {
                        contextMenu.onOptionSelected(event, args);
                    });
                }
                if (contextMenu && typeof contextMenu.onBeforeMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuShow, (event, args) => {
                        contextMenu.onBeforeMenuShow(event, args);
                    });
                }
                if (contextMenu && typeof contextMenu.onBeforeMenuClose === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuClose, (event, args) => {
                        contextMenu.onBeforeMenuClose(event, args);
                    });
                }
                if (contextMenu && typeof contextMenu.onAfterMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onAfterMenuShow, (event, args) => {
                        contextMenu.onAfterMenuShow(event, args);
                    });
                }
            }
            return this._addon;
        }
        return null;
    }
    /** Translate the Cell Menu titles, we need to loop through all column definition to re-translate them */
    translateContextMenu() {
        if (this.sharedService && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            const contextMenu = this.sharedService.gridOptions.contextMenu;
            const menuOptions = {};
            if (contextMenu.commandTitleKey) {
                contextMenu.commandTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.commandTitleKey) || contextMenu.commandTitle;
                menuOptions.commandTitle = contextMenu.commandTitle;
            }
            if (contextMenu.optionTitleKey) {
                contextMenu.optionTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.optionTitleKey) || contextMenu.optionTitle;
                menuOptions.optionTitle = contextMenu.optionTitle;
            }
            const originalCommandItems = this._userOriginalContextMenu && Array.isArray(this._userOriginalContextMenu.commandItems) ? this._userOriginalContextMenu.commandItems : [];
            contextMenu.commandItems = [...originalCommandItems, ...this.addMenuCustomCommands(originalCommandItems)];
            menuOptions.commandItems = contextMenu.commandItems; // copy it also to the menuOptions else they won't be translated when locale changes
            // translate all command/options and resort them afterward
            this.extensionUtility.translateItems(contextMenu.commandItems || [], 'titleKey', 'title');
            this.extensionUtility.translateItems(contextMenu.optionItems || [], 'titleKey', 'title');
            this.extensionUtility.sortItems(contextMenu.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(contextMenu.optionItems || [], 'positionOrder');
            // update the title options so that it has latest translated values
            if (this._addon && this._addon.setOptions) {
                this._addon.setOptions(menuOptions);
            }
        }
    }
    // --
    // private functions
    // ------------------
    /** Create Context Menu with Custom Commands (copy cell value, export) */
    addMenuCustomCommands(originalCustomItems) {
        const menuCustomItems = [];
        const gridOptions = this.sharedService && this.sharedService.gridOptions || {};
        const contextMenu = gridOptions && gridOptions.contextMenu;
        const dataView = this.sharedService && this.sharedService.dataView;
        // show context menu: Copy (cell value)
        if (contextMenu && !contextMenu.hideCopyCellValueCommand) {
            const commandName = 'copy';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconCopyCellValueCommand || 'fa fa-clone',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('COPY', 'TEXT_COPY'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 50,
                    action: (e, args) => {
                        this.copyToClipboard(args);
                    },
                    itemUsabilityOverride: (args) => {
                        // make sure there's an item to copy before enabling this command
                        const columnDef = args && args.column;
                        const dataContext = args && args.dataContext;
                        if (columnDef && dataContext.hasOwnProperty(columnDef.field)) {
                            return dataContext[columnDef.field] !== '' && dataContext[columnDef.field] !== null && dataContext[columnDef.field] !== undefined;
                        }
                        return false;
                    }
                });
            }
        }
        // show context menu: Export to file
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportCsvCommand) {
            const commandName = 'export-csv';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportCsvCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPORT_TO_CSV', 'TEXT_EXPORT_TO_CSV'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 51,
                    action: () => this.exportService.exportToFile({
                        delimiter: DelimiterType.comma,
                        filename: 'export',
                        format: FileType.csv,
                        useUtf8WithBom: true,
                    }),
                });
            }
        }
        // show context menu: Export to Excel
        if (gridOptions && gridOptions.enableExcelExport && contextMenu && !contextMenu.hideExportExcelCommand) {
            const commandName = 'export-excel';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportExcelCommand || 'fa fa-file-excel-o text-success',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPORT_TO_EXCEL', 'TEXT_EXPORT_TO_EXCEL'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 52,
                    action: () => this.excelExportService.exportToExcel({
                        filename: 'export',
                        format: FileType.xlsx,
                    }),
                });
            }
        }
        // show context menu: export to text file as tab delimited
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportTextDelimitedCommand) {
            const commandName = 'export-text-delimited';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportTextDelimitedCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPORT_TO_TAB_DELIMITED', 'TEXT_EXPORT_TO_TAB_DELIMITED'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 53,
                    action: () => this.exportService.exportToFile({
                        delimiter: DelimiterType.tab,
                        filename: 'export',
                        format: FileType.txt,
                        useUtf8WithBom: true,
                    }),
                });
            }
        }
        // -- Grouping Commands
        if (gridOptions && (gridOptions.enableGrouping || gridOptions.enableDraggableGrouping)) {
            // add a divider (separator) between the top sort commands and the other clear commands
            menuCustomItems.push({ divider: true, command: '', positionOrder: 54 });
            // show context menu: Clear Grouping
            if (gridOptions && contextMenu && !contextMenu.hideClearAllGrouping) {
                const commandName = 'clear-grouping';
                if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconClearGroupingCommand || 'fa fa-times',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist('CLEAR_ALL_GROUPING', 'TEXT_CLEAR_ALL_GROUPING'),
                        disabled: false,
                        command: commandName,
                        positionOrder: 55,
                        action: () => dataView.setGrouping([]),
                        itemUsabilityOverride: () => {
                            // only enable the command when there's an actually grouping in play
                            const groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Collapse all Groups
            if (gridOptions && contextMenu && !contextMenu.hideCollapseAllGroups) {
                const commandName = 'collapse-all-groups';
                if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconCollapseAllGroupsCommand || 'fa fa-compress',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist('COLLAPSE_ALL_GROUPS', 'TEXT_COLLAPSE_ALL_GROUPS'),
                        disabled: false,
                        command: commandName,
                        positionOrder: 56,
                        action: () => dataView.collapseAllGroups(),
                        itemUsabilityOverride: () => {
                            // only enable the command when there's an actually grouping in play
                            const groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Expand all Groups
            if (gridOptions && contextMenu && !contextMenu.hideExpandAllGroups) {
                const commandName = 'expand-all-groups';
                if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconExpandAllGroupsCommand || 'fa fa-expand',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPAND_ALL_GROUPS', 'TEXT_EXPAND_ALL_GROUPS'),
                        disabled: false,
                        command: commandName,
                        positionOrder: 57,
                        action: () => dataView.expandAllGroups(),
                        itemUsabilityOverride: () => {
                            // only enable the command when there's an actually grouping in play
                            const groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
        }
        return menuCustomItems;
    }
    /**
     * First get the value, if "exportWithFormatter" is set then we'll use the formatter output
     * Then we create the DOM trick to copy a text value by creating a fake <div> that is not shown to the user
     * and from there we can call the execCommand 'copy' command and expect the value to be in clipboard
     * @param args
     */
    copyToClipboard(args) {
        try {
            if (args && args.grid && args.command) {
                // get the value, if "exportWithFormatter" is set then we'll use the formatter output
                const gridOptions = this.sharedService && this.sharedService.gridOptions || {};
                const cell = args && args.cell || 0;
                const row = args && args.row || 0;
                const column = args && args.column;
                const dataContext = args && args.dataContext;
                const grid = this.sharedService && this.sharedService.grid;
                const exportOptions = gridOptions && (gridOptions.excelExportOptions || gridOptions.exportOptions);
                const textToCopy = exportWithFormatterWhenDefined(row, cell, dataContext, column, grid, exportOptions);
                // create fake <div> to copy into clipboard & delete it from the DOM once we're done
                const range = document.createRange();
                const tmpElem = $('<div>').css({ position: 'absolute', left: '-1000px', top: '-1000px' }).text(textToCopy);
                $('body').append(tmpElem);
                range.selectNodeContents(tmpElem.get(0));
                const selection = window.getSelection();
                if (selection && selection.addRange && selection.removeAllRanges) {
                    selection.removeAllRanges();
                    selection.addRange(range);
                    const success = document.execCommand('copy', false, textToCopy);
                    if (success) {
                        tmpElem.remove();
                    }
                }
            }
        }
        catch (e) { }
    }
};
ContextMenuExtension = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(4, Optional()),
    tslib_1.__metadata("design:paramtypes", [ExcelExportService,
        ExportService,
        ExtensionUtility,
        SharedService,
        TranslateService])
], ContextMenuExtension);
export { ContextMenuExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dE1lbnVFeHRlbnNpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2V4dGVuc2lvbnMvY29udGV4dE1lbnVFeHRlbnNpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sRUFHTCxhQUFhLEVBRWIsYUFBYSxFQUNiLFFBQVEsR0FNVCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDckUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFNOUUsSUFBYSxvQkFBb0IsR0FBakMsTUFBYSxvQkFBb0I7SUFLL0IsWUFDVSxrQkFBc0MsRUFDdEMsYUFBNEIsRUFDNUIsZ0JBQWtDLEVBQ2xDLGFBQTRCLEVBQ2hCLFNBQTJCO1FBSnZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUUvQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2hELENBQUM7SUFFRCxJQUFJLFlBQVk7UUFD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RztJQUNqQixDQUFDO0NBQ0YsQ0FBQTtBQS9WWSxvQkFBb0I7SUFEaEMsVUFBVSxFQUFFO0lBV1IsbUJBQUEsUUFBUSxFQUFFLENBQUE7NkNBSmlCLGtCQUFrQjtRQUN2QixhQUFhO1FBQ1YsZ0JBQWdCO1FBQ25CLGFBQWE7UUFDTCxnQkFBZ0I7R0FWdEMsb0JBQW9CLENBK1ZoQztTQS9WWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XHJcblxyXG5pbXBvcnQge1xyXG4gIENvbHVtbixcclxuICBDb250ZXh0TWVudSxcclxuICBEZWxpbWl0ZXJUeXBlLFxyXG4gIEV4dGVuc2lvbixcclxuICBFeHRlbnNpb25OYW1lLFxyXG4gIEZpbGVUeXBlLFxyXG4gIE1lbnVDYWxsYmFja0FyZ3MsXHJcbiAgTWVudUNvbW1hbmRJdGVtLFxyXG4gIE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncyxcclxuICBNZW51T3B0aW9uSXRlbUNhbGxiYWNrQXJncyxcclxuICBTbGlja0V2ZW50SGFuZGxlcixcclxufSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHRlbnNpb25VdGlsaXR5IH0gZnJvbSAnLi9leHRlbnNpb25VdGlsaXR5JztcclxuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3NoYXJlZC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRXhwb3J0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2V4cG9ydC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRXhjZWxFeHBvcnRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZXhjZWxFeHBvcnQuc2VydmljZSc7XHJcbmltcG9ydCB7IGV4cG9ydFdpdGhGb3JtYXR0ZXJXaGVuRGVmaW5lZCB9IGZyb20gJy4uL3NlcnZpY2VzL2V4cG9ydC11dGlsaXRpZXMnO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIHZhciBTbGljazogYW55O1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ29udGV4dE1lbnVFeHRlbnNpb24gaW1wbGVtZW50cyBFeHRlbnNpb24ge1xyXG4gIHByaXZhdGUgX2FkZG9uOiBhbnk7XHJcbiAgcHJpdmF0ZSBfZXZlbnRIYW5kbGVyOiBTbGlja0V2ZW50SGFuZGxlcjtcclxuICBwcml2YXRlIF91c2VyT3JpZ2luYWxDb250ZXh0TWVudTogQ29udGV4dE1lbnU7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBleGNlbEV4cG9ydFNlcnZpY2U6IEV4Y2VsRXhwb3J0U2VydmljZSxcclxuICAgIHByaXZhdGUgZXhwb3J0U2VydmljZTogRXhwb3J0U2VydmljZSxcclxuICAgIHByaXZhdGUgZXh0ZW5zaW9uVXRpbGl0eTogRXh0ZW5zaW9uVXRpbGl0eSxcclxuICAgIHByaXZhdGUgc2hhcmVkU2VydmljZTogU2hhcmVkU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyID0gbmV3IFNsaWNrLkV2ZW50SGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGV2ZW50SGFuZGxlcigpOiBTbGlja0V2ZW50SGFuZGxlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRIYW5kbGVyO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIC8vIHVuc3Vic2NyaWJlIGFsbCBTbGlja0dyaWQgZXZlbnRzXHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIudW5zdWJzY3JpYmVBbGwoKTtcclxuXHJcbiAgICBpZiAodGhpcy5fYWRkb24gJiYgdGhpcy5fYWRkb24uZGVzdHJveSkge1xyXG4gICAgICB0aGlzLl9hZGRvbi5kZXN0cm95KCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zKSB7XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSA9IHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIEdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlIFNsaWNrR3JpZCBhZGRvbiAoY29udHJvbCBvciBwbHVnaW4pLiAqL1xyXG4gIGdldEFkZG9uSW5zdGFuY2UoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGUgdGhlIEFjdGlvbiBDZWxsIE1lbnUgYW5kIGV4cG9zZSBhbGwgdGhlIGF2YWlsYWJsZSBob29rcyB0aGF0IHVzZXIgY2FuIHN1YnNjcmliZSAob25Db21tYW5kLCBvbkJlZm9yZU1lbnVTaG93LCAuLi4pXHJcbiAgICogQHBhcmFtIGdyaWRcclxuICAgKiBAcGFyYW0gZGF0YVZpZXdcclxuICAgKiBAcGFyYW0gY29sdW1uRGVmaW5pdGlvbnNcclxuICAgKi9cclxuICByZWdpc3RlcigpOiBhbnkge1xyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlICYmICghdGhpcy50cmFuc2xhdGUgfHwgIXRoaXMudHJhbnNsYXRlLmluc3RhbnQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0FuZ3VsYXItU2xpY2tncmlkXSByZXF1aXJlcyBcIm5neC10cmFuc2xhdGVcIiB0byBiZSBpbnN0YWxsZWQgYW5kIGNvbmZpZ3VyZWQgd2hlbiB0aGUgZ3JpZCBvcHRpb24gXCJlbmFibGVUcmFuc2xhdGVcIiBpcyBlbmFibGVkLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSkge1xyXG4gICAgICBjb25zdCBjb250ZXh0TWVudSA9IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudTtcclxuXHJcbiAgICAgIC8vIGtlZXAgb3JpZ2luYWwgdXNlciBjb250ZXh0IG1lbnUsIHVzZWZ1bCB3aGVuIHN3aXRjaGluZyBsb2NhbGUgdG8gdHJhbnNsYXRlXHJcbiAgICAgIHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51ID0geyAuLi5jb250ZXh0TWVudSB9O1xyXG5cclxuICAgICAgLy8gZHluYW1pY2FsbHkgaW1wb3J0IHRoZSBTbGlja0dyaWQgcGx1Z2luIChhZGRvbikgd2l0aCBSZXF1aXJlSlNcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LmxvYWRFeHRlbnNpb25EeW5hbWljYWxseShFeHRlbnNpb25OYW1lLmNvbnRleHRNZW51KTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51ID0geyAuLi5jb250ZXh0TWVudSB9O1xyXG5cclxuICAgICAgLy8gc29ydCBhbGwgbWVudSBpdGVtcyBieSB0aGVpciBwb3NpdGlvbiBvcmRlciB3aGVuIGRlZmluZWRcclxuICAgICAgY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zID0gdGhpcy5hZGRNZW51Q3VzdG9tQ29tbWFuZHMoW10pO1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkuc29ydEl0ZW1zKGNvbnRleHRNZW51LmNvbW1hbmRJdGVtcyB8fCBbXSwgJ3Bvc2l0aW9uT3JkZXInKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyhjb250ZXh0TWVudS5vcHRpb25JdGVtcyB8fCBbXSwgJ3Bvc2l0aW9uT3JkZXInKTtcclxuXHJcbiAgICAgIHRoaXMuX2FkZG9uID0gbmV3IFNsaWNrLlBsdWdpbnMuQ29udGV4dE1lbnUoY29udGV4dE1lbnUpO1xyXG4gICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZC5yZWdpc3RlclBsdWdpbih0aGlzLl9hZGRvbik7XHJcblxyXG4gICAgICAvLyB0cmFuc2xhdGUgdGhlIGl0ZW0ga2V5cyB3aGVuIG5lY2Vzc2FyeVxyXG4gICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmVuYWJsZVRyYW5zbGF0ZSkge1xyXG4gICAgICAgIHRoaXMudHJhbnNsYXRlQ29udGV4dE1lbnUoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gaG9vayBhbGwgZXZlbnRzXHJcbiAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiBjb250ZXh0TWVudSkge1xyXG4gICAgICAgIGlmIChjb250ZXh0TWVudS5vbkV4dGVuc2lvblJlZ2lzdGVyZWQpIHtcclxuICAgICAgICAgIGNvbnRleHRNZW51Lm9uRXh0ZW5zaW9uUmVnaXN0ZXJlZCh0aGlzLl9hZGRvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb250ZXh0TWVudSAmJiB0eXBlb2YgY29udGV4dE1lbnUub25Db21tYW5kID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uQ29tbWFuZCwgKGV2ZW50OiBFdmVudCwgYXJnczogTWVudUNvbW1hbmRJdGVtQ2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnRleHRNZW51Lm9uQ29tbWFuZChldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvbnRleHRNZW51ICYmIHR5cGVvZiBjb250ZXh0TWVudS5vbk9wdGlvblNlbGVjdGVkID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uT3B0aW9uU2VsZWN0ZWQsIChldmVudDogRXZlbnQsIGFyZ3M6IE1lbnVPcHRpb25JdGVtQ2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnRleHRNZW51Lm9uT3B0aW9uU2VsZWN0ZWQoZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb250ZXh0TWVudSAmJiB0eXBlb2YgY29udGV4dE1lbnUub25CZWZvcmVNZW51U2hvdyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkJlZm9yZU1lbnVTaG93LCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiB7IGNlbGw6IG51bWJlcjsgcm93OiBudW1iZXI7IGdyaWQ6IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0TWVudS5vbkJlZm9yZU1lbnVTaG93KGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29udGV4dE1lbnUgJiYgdHlwZW9mIGNvbnRleHRNZW51Lm9uQmVmb3JlTWVudUNsb3NlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uQmVmb3JlTWVudUNsb3NlLCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiB7IGNlbGw6IG51bWJlcjsgcm93OiBudW1iZXI7IGdyaWQ6IGFueTsgbWVudTogYW55OyB9KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnRleHRNZW51Lm9uQmVmb3JlTWVudUNsb3NlKGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29udGV4dE1lbnUgJiYgdHlwZW9mIGNvbnRleHRNZW51Lm9uQWZ0ZXJNZW51U2hvdyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkFmdGVyTWVudVNob3csIChldmVudDogRXZlbnQsIGFyZ3M6IHsgY2VsbDogbnVtYmVyOyByb3c6IG51bWJlcjsgZ3JpZDogYW55OyB9KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnRleHRNZW51Lm9uQWZ0ZXJNZW51U2hvdyhldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuX2FkZG9uO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICAvKiogVHJhbnNsYXRlIHRoZSBDZWxsIE1lbnUgdGl0bGVzLCB3ZSBuZWVkIHRvIGxvb3AgdGhyb3VnaCBhbGwgY29sdW1uIGRlZmluaXRpb24gdG8gcmUtdHJhbnNsYXRlIHRoZW0gKi9cclxuICB0cmFuc2xhdGVDb250ZXh0TWVudSgpIHtcclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSkge1xyXG4gICAgICBjb25zdCBjb250ZXh0TWVudSA9IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudTtcclxuICAgICAgY29uc3QgbWVudU9wdGlvbnM6IFBhcnRpYWw8Q29udGV4dE1lbnU+ID0ge307XHJcblxyXG4gICAgICBpZiAoY29udGV4dE1lbnUuY29tbWFuZFRpdGxlS2V5KSB7XHJcbiAgICAgICAgY29udGV4dE1lbnUuY29tbWFuZFRpdGxlID0gdGhpcy50cmFuc2xhdGUgJiYgdGhpcy50cmFuc2xhdGUuY3VycmVudExhbmcgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudCAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZUtleSkgfHwgY29udGV4dE1lbnUuY29tbWFuZFRpdGxlO1xyXG4gICAgICAgIG1lbnVPcHRpb25zLmNvbW1hbmRUaXRsZSA9IGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoY29udGV4dE1lbnUub3B0aW9uVGl0bGVLZXkpIHtcclxuICAgICAgICBjb250ZXh0TWVudS5vcHRpb25UaXRsZSA9IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChjb250ZXh0TWVudS5vcHRpb25UaXRsZUtleSkgfHwgY29udGV4dE1lbnUub3B0aW9uVGl0bGU7XHJcbiAgICAgICAgbWVudU9wdGlvbnMub3B0aW9uVGl0bGUgPSBjb250ZXh0TWVudS5vcHRpb25UaXRsZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBvcmlnaW5hbENvbW1hbmRJdGVtcyA9IHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51ICYmIEFycmF5LmlzQXJyYXkodGhpcy5fdXNlck9yaWdpbmFsQ29udGV4dE1lbnUuY29tbWFuZEl0ZW1zKSA/IHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51LmNvbW1hbmRJdGVtcyA6IFtdO1xyXG4gICAgICBjb250ZXh0TWVudS5jb21tYW5kSXRlbXMgPSBbLi4ub3JpZ2luYWxDb21tYW5kSXRlbXMsIC4uLnRoaXMuYWRkTWVudUN1c3RvbUNvbW1hbmRzKG9yaWdpbmFsQ29tbWFuZEl0ZW1zKV07XHJcbiAgICAgIG1lbnVPcHRpb25zLmNvbW1hbmRJdGVtcyA9IGNvbnRleHRNZW51LmNvbW1hbmRJdGVtczsgLy8gY29weSBpdCBhbHNvIHRvIHRoZSBtZW51T3B0aW9ucyBlbHNlIHRoZXkgd29uJ3QgYmUgdHJhbnNsYXRlZCB3aGVuIGxvY2FsZSBjaGFuZ2VzXHJcblxyXG4gICAgICAvLyB0cmFuc2xhdGUgYWxsIGNvbW1hbmQvb3B0aW9ucyBhbmQgcmVzb3J0IHRoZW0gYWZ0ZXJ3YXJkXHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVJdGVtcyhjb250ZXh0TWVudS5jb21tYW5kSXRlbXMgfHwgW10sICd0aXRsZUtleScsICd0aXRsZScpO1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlSXRlbXMoY29udGV4dE1lbnUub3B0aW9uSXRlbXMgfHwgW10sICd0aXRsZUtleScsICd0aXRsZScpO1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkuc29ydEl0ZW1zKGNvbnRleHRNZW51LmNvbW1hbmRJdGVtcyB8fCBbXSwgJ3Bvc2l0aW9uT3JkZXInKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyhjb250ZXh0TWVudS5vcHRpb25JdGVtcyB8fCBbXSwgJ3Bvc2l0aW9uT3JkZXInKTtcclxuXHJcbiAgICAgIC8vIHVwZGF0ZSB0aGUgdGl0bGUgb3B0aW9ucyBzbyB0aGF0IGl0IGhhcyBsYXRlc3QgdHJhbnNsYXRlZCB2YWx1ZXNcclxuICAgICAgaWYgKHRoaXMuX2FkZG9uICYmIHRoaXMuX2FkZG9uLnNldE9wdGlvbnMpIHtcclxuICAgICAgICB0aGlzLl9hZGRvbi5zZXRPcHRpb25zKG1lbnVPcHRpb25zKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gLS1cclxuICAvLyBwcml2YXRlIGZ1bmN0aW9uc1xyXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxuICAvKiogQ3JlYXRlIENvbnRleHQgTWVudSB3aXRoIEN1c3RvbSBDb21tYW5kcyAoY29weSBjZWxsIHZhbHVlLCBleHBvcnQpICovXHJcbiAgcHJpdmF0ZSBhZGRNZW51Q3VzdG9tQ29tbWFuZHMob3JpZ2luYWxDdXN0b21JdGVtczogQXJyYXk8TWVudUNvbW1hbmRJdGVtIHwgJ2RpdmlkZXInPikge1xyXG4gICAgY29uc3QgbWVudUN1c3RvbUl0ZW1zOiBBcnJheTxNZW51Q29tbWFuZEl0ZW0gfCAnZGl2aWRlcic+ID0gW107XHJcbiAgICBjb25zdCBncmlkT3B0aW9ucyA9IHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgfHwge307XHJcbiAgICBjb25zdCBjb250ZXh0TWVudSA9IGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmNvbnRleHRNZW51O1xyXG4gICAgY29uc3QgZGF0YVZpZXcgPSB0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmRhdGFWaWV3O1xyXG5cclxuICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBDb3B5IChjZWxsIHZhbHVlKVxyXG4gICAgaWYgKGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlQ29weUNlbGxWYWx1ZUNvbW1hbmQpIHtcclxuICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnY29weSc7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25Db3B5Q2VsbFZhbHVlQ29tbWFuZCB8fCAnZmEgZmEtY2xvbmUnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdDT1BZJywgJ1RFWFRfQ09QWScpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MCxcclxuICAgICAgICAgICAgYWN0aW9uOiAoZTogRXZlbnQsIGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuY29weVRvQ2xpcGJvYXJkKGFyZ3MpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBpdGVtVXNhYmlsaXR5T3ZlcnJpZGU6IChhcmdzOiBNZW51Q2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHRoZXJlJ3MgYW4gaXRlbSB0byBjb3B5IGJlZm9yZSBlbmFibGluZyB0aGlzIGNvbW1hbmRcclxuICAgICAgICAgICAgICBjb25zdCBjb2x1bW5EZWYgPSBhcmdzICYmIGFyZ3MuY29sdW1uIGFzIENvbHVtbjtcclxuICAgICAgICAgICAgICBjb25zdCBkYXRhQ29udGV4dCA9IGFyZ3MgJiYgYXJncy5kYXRhQ29udGV4dDtcclxuICAgICAgICAgICAgICBpZiAoY29sdW1uRGVmICYmIGRhdGFDb250ZXh0Lmhhc093blByb3BlcnR5KGNvbHVtbkRlZi5maWVsZCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhQ29udGV4dFtjb2x1bW5EZWYuZmllbGRdICE9PSAnJyAmJiBkYXRhQ29udGV4dFtjb2x1bW5EZWYuZmllbGRdICE9PSBudWxsICYmIGRhdGFDb250ZXh0W2NvbHVtbkRlZi5maWVsZF0gIT09IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBFeHBvcnQgdG8gZmlsZVxyXG4gICAgaWYgKGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmVuYWJsZUV4cG9ydCAmJiBjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUV4cG9ydENzdkNvbW1hbmQpIHtcclxuICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnZXhwb3J0LWNzdic7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25FeHBvcnRDc3ZDb21tYW5kIHx8ICdmYSBmYS1kb3dubG9hZCcsXHJcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoJ0VYUE9SVF9UT19DU1YnLCAnVEVYVF9FWFBPUlRfVE9fQ1NWJyksXHJcbiAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDUxLFxyXG4gICAgICAgICAgICBhY3Rpb246ICgpID0+IHRoaXMuZXhwb3J0U2VydmljZS5leHBvcnRUb0ZpbGUoe1xyXG4gICAgICAgICAgICAgIGRlbGltaXRlcjogRGVsaW1pdGVyVHlwZS5jb21tYSxcclxuICAgICAgICAgICAgICBmaWxlbmFtZTogJ2V4cG9ydCcsXHJcbiAgICAgICAgICAgICAgZm9ybWF0OiBGaWxlVHlwZS5jc3YsXHJcbiAgICAgICAgICAgICAgdXNlVXRmOFdpdGhCb206IHRydWUsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogRXhwb3J0IHRvIEV4Y2VsXHJcbiAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgZ3JpZE9wdGlvbnMuZW5hYmxlRXhjZWxFeHBvcnQgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVFeHBvcnRFeGNlbENvbW1hbmQpIHtcclxuICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnZXhwb3J0LWV4Y2VsJztcclxuICAgICAgaWYgKCFvcmlnaW5hbEN1c3RvbUl0ZW1zLmZpbmQoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIGljb25Dc3NDbGFzczogY29udGV4dE1lbnUuaWNvbkV4cG9ydEV4Y2VsQ29tbWFuZCB8fCAnZmEgZmEtZmlsZS1leGNlbC1vIHRleHQtc3VjY2VzcycsXHJcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoJ0VYUE9SVF9UT19FWENFTCcsICdURVhUX0VYUE9SVF9UT19FWENFTCcpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MixcclxuICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmV4Y2VsRXhwb3J0U2VydmljZS5leHBvcnRUb0V4Y2VsKHtcclxuICAgICAgICAgICAgICBmaWxlbmFtZTogJ2V4cG9ydCcsXHJcbiAgICAgICAgICAgICAgZm9ybWF0OiBGaWxlVHlwZS54bHN4LFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IGV4cG9ydCB0byB0ZXh0IGZpbGUgYXMgdGFiIGRlbGltaXRlZFxyXG4gICAgaWYgKGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmVuYWJsZUV4cG9ydCAmJiBjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUV4cG9ydFRleHREZWxpbWl0ZWRDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cG9ydC10ZXh0LWRlbGltaXRlZCc7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25FeHBvcnRUZXh0RGVsaW1pdGVkQ29tbWFuZCB8fCAnZmEgZmEtZG93bmxvYWQnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdFWFBPUlRfVE9fVEFCX0RFTElNSVRFRCcsICdURVhUX0VYUE9SVF9UT19UQUJfREVMSU1JVEVEJyksXHJcbiAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDUzLFxyXG4gICAgICAgICAgICBhY3Rpb246ICgpID0+IHRoaXMuZXhwb3J0U2VydmljZS5leHBvcnRUb0ZpbGUoe1xyXG4gICAgICAgICAgICAgIGRlbGltaXRlcjogRGVsaW1pdGVyVHlwZS50YWIsXHJcbiAgICAgICAgICAgICAgZmlsZW5hbWU6ICdleHBvcnQnLFxyXG4gICAgICAgICAgICAgIGZvcm1hdDogRmlsZVR5cGUudHh0LFxyXG4gICAgICAgICAgICAgIHVzZVV0ZjhXaXRoQm9tOiB0cnVlLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gLS0gR3JvdXBpbmcgQ29tbWFuZHNcclxuICAgIGlmIChncmlkT3B0aW9ucyAmJiAoZ3JpZE9wdGlvbnMuZW5hYmxlR3JvdXBpbmcgfHwgZ3JpZE9wdGlvbnMuZW5hYmxlRHJhZ2dhYmxlR3JvdXBpbmcpKSB7XHJcbiAgICAgIC8vIGFkZCBhIGRpdmlkZXIgKHNlcGFyYXRvcikgYmV0d2VlbiB0aGUgdG9wIHNvcnQgY29tbWFuZHMgYW5kIHRoZSBvdGhlciBjbGVhciBjb21tYW5kc1xyXG4gICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaCh7IGRpdmlkZXI6IHRydWUsIGNvbW1hbmQ6ICcnLCBwb3NpdGlvbk9yZGVyOiA1NCB9KTtcclxuXHJcbiAgICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBDbGVhciBHcm91cGluZ1xyXG4gICAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVDbGVhckFsbEdyb3VwaW5nKSB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnY2xlYXItZ3JvdXBpbmcnO1xyXG4gICAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25DbGVhckdyb3VwaW5nQ29tbWFuZCB8fCAnZmEgZmEtdGltZXMnLFxyXG4gICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoJ0NMRUFSX0FMTF9HUk9VUElORycsICdURVhUX0NMRUFSX0FMTF9HUk9VUElORycpLFxyXG4gICAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NSxcclxuICAgICAgICAgICAgICBhY3Rpb246ICgpID0+IGRhdGFWaWV3LnNldEdyb3VwaW5nKFtdKSxcclxuICAgICAgICAgICAgICBpdGVtVXNhYmlsaXR5T3ZlcnJpZGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIG9ubHkgZW5hYmxlIHRoZSBjb21tYW5kIHdoZW4gdGhlcmUncyBhbiBhY3R1YWxseSBncm91cGluZyBpbiBwbGF5XHJcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cGluZ0FycmF5ID0gZGF0YVZpZXcgJiYgZGF0YVZpZXcuZ2V0R3JvdXBpbmcgJiYgZGF0YVZpZXcuZ2V0R3JvdXBpbmcoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGdyb3VwaW5nQXJyYXkpICYmIGdyb3VwaW5nQXJyYXkubGVuZ3RoID4gMDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBzaG93IGNvbnRleHQgbWVudTogQ29sbGFwc2UgYWxsIEdyb3Vwc1xyXG4gICAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVDb2xsYXBzZUFsbEdyb3Vwcykge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2NvbGxhcHNlLWFsbC1ncm91cHMnO1xyXG4gICAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25Db2xsYXBzZUFsbEdyb3Vwc0NvbW1hbmQgfHwgJ2ZhIGZhLWNvbXByZXNzJyxcclxuICAgICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdDT0xMQVBTRV9BTExfR1JPVVBTJywgJ1RFWFRfQ09MTEFQU0VfQUxMX0dST1VQUycpLFxyXG4gICAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NixcclxuICAgICAgICAgICAgICBhY3Rpb246ICgpID0+IGRhdGFWaWV3LmNvbGxhcHNlQWxsR3JvdXBzKCksXHJcbiAgICAgICAgICAgICAgaXRlbVVzYWJpbGl0eU92ZXJyaWRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBvbmx5IGVuYWJsZSB0aGUgY29tbWFuZCB3aGVuIHRoZXJlJ3MgYW4gYWN0dWFsbHkgZ3JvdXBpbmcgaW4gcGxheVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBpbmdBcnJheSA9IGRhdGFWaWV3ICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShncm91cGluZ0FycmF5KSAmJiBncm91cGluZ0FycmF5Lmxlbmd0aCA+IDA7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IEV4cGFuZCBhbGwgR3JvdXBzXHJcbiAgICAgIGlmIChncmlkT3B0aW9ucyAmJiBjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUV4cGFuZEFsbEdyb3Vwcykge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cGFuZC1hbGwtZ3JvdXBzJztcclxuICAgICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uRXhwYW5kQWxsR3JvdXBzQ29tbWFuZCB8fCAnZmEgZmEtZXhwYW5kJyxcclxuICAgICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdFWFBBTkRfQUxMX0dST1VQUycsICdURVhUX0VYUEFORF9BTExfR1JPVVBTJyksXHJcbiAgICAgICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDU3LFxyXG4gICAgICAgICAgICAgIGFjdGlvbjogKCkgPT4gZGF0YVZpZXcuZXhwYW5kQWxsR3JvdXBzKCksXHJcbiAgICAgICAgICAgICAgaXRlbVVzYWJpbGl0eU92ZXJyaWRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBvbmx5IGVuYWJsZSB0aGUgY29tbWFuZCB3aGVuIHRoZXJlJ3MgYW4gYWN0dWFsbHkgZ3JvdXBpbmcgaW4gcGxheVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBpbmdBcnJheSA9IGRhdGFWaWV3ICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShncm91cGluZ0FycmF5KSAmJiBncm91cGluZ0FycmF5Lmxlbmd0aCA+IDA7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtZW51Q3VzdG9tSXRlbXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGaXJzdCBnZXQgdGhlIHZhbHVlLCBpZiBcImV4cG9ydFdpdGhGb3JtYXR0ZXJcIiBpcyBzZXQgdGhlbiB3ZSdsbCB1c2UgdGhlIGZvcm1hdHRlciBvdXRwdXRcclxuICAgKiBUaGVuIHdlIGNyZWF0ZSB0aGUgRE9NIHRyaWNrIHRvIGNvcHkgYSB0ZXh0IHZhbHVlIGJ5IGNyZWF0aW5nIGEgZmFrZSA8ZGl2PiB0aGF0IGlzIG5vdCBzaG93biB0byB0aGUgdXNlclxyXG4gICAqIGFuZCBmcm9tIHRoZXJlIHdlIGNhbiBjYWxsIHRoZSBleGVjQ29tbWFuZCAnY29weScgY29tbWFuZCBhbmQgZXhwZWN0IHRoZSB2YWx1ZSB0byBiZSBpbiBjbGlwYm9hcmRcclxuICAgKiBAcGFyYW0gYXJnc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY29weVRvQ2xpcGJvYXJkKGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGFyZ3MgJiYgYXJncy5ncmlkICYmIGFyZ3MuY29tbWFuZCkge1xyXG4gICAgICAgIC8vIGdldCB0aGUgdmFsdWUsIGlmIFwiZXhwb3J0V2l0aEZvcm1hdHRlclwiIGlzIHNldCB0aGVuIHdlJ2xsIHVzZSB0aGUgZm9ybWF0dGVyIG91dHB1dFxyXG4gICAgICAgIGNvbnN0IGdyaWRPcHRpb25zID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyB8fCB7fTtcclxuICAgICAgICBjb25zdCBjZWxsID0gYXJncyAmJiBhcmdzLmNlbGwgfHwgMDtcclxuICAgICAgICBjb25zdCByb3cgPSBhcmdzICYmIGFyZ3Mucm93IHx8IDA7XHJcbiAgICAgICAgY29uc3QgY29sdW1uID0gYXJncyAmJiBhcmdzLmNvbHVtbjtcclxuICAgICAgICBjb25zdCBkYXRhQ29udGV4dCA9IGFyZ3MgJiYgYXJncy5kYXRhQ29udGV4dDtcclxuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkO1xyXG4gICAgICAgIGNvbnN0IGV4cG9ydE9wdGlvbnMgPSBncmlkT3B0aW9ucyAmJiAoZ3JpZE9wdGlvbnMuZXhjZWxFeHBvcnRPcHRpb25zIHx8IGdyaWRPcHRpb25zLmV4cG9ydE9wdGlvbnMpO1xyXG4gICAgICAgIGNvbnN0IHRleHRUb0NvcHkgPSBleHBvcnRXaXRoRm9ybWF0dGVyV2hlbkRlZmluZWQocm93LCBjZWxsLCBkYXRhQ29udGV4dCwgY29sdW1uLCBncmlkLCBleHBvcnRPcHRpb25zKTtcclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIGZha2UgPGRpdj4gdG8gY29weSBpbnRvIGNsaXBib2FyZCAmIGRlbGV0ZSBpdCBmcm9tIHRoZSBET00gb25jZSB3ZSdyZSBkb25lXHJcbiAgICAgICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xyXG4gICAgICAgIGNvbnN0IHRtcEVsZW0gPSAkKCc8ZGl2PicpLmNzcyh7IHBvc2l0aW9uOiAnYWJzb2x1dGUnLCBsZWZ0OiAnLTEwMDBweCcsIHRvcDogJy0xMDAwcHgnIH0pLnRleHQodGV4dFRvQ29weSk7XHJcbiAgICAgICAgJCgnYm9keScpLmFwcGVuZCh0bXBFbGVtKTtcclxuICAgICAgICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHModG1wRWxlbS5nZXQoMCkpO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcclxuICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHNlbGVjdGlvbi5hZGRSYW5nZSAmJiBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKSB7XHJcbiAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpO1xyXG4gICAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5JywgZmFsc2UsIHRleHRUb0NvcHkpO1xyXG4gICAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcclxuICAgICAgICAgICAgdG1wRWxlbS5yZW1vdmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGUpIHsgfVxyXG4gIH1cclxufVxyXG4iXX0=