import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { FilterMultiplePassType, FieldType, OperatorType, SortDirectionNumber, } from './../models/index';
import { sortByFieldType } from '../sorters/sorterUtilities';
import { uniqueArray } from './utilities';
var CollectionService = /** @class */ (function () {
    function CollectionService(translate) {
        this.translate = translate;
    }
    /**
     * Filter 1 or more items from a collection
     * @param collection
     * @param filterByOptions
     */
    CollectionService.prototype.filterCollection = function (collection, filterByOptions, filterResultBy) {
        if (filterResultBy === void 0) { filterResultBy = FilterMultiplePassType.chain; }
        var e_1, _a;
        var filteredCollection = [];
        // when it's array, we will use the new filtered collection after every pass
        // basically if input collection has 10 items on 1st pass and 1 item is filtered out, then on 2nd pass the input collection will be 9 items
        if (Array.isArray(filterByOptions)) {
            filteredCollection = (filterResultBy === FilterMultiplePassType.merge) ? [] : collection;
            try {
                for (var filterByOptions_1 = tslib_1.__values(filterByOptions), filterByOptions_1_1 = filterByOptions_1.next(); !filterByOptions_1_1.done; filterByOptions_1_1 = filterByOptions_1.next()) {
                    var filter = filterByOptions_1_1.value;
                    if (filterResultBy === FilterMultiplePassType.merge) {
                        var filteredPass = this.singleFilterCollection(collection, filter);
                        filteredCollection = uniqueArray(tslib_1.__spread(filteredCollection, filteredPass));
                    }
                    else {
                        filteredCollection = this.singleFilterCollection(filteredCollection, filter);
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (filterByOptions_1_1 && !filterByOptions_1_1.done && (_a = filterByOptions_1.return)) _a.call(filterByOptions_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        else {
            filteredCollection = this.singleFilterCollection(collection, filterByOptions);
        }
        return filteredCollection;
    };
    /**
     * Filter an item from a collection
     * @param collection
     * @param filterBy
     */
    CollectionService.prototype.singleFilterCollection = function (collection, filterBy) {
        var filteredCollection = [];
        if (filterBy) {
            var objectProperty_1 = filterBy.property;
            var operator = filterBy.operator || OperatorType.equal;
            // just check for undefined since the filter value could be null, 0, '', false etc
            var value_1 = typeof filterBy.value === 'undefined' ? '' : filterBy.value;
            switch (operator) {
                case OperatorType.equal:
                    if (objectProperty_1) {
                        filteredCollection = collection.filter(function (item) { return item[objectProperty_1] === value_1; });
                    }
                    else {
                        filteredCollection = collection.filter(function (item) { return item === value_1; });
                    }
                    break;
                case OperatorType.contains:
                    if (objectProperty_1) {
                        filteredCollection = collection.filter(function (item) { return item[objectProperty_1].toString().indexOf(value_1.toString()) !== -1; });
                    }
                    else {
                        filteredCollection = collection.filter(function (item) { return (item !== null && item !== undefined) && item.toString().indexOf(value_1.toString()) !== -1; });
                    }
                    break;
                case OperatorType.notContains:
                    if (objectProperty_1) {
                        filteredCollection = collection.filter(function (item) { return item[objectProperty_1].toString().indexOf(value_1.toString()) === -1; });
                    }
                    else {
                        filteredCollection = collection.filter(function (item) { return (item !== null && item !== undefined) && item.toString().indexOf(value_1.toString()) === -1; });
                    }
                    break;
                case OperatorType.notEqual:
                default:
                    if (objectProperty_1) {
                        filteredCollection = collection.filter(function (item) { return item[objectProperty_1] !== value_1; });
                    }
                    else {
                        filteredCollection = collection.filter(function (item) { return item !== value_1; });
                    }
            }
        }
        return filteredCollection;
    };
    /**
     * Sort 1 or more items in a collection
     * @param column definition
     * @param collection
     * @param sortByOptions
     * @param enableTranslateLabel
     */
    CollectionService.prototype.sortCollection = function (columnDef, collection, sortByOptions, enableTranslateLabel) {
        var _this = this;
        if (enableTranslateLabel && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        var sortedCollection = [];
        if (sortByOptions) {
            if (Array.isArray(sortByOptions)) {
                // multi-sort
                sortedCollection = collection.sort(function (dataRow1, dataRow2) {
                    for (var i = 0, l = sortByOptions.length; i < l; i++) {
                        var sortBy = sortByOptions[i];
                        if (sortBy && sortBy.property) {
                            // collection of objects with a property name provided
                            var sortDirection = sortBy.sortDesc ? SortDirectionNumber.desc : SortDirectionNumber.asc;
                            var objectProperty = sortBy.property;
                            var fieldType = sortBy.fieldType || FieldType.string;
                            var value1 = (enableTranslateLabel) ? _this.translate && _this.translate.currentLang && _this.translate.instant(dataRow1[objectProperty] || ' ') : dataRow1[objectProperty];
                            var value2 = (enableTranslateLabel) ? _this.translate && _this.translate.currentLang && _this.translate.instant(dataRow2[objectProperty] || ' ') : dataRow2[objectProperty];
                            var sortResult = sortByFieldType(fieldType, value1, value2, sortDirection, columnDef);
                            if (sortResult !== SortDirectionNumber.neutral) {
                                return sortResult;
                            }
                        }
                    }
                    return SortDirectionNumber.neutral;
                });
            }
            else if (sortByOptions && sortByOptions.property) {
                // single sort
                // collection of objects with a property name provided
                var objectProperty_2 = sortByOptions.property;
                var sortDirection_1 = sortByOptions.sortDesc ? SortDirectionNumber.desc : SortDirectionNumber.asc;
                var fieldType_1 = sortByOptions.fieldType || FieldType.string;
                if (objectProperty_2) {
                    sortedCollection = collection.sort(function (dataRow1, dataRow2) {
                        var value1 = (enableTranslateLabel) ? _this.translate && _this.translate.currentLang && _this.translate.instant(dataRow1[objectProperty_2] || ' ') : dataRow1[objectProperty_2];
                        var value2 = (enableTranslateLabel) ? _this.translate && _this.translate.currentLang && _this.translate.instant(dataRow2[objectProperty_2] || ' ') : dataRow2[objectProperty_2];
                        var sortResult = sortByFieldType(fieldType_1, value1, value2, sortDirection_1, columnDef);
                        if (sortResult !== SortDirectionNumber.neutral) {
                            return sortResult;
                        }
                        return SortDirectionNumber.neutral;
                    });
                }
            }
            else if (sortByOptions && !sortByOptions.property) {
                var sortDirection_2 = sortByOptions.sortDesc ? SortDirectionNumber.desc : SortDirectionNumber.asc;
                var fieldType_2 = sortByOptions.fieldType || FieldType.string;
                sortedCollection = collection.sort(function (dataRow1, dataRow2) {
                    var value1 = (enableTranslateLabel) ? _this.translate && _this.translate.currentLang && _this.translate.instant(dataRow1 || ' ') : dataRow1;
                    var value2 = (enableTranslateLabel) ? _this.translate && _this.translate.currentLang && _this.translate.instant(dataRow2 || ' ') : dataRow2;
                    var sortResult = sortByFieldType(fieldType_2, value1, value2, sortDirection_2, columnDef);
                    if (sortResult !== SortDirectionNumber.neutral) {
                        return sortResult;
                    }
                    return SortDirectionNumber.neutral;
                });
            }
        }
        return sortedCollection;
    };
    CollectionService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Optional()),
        tslib_1.__metadata("design:paramtypes", [TranslateService])
    ], CollectionService);
    return CollectionService;
}());
export { CollectionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9jb2xsZWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFJTCxzQkFBc0IsRUFFdEIsU0FBUyxFQUNULFlBQVksRUFDWixtQkFBbUIsR0FDcEIsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUcxQztJQUNFLDJCQUFnQyxTQUEyQjtRQUEzQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtJQUFJLENBQUM7SUFFaEU7Ozs7T0FJRztJQUNILDRDQUFnQixHQUFoQixVQUFpQixVQUFpQixFQUFFLGVBQTBELEVBQUUsY0FBMkc7UUFBM0csK0JBQUEsRUFBQSxpQkFBK0Usc0JBQXNCLENBQUMsS0FBSzs7UUFDek0sSUFBSSxrQkFBa0IsR0FBVSxFQUFFLENBQUM7UUFFbkMsNEVBQTRFO1FBQzVFLDJJQUEySTtRQUMzSSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDbEMsa0JBQWtCLEdBQUcsQ0FBQyxjQUFjLEtBQUssc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDOztnQkFFekYsS0FBcUIsSUFBQSxvQkFBQSxpQkFBQSxlQUFlLENBQUEsZ0RBQUEsNkVBQUU7b0JBQWpDLElBQU0sTUFBTSw0QkFBQTtvQkFDZixJQUFJ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LEVBQUUsTUFBTSxFQUFFLGVBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDeEYsSUFBSSxVQUFVLEtBQUssbUJBQW1CLENBQUMsT0FBTyxFQUFFO3dCQUM5QyxPQUFPLFVBQVUsQ0FBQztxQkFDbkI7b0JBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7Z0JBQ3JDLENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUVELE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQXhKVSxpQkFBaUI7UUFEN0IsVUFBVSxFQUFFO1FBRUUsbUJBQUEsUUFBUSxFQUFFLENBQUE7aURBQW9CLGdCQUFnQjtPQURoRCxpQkFBaUIsQ0F5SjdCO0lBQUQsd0JBQUM7Q0FBQSxBQXpKRCxJQXlKQztTQXpKWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgQ29sbGVjdGlvbkZpbHRlckJ5LFxyXG4gIENvbGxlY3Rpb25Tb3J0QnksXHJcbiAgQ29sdW1uLFxyXG4gIEZpbHRlck11bHRpcGxlUGFzc1R5cGUsXHJcbiAgRmlsdGVyTXVsdGlwbGVQYXNzVHlwZVN0cmluZyxcclxuICBGaWVsZFR5cGUsXHJcbiAgT3BlcmF0b3JUeXBlLFxyXG4gIFNvcnREaXJlY3Rpb25OdW1iZXIsXHJcbn0gZnJvbSAnLi8uLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBzb3J0QnlGaWVsZFR5cGUgfSBmcm9tICcuLi9zb3J0ZXJzL3NvcnRlclV0aWxpdGllcyc7XHJcbmltcG9ydCB7IHVuaXF1ZUFycmF5IH0gZnJvbSAnLi91dGlsaXRpZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvblNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7IH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlsdGVyIDEgb3IgbW9yZSBpdGVtcyBmcm9tIGEgY29sbGVjdGlvblxyXG4gICAqIEBwYXJhbSBjb2xsZWN0aW9uXHJcbiAgICogQHBhcmFtIGZpbHRlckJ5T3B0aW9uc1xyXG4gICAqL1xyXG4gIGZpbHRlckNvbGxlY3Rpb24oY29sbGVjdGlvbjogYW55W10sIGZpbHRlckJ5T3B0aW9uczogQ29sbGVjdGlvbkZpbHRlckJ5IHwgQ29sbGVjdGlvbkZpbHRlckJ5W10sIGZpbHRlclJlc3VsdEJ5OiBGaWx0ZXJNdWx0aXBsZVBhc3NUeXBlIHwgRmlsdGVyTXVsdGlwbGVQYXNzVHlwZVN0cmluZyB8IG51bGwgPSBGaWx0ZXJNdWx0aXBsZVBhc3NUeXBlLmNoYWluKTogYW55W10ge1xyXG4gICAgbGV0IGZpbHRlcmVkQ29sbGVjdGlvbjogYW55W10gPSBbXTtcclxuXHJcbiAgICAvLyB3aGVuIGl0J3MgYXJyYXksIHdlIHdpbGwgdXNlIHRoZSBuZXcgZmlsdGVyZWQgY29sbGVjdGlvbiBhZnRlciBldmVyeSBwYXNzXHJcbiAgICAvLyBiYXNpY2FsbHkgaWYgaW5wdXQgY29sbGVjdGlvbiBoYXMgMTAgaXRlbXMgb24gMXN0IHBhc3MgYW5kIDEgaXRlbSBpcyBmaWx0ZXJlZCBvdXQsIHRoZW4gb24gMm5kIHBhc3MgdGhlIGlucHV0IGNvbGxlY3Rpb24gd2lsbCBiZSA5IGl0ZW1zXHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJCeU9wdGlvbnMpKSB7XHJcbiAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IChmaWx0ZXJSZXN1bHRCeSA9PT0gRmlsdGVyTXVsdGlwbGVQYXNzVHlwZS5tZXJnZSkgPyBbXSA6IGNvbGxlY3Rpb247XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IGZpbHRlciBvZiBmaWx0ZXJCeU9wdGlvbnMpIHtcclxuICAgICAgICBpZiAoZmlsdGVyUmVzdWx0QnkgPT09IEZpbHRlck11bHRpcGxlUGFzc1R5cGUubWVyZ2UpIHtcclxuICAgICAgICAgIGNvbnN0IGZpbHRlcmVkUGFzcyA9IHRoaXMuc2luZ2xlRmlsdGVyQ29sbGVjdGlvbihjb2xsZWN0aW9uLCBmaWx0ZXIpO1xyXG4gICAgICAgICAgZmlsdGVyZWRDb2xsZWN0aW9uID0gdW5pcXVlQXJyYXkoWy4uLmZpbHRlcmVkQ29sbGVjdGlvbiwgLi4uZmlsdGVyZWRQYXNzXSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IHRoaXMuc2luZ2xlRmlsdGVyQ29sbGVjdGlvbihmaWx0ZXJlZENvbGxlY3Rpb24sIGZpbHRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmaWx0ZXJlZENvbGxlY3Rpb24gPSB0aGlzLnNpbmdsZUZpbHRlckNvbGxlY3Rpb24oY29sbGVjdGlvbiwgZmlsdGVyQnlPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmlsdGVyZWRDb2xsZWN0aW9uO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlsdGVyIGFuIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb25cclxuICAgKiBAcGFyYW0gY29sbGVjdGlvblxyXG4gICAqIEBwYXJhbSBmaWx0ZXJCeVxyXG4gICAqL1xyXG4gIHNpbmdsZUZpbHRlckNvbGxlY3Rpb24oY29sbGVjdGlvbjogYW55W10sIGZpbHRlckJ5OiBDb2xsZWN0aW9uRmlsdGVyQnkpOiBhbnlbXSB7XHJcbiAgICBsZXQgZmlsdGVyZWRDb2xsZWN0aW9uOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIGlmIChmaWx0ZXJCeSkge1xyXG4gICAgICBjb25zdCBvYmplY3RQcm9wZXJ0eSA9IGZpbHRlckJ5LnByb3BlcnR5O1xyXG4gICAgICBjb25zdCBvcGVyYXRvciA9IGZpbHRlckJ5Lm9wZXJhdG9yIHx8IE9wZXJhdG9yVHlwZS5lcXVhbDtcclxuICAgICAgLy8ganVzdCBjaGVjayBmb3IgdW5kZWZpbmVkIHNpbmNlIHRoZSBmaWx0ZXIgdmFsdWUgY291bGQgYmUgbnVsbCwgMCwgJycsIGZhbHNlIGV0Y1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IHR5cGVvZiBmaWx0ZXJCeS52YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgPyAnJyA6IGZpbHRlckJ5LnZhbHVlO1xyXG5cclxuICAgICAgc3dpdGNoIChvcGVyYXRvcikge1xyXG4gICAgICAgIGNhc2UgT3BlcmF0b3JUeXBlLmVxdWFsOlxyXG4gICAgICAgICAgaWYgKG9iamVjdFByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiBpdGVtW29iamVjdFByb3BlcnR5XSA9PT0gdmFsdWUpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZmlsdGVyZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0gPT09IHZhbHVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgT3BlcmF0b3JUeXBlLmNvbnRhaW5zOlxyXG4gICAgICAgICAgaWYgKG9iamVjdFByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiBpdGVtW29iamVjdFByb3BlcnR5XS50b1N0cmluZygpLmluZGV4T2YodmFsdWUudG9TdHJpbmcoKSkgIT09IC0xKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiAoaXRlbSAhPT0gbnVsbCAmJiBpdGVtICE9PSB1bmRlZmluZWQpICYmIGl0ZW0udG9TdHJpbmcoKS5pbmRleE9mKHZhbHVlLnRvU3RyaW5nKCkpICE9PSAtMSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIE9wZXJhdG9yVHlwZS5ub3RDb250YWluczpcclxuICAgICAgICAgIGlmIChvYmplY3RQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICBmaWx0ZXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmZpbHRlcigoaXRlbSkgPT4gaXRlbVtvYmplY3RQcm9wZXJ0eV0udG9TdHJpbmcoKS5pbmRleE9mKHZhbHVlLnRvU3RyaW5nKCkpID09PSAtMSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmaWx0ZXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmZpbHRlcigoaXRlbSkgPT4gKGl0ZW0gIT09IG51bGwgJiYgaXRlbSAhPT0gdW5kZWZpbmVkKSAmJiBpdGVtLnRvU3RyaW5nKCkuaW5kZXhPZih2YWx1ZS50b1N0cmluZygpKSA9PT0gLTEpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBPcGVyYXRvclR5cGUubm90RXF1YWw6XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIGlmIChvYmplY3RQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICBmaWx0ZXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmZpbHRlcigoaXRlbSkgPT4gaXRlbVtvYmplY3RQcm9wZXJ0eV0gIT09IHZhbHVlKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiBpdGVtICE9PSB2YWx1ZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmlsdGVyZWRDb2xsZWN0aW9uO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU29ydCAxIG9yIG1vcmUgaXRlbXMgaW4gYSBjb2xsZWN0aW9uXHJcbiAgICogQHBhcmFtIGNvbHVtbiBkZWZpbml0aW9uXHJcbiAgICogQHBhcmFtIGNvbGxlY3Rpb25cclxuICAgKiBAcGFyYW0gc29ydEJ5T3B0aW9uc1xyXG4gICAqIEBwYXJhbSBlbmFibGVUcmFuc2xhdGVMYWJlbFxyXG4gICAqL1xyXG4gIHNvcnRDb2xsZWN0aW9uKGNvbHVtbkRlZjogQ29sdW1uLCBjb2xsZWN0aW9uOiBhbnlbXSwgc29ydEJ5T3B0aW9uczogQ29sbGVjdGlvblNvcnRCeSB8IENvbGxlY3Rpb25Tb3J0QnlbXSwgZW5hYmxlVHJhbnNsYXRlTGFiZWw/OiBib29sZWFuKTogYW55W10ge1xyXG4gICAgaWYgKGVuYWJsZVRyYW5zbGF0ZUxhYmVsICYmICghdGhpcy50cmFuc2xhdGUgfHwgIXRoaXMudHJhbnNsYXRlLmluc3RhbnQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0FuZ3VsYXItU2xpY2tncmlkXSByZXF1aXJlcyBcIm5neC10cmFuc2xhdGVcIiB0byBiZSBpbnN0YWxsZWQgYW5kIGNvbmZpZ3VyZWQgd2hlbiB0aGUgZ3JpZCBvcHRpb24gXCJlbmFibGVUcmFuc2xhdGVcIiBpcyBlbmFibGVkLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzb3J0ZWRDb2xsZWN0aW9uOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIGlmIChzb3J0QnlPcHRpb25zKSB7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHNvcnRCeU9wdGlvbnMpKSB7XHJcbiAgICAgICAgLy8gbXVsdGktc29ydFxyXG4gICAgICAgIHNvcnRlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLnNvcnQoKGRhdGFSb3cxOiBhbnksIGRhdGFSb3cyOiBhbnkpID0+IHtcclxuICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gc29ydEJ5T3B0aW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICAgICAgY29uc3Qgc29ydEJ5ID0gc29ydEJ5T3B0aW9uc1tpXTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzb3J0QnkgJiYgc29ydEJ5LnByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgICAgLy8gY29sbGVjdGlvbiBvZiBvYmplY3RzIHdpdGggYSBwcm9wZXJ0eSBuYW1lIHByb3ZpZGVkXHJcbiAgICAgICAgICAgICAgY29uc3Qgc29ydERpcmVjdGlvbiA9IHNvcnRCeS5zb3J0RGVzYyA/IFNvcnREaXJlY3Rpb25OdW1iZXIuZGVzYyA6IFNvcnREaXJlY3Rpb25OdW1iZXIuYXNjO1xyXG4gICAgICAgICAgICAgIGNvbnN0IG9iamVjdFByb3BlcnR5ID0gc29ydEJ5LnByb3BlcnR5O1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHNvcnRCeS5maWVsZFR5cGUgfHwgRmllbGRUeXBlLnN0cmluZztcclxuICAgICAgICAgICAgICBjb25zdCB2YWx1ZTEgPSAoZW5hYmxlVHJhbnNsYXRlTGFiZWwpID8gdGhpcy50cmFuc2xhdGUgJiYgdGhpcy50cmFuc2xhdGUuY3VycmVudExhbmcgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChkYXRhUm93MVtvYmplY3RQcm9wZXJ0eV0gfHwgJyAnKSA6IGRhdGFSb3cxW29iamVjdFByb3BlcnR5XTtcclxuICAgICAgICAgICAgICBjb25zdCB2YWx1ZTIgPSAoZW5hYmxlVHJhbnNsYXRlTGFiZWwpID8gdGhpcy50cmFuc2xhdGUgJiYgdGhpcy50cmFuc2xhdGUuY3VycmVudExhbmcgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChkYXRhUm93MltvYmplY3RQcm9wZXJ0eV0gfHwgJyAnKSA6IGRhdGFSb3cyW29iamVjdFByb3BlcnR5XTtcclxuXHJcbiAgICAgICAgICAgICAgY29uc3Qgc29ydFJlc3VsdCA9IHNvcnRCeUZpZWxkVHlwZShmaWVsZFR5cGUsIHZhbHVlMSwgdmFsdWUyLCBzb3J0RGlyZWN0aW9uLCBjb2x1bW5EZWYpO1xyXG4gICAgICAgICAgICAgIGlmIChzb3J0UmVzdWx0ICE9PSBTb3J0RGlyZWN0aW9uTnVtYmVyLm5ldXRyYWwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzb3J0UmVzdWx0O1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIFNvcnREaXJlY3Rpb25OdW1iZXIubmV1dHJhbDtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIGlmIChzb3J0QnlPcHRpb25zICYmIHNvcnRCeU9wdGlvbnMucHJvcGVydHkpIHtcclxuICAgICAgICAvLyBzaW5nbGUgc29ydFxyXG4gICAgICAgIC8vIGNvbGxlY3Rpb24gb2Ygb2JqZWN0cyB3aXRoIGEgcHJvcGVydHkgbmFtZSBwcm92aWRlZFxyXG4gICAgICAgIGNvbnN0IG9iamVjdFByb3BlcnR5ID0gc29ydEJ5T3B0aW9ucy5wcm9wZXJ0eTtcclxuICAgICAgICBjb25zdCBzb3J0RGlyZWN0aW9uID0gc29ydEJ5T3B0aW9ucy5zb3J0RGVzYyA/IFNvcnREaXJlY3Rpb25OdW1iZXIuZGVzYyA6IFNvcnREaXJlY3Rpb25OdW1iZXIuYXNjO1xyXG4gICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHNvcnRCeU9wdGlvbnMuZmllbGRUeXBlIHx8IEZpZWxkVHlwZS5zdHJpbmc7XHJcblxyXG4gICAgICAgIGlmIChvYmplY3RQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgc29ydGVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uc29ydCgoZGF0YVJvdzE6IGFueSwgZGF0YVJvdzI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZTEgPSAoZW5hYmxlVHJhbnNsYXRlTGFiZWwpID8gdGhpcy50cmFuc2xhdGUgJiYgdGhpcy50cmFuc2xhdGUuY3VycmVudExhbmcgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChkYXRhUm93MVtvYmplY3RQcm9wZXJ0eV0gfHwgJyAnKSA6IGRhdGFSb3cxW29iamVjdFByb3BlcnR5XTtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUyID0gKGVuYWJsZVRyYW5zbGF0ZUxhYmVsKSA/IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoZGF0YVJvdzJbb2JqZWN0UHJvcGVydHldIHx8ICcgJykgOiBkYXRhUm93MltvYmplY3RQcm9wZXJ0eV07XHJcbiAgICAgICAgICAgIGNvbnN0IHNvcnRSZXN1bHQgPSBzb3J0QnlGaWVsZFR5cGUoZmllbGRUeXBlLCB2YWx1ZTEsIHZhbHVlMiwgc29ydERpcmVjdGlvbiwgY29sdW1uRGVmKTtcclxuICAgICAgICAgICAgaWYgKHNvcnRSZXN1bHQgIT09IFNvcnREaXJlY3Rpb25OdW1iZXIubmV1dHJhbCkge1xyXG4gICAgICAgICAgICAgIHJldHVybiBzb3J0UmVzdWx0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBTb3J0RGlyZWN0aW9uTnVtYmVyLm5ldXRyYWw7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAoc29ydEJ5T3B0aW9ucyAmJiAhc29ydEJ5T3B0aW9ucy5wcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IHNvcnREaXJlY3Rpb24gPSBzb3J0QnlPcHRpb25zLnNvcnREZXNjID8gU29ydERpcmVjdGlvbk51bWJlci5kZXNjIDogU29ydERpcmVjdGlvbk51bWJlci5hc2M7XHJcbiAgICAgICAgY29uc3QgZmllbGRUeXBlID0gc29ydEJ5T3B0aW9ucy5maWVsZFR5cGUgfHwgRmllbGRUeXBlLnN0cmluZztcclxuXHJcbiAgICAgICAgc29ydGVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uc29ydCgoZGF0YVJvdzE6IGFueSwgZGF0YVJvdzI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUxID0gKGVuYWJsZVRyYW5zbGF0ZUxhYmVsKSA/IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoZGF0YVJvdzEgfHwgJyAnKSA6IGRhdGFSb3cxO1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUyID0gKGVuYWJsZVRyYW5zbGF0ZUxhYmVsKSA/IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoZGF0YVJvdzIgfHwgJyAnKSA6IGRhdGFSb3cyO1xyXG4gICAgICAgICAgY29uc3Qgc29ydFJlc3VsdCA9IHNvcnRCeUZpZWxkVHlwZShmaWVsZFR5cGUsIHZhbHVlMSwgdmFsdWUyLCBzb3J0RGlyZWN0aW9uLCBjb2x1bW5EZWYpO1xyXG4gICAgICAgICAgaWYgKHNvcnRSZXN1bHQgIT09IFNvcnREaXJlY3Rpb25OdW1iZXIubmV1dHJhbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gc29ydFJlc3VsdDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBTb3J0RGlyZWN0aW9uTnVtYmVyLm5ldXRyYWw7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc29ydGVkQ29sbGVjdGlvbjtcclxuICB9XHJcbn1cclxuIl19