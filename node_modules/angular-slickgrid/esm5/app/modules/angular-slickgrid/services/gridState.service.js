import * as tslib_1 from "tslib";
import * as isequal_ from 'lodash.isequal';
var isequal = isequal_; // patch to fix rollup to work
import { ExtensionName, GridStateType, } from './../models/index';
import { ExtensionService } from './extension.service';
import { FilterService } from './filter.service';
import { SortService } from './sort.service';
import { Subject } from 'rxjs';
import { unsubscribeAllObservables } from './utilities';
import { SharedService } from './shared.service';
import { Injectable } from '@angular/core';
var GridStateService = /** @class */ (function () {
    function GridStateService(extensionService, filterService, sharedService, sortService) {
        this.extensionService = extensionService;
        this.filterService = filterService;
        this.sharedService = sharedService;
        this.sortService = sortService;
        this._columns = [];
        this._currentColumns = [];
        this._subscriptions = [];
        this._selectedRowDataContextIds = []; // used with row selection
        this._selectedFilteredRowDataContextIds = []; // used with row selection
        this._wasRecheckedAfterPageChange = true; // used with row selection & pagination
        this.onGridStateChanged = new Subject();
        this._eventHandler = new Slick.EventHandler();
    }
    Object.defineProperty(GridStateService.prototype, "_gridOptions", {
        /** Getter for the Grid Options pulled through the Grid Object */
        get: function () {
            return (this._grid && this._grid.getOptions) ? this._grid.getOptions() : {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GridStateService.prototype, "datasetIdPropName", {
        get: function () {
            return this._gridOptions.datasetIdPropertyName || 'id';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GridStateService.prototype, "selectedRowDataContextIds", {
        /** Getter of the selected data context object IDs */
        get: function () {
            return this._selectedRowDataContextIds;
        },
        /** Setter of the selected data context object IDs */
        set: function (dataContextIds) {
            this._selectedRowDataContextIds = dataContextIds;
            // since this is coming from a preset, we also need to update the filtered IDs
            this._selectedFilteredRowDataContextIds = dataContextIds;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Initialize the Grid State Service
     * @param grid
     */
    GridStateService.prototype.init = function (grid, dataView) {
        this._grid = grid;
        this._dataView = dataView;
        this.subscribeToAllGridChanges(grid);
    };
    /** Dispose of all the SlickGrid & Angular subscriptions */
    GridStateService.prototype.dispose = function () {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        // also unsubscribe all Angular Subscriptions
        this._subscriptions = unsubscribeAllObservables(this._subscriptions);
        this._currentColumns = [];
        this._columns = [];
    };
    /**
     * Get the current grid state (filters/sorters/pagination)
     * @return grid state
     */
    GridStateService.prototype.getCurrentGridState = function (args) {
        var gridState = {
            columns: this.getCurrentColumns(),
            filters: this.getCurrentFilters(),
            sorters: this.getCurrentSorters(),
        };
        var currentPagination = this.getCurrentPagination();
        if (currentPagination) {
            gridState.pagination = currentPagination;
        }
        if (this.hasRowSelectionEnabled()) {
            var currentRowSelection = this.getCurrentRowSelections(args && args.requestRefreshRowFilteredRow);
            if (currentRowSelection) {
                gridState.rowSelection = currentRowSelection;
            }
        }
        return gridState;
    };
    /**
     * Get the Columns (and their state: visibility/position) that are currently applied in the grid
     * @return current columns
     */
    GridStateService.prototype.getColumns = function () {
        return this._columns;
    };
    /**
     * From an array of Grid Column Definitions, get the associated Current Columns
     * @param gridColumns
     */
    GridStateService.prototype.getAssociatedCurrentColumns = function (gridColumns) {
        var currentColumns = [];
        if (gridColumns && Array.isArray(gridColumns)) {
            gridColumns.forEach(function (column, index) {
                if (column && column.id) {
                    currentColumns.push({
                        columnId: column.id,
                        cssClass: column.cssClass || '',
                        headerCssClass: column.headerCssClass || '',
                        width: column.width || 0
                    });
                }
            });
        }
        this._currentColumns = currentColumns;
        return currentColumns;
    };
    /**
     * From an array of Current Columns, get the associated Grid Column Definitions
     * @param grid
     * @param currentColumns
     */
    GridStateService.prototype.getAssociatedGridColumns = function (grid, currentColumns) {
        var columns = [];
        var gridColumns = grid.getColumns();
        if (currentColumns && Array.isArray(currentColumns)) {
            currentColumns.forEach(function (currentColumn, index) {
                var gridColumn = gridColumns.find(function (c) { return c.id === currentColumn.columnId; });
                if (gridColumn && gridColumn.id) {
                    columns.push(tslib_1.__assign({}, gridColumn, { cssClass: currentColumn.cssClass, headerCssClass: currentColumn.headerCssClass, width: currentColumn.width }));
                }
            });
        }
        this._columns = columns;
        return columns;
    };
    /**
     * Get the Columns (and their state: visibility/position) that are currently applied in the grid
     * @return current columns
     */
    GridStateService.prototype.getCurrentColumns = function () {
        var currentColumns = [];
        if (this._currentColumns && Array.isArray(this._currentColumns) && this._currentColumns.length > 0) {
            currentColumns = this._currentColumns;
        }
        else {
            currentColumns = this.getAssociatedCurrentColumns(this._grid.getColumns());
        }
        return currentColumns;
    };
    /**
     * Get the Filters (and their state, columnId, searchTerm(s)) that are currently applied in the grid
     * @return current filters
     */
    GridStateService.prototype.getCurrentFilters = function () {
        if (this._gridOptions && this._gridOptions.backendServiceApi) {
            var backendService = this._gridOptions.backendServiceApi.service;
            if (backendService && backendService.getCurrentFilters) {
                return backendService.getCurrentFilters();
            }
        }
        else if (this.filterService && this.filterService.getCurrentLocalFilters) {
            return this.filterService.getCurrentLocalFilters();
        }
        return null;
    };
    /**
     * Get current Pagination (and it's state, pageNumber, pageSize) that are currently applied in the grid
     * @return current pagination state
     */
    GridStateService.prototype.getCurrentPagination = function () {
        if (this._gridOptions.enablePagination) {
            if (this._gridOptions && this._gridOptions.backendServiceApi) {
                var backendService = this._gridOptions.backendServiceApi.service;
                if (backendService && backendService.getCurrentPagination) {
                    return backendService.getCurrentPagination();
                }
            }
            else {
                return this.sharedService.currentPagination;
            }
        }
        return null;
    };
    /**
     * Get the current Sorters (and their state, columnId, direction) that are currently applied in the grid
     * @return current sorters
     */
    GridStateService.prototype.getCurrentRowSelections = function (requestRefreshFilteredRow) {
        if (requestRefreshFilteredRow === void 0) { requestRefreshFilteredRow = true; }
        if (this._grid && this._gridOptions && this._dataView && this.hasRowSelectionEnabled()) {
            if (this._grid.getSelectedRows && this._dataView.mapRowsToIds) {
                var filteredDataContextIds = [];
                var gridRowIndexes = this._dataView.mapIdsToRows(this._selectedRowDataContextIds || []); // note that this will return only what is visible in current page
                var dataContextIds = this._selectedRowDataContextIds;
                // user might request to refresh the filtered selection dataset
                // typically always True, except when "reEvaluateRowSelectionAfterFilterChange" is called and we don't need to refresh the filtered dataset twice
                if (requestRefreshFilteredRow === true) {
                    filteredDataContextIds = this.refreshFilteredRowSelections();
                }
                filteredDataContextIds = this._selectedFilteredRowDataContextIds;
                return { gridRowIndexes: gridRowIndexes, dataContextIds: dataContextIds, filteredDataContextIds: filteredDataContextIds };
            }
        }
        return null;
    };
    /**
     * Get the current Sorters (and their state, columnId, direction) that are currently applied in the grid
     * @return current sorters
     */
    GridStateService.prototype.getCurrentSorters = function () {
        if (this._gridOptions && this._gridOptions.backendServiceApi) {
            var backendService = this._gridOptions.backendServiceApi.service;
            if (backendService && backendService.getCurrentSorters) {
                return backendService.getCurrentSorters();
            }
        }
        else if (this.sortService && this.sortService.getCurrentLocalSorters) {
            return this.sortService.getCurrentLocalSorters();
        }
        return null;
    };
    /** Check whether the row selection needs to be preserved */
    GridStateService.prototype.needToPreserveRowSelection = function () {
        var preservedRowSelection = false;
        if (this._gridOptions && this._gridOptions.dataView && this._gridOptions.dataView.hasOwnProperty('syncGridSelection')) {
            var syncGridSelection = this._gridOptions.dataView.syncGridSelection;
            if (typeof syncGridSelection === 'boolean') {
                preservedRowSelection = this._gridOptions.dataView.syncGridSelection;
            }
            else {
                preservedRowSelection = syncGridSelection.preserveHidden;
            }
            // if the result is True but the grid is using a Backend Service, we will do an extra flag check the reason is because it might have some unintended behaviors
            // with the BackendServiceApi because technically the data in the page changes the DataView on every page.
            if (preservedRowSelection && this._gridOptions.backendServiceApi && this._gridOptions.dataView.hasOwnProperty('syncGridSelectionWithBackendService')) {
                preservedRowSelection = this._gridOptions.dataView.syncGridSelectionWithBackendService;
            }
        }
        return preservedRowSelection;
    };
    GridStateService.prototype.resetColumns = function (columnDefinitions) {
        var columns = columnDefinitions || this._columns;
        var currentColumns = this.getAssociatedCurrentColumns(columns);
        this.onGridStateChanged.next({ change: { newValues: currentColumns, type: GridStateType.columns }, gridState: this.getCurrentGridState() });
    };
    /** if we use Row Selection or the Checkbox Selector, we need to reset any selection */
    GridStateService.prototype.resetRowSelectionWhenRequired = function () {
        if (!this.needToPreserveRowSelection() && (this._gridOptions.enableRowSelection || this._gridOptions.enableCheckboxSelector)) {
            // this also requires the Row Selection Model to be registered as well
            var rowSelectionExtension = this.extensionService && this.extensionService.getExtensionByName && this.extensionService.getExtensionByName(ExtensionName.rowSelection);
            if (rowSelectionExtension && rowSelectionExtension.instance) {
                this._grid.setSelectedRows([]);
            }
        }
    };
    /**
     * Subscribe to all necessary SlickGrid or Service Events that deals with a Grid change,
     * when triggered, we will publish a Grid State Event with current Grid State
     */
    GridStateService.prototype.subscribeToAllGridChanges = function (grid) {
        var _this = this;
        // Subscribe to Event Emitter of Filter changed
        this._subscriptions.push(this.filterService.onFilterChanged.subscribe(function (currentFilters) {
            _this.resetRowSelectionWhenRequired();
            // trigger a Grid State filter change, however don't reevaluate the filtered row selections, we'll do that on the next Grid State change below
            _this.onGridStateChanged.next({ change: { newValues: currentFilters, type: GridStateType.filter }, gridState: _this.getCurrentGridState({ requestRefreshRowFilteredRow: !_this.hasRowSelectionEnabled() }) });
            // when Row Selection is enabled, we also need to re-evaluate the row selection with the leftover filtered dataset
            if (_this.hasRowSelectionEnabled()) {
                _this.reEvaluateRowSelectionAfterFilterChange();
            }
        }));
        // Subscribe to Event Emitter of Filter cleared
        this._subscriptions.push(this.filterService.onFilterCleared.subscribe(function () {
            _this.resetRowSelectionWhenRequired();
            _this.onGridStateChanged.next({ change: { newValues: [], type: GridStateType.filter }, gridState: _this.getCurrentGridState() });
        }));
        // Subscribe to Event Emitter of Sort changed
        this._subscriptions.push(this.sortService.onSortChanged.subscribe(function (currentSorters) {
            _this.resetRowSelectionWhenRequired();
            _this.onGridStateChanged.next({ change: { newValues: currentSorters, type: GridStateType.sorter }, gridState: _this.getCurrentGridState() });
        }));
        // Subscribe to Event Emitter of Sort cleared
        this._subscriptions.push(this.sortService.onSortCleared.subscribe(function () {
            _this.resetRowSelectionWhenRequired();
            _this.onGridStateChanged.next({ change: { newValues: [], type: GridStateType.sorter }, gridState: _this.getCurrentGridState() });
        }));
        // Subscribe to ColumnPicker and/or GridMenu for show/hide Columns visibility changes
        this.bindExtensionAddonEventToGridStateChange(ExtensionName.columnPicker, 'onColumnsChanged');
        this.bindExtensionAddonEventToGridStateChange(ExtensionName.gridMenu, 'onColumnsChanged');
        // subscribe to Column Resize & Reordering
        this.bindSlickGridColumnChangeEventToGridStateChange('onColumnsReordered', grid);
        this.bindSlickGridColumnChangeEventToGridStateChange('onColumnsResized', grid);
        // subscribe to Row Selection changes (when enabled)
        if (this._gridOptions.enableRowSelection || this._gridOptions.enableCheckboxSelector) {
            this.bindSlickGridRowSelectionToGridStateChange();
        }
        // subscribe to HeaderMenu (hide column)
        this._subscriptions.push(this.sharedService.onColumnsChanged.subscribe(function (visibleColumns) {
            var currentColumns = _this.getAssociatedCurrentColumns(visibleColumns);
            _this.onGridStateChanged.next({ change: { newValues: currentColumns, type: GridStateType.columns }, gridState: _this.getCurrentGridState() });
        }));
    };
    // --
    // private methods
    // ------------------
    /**
     * Bind a SlickGrid Extension Event to a Grid State change event
     * @param extension name
     * @param grid
     */
    GridStateService.prototype.bindExtensionAddonEventToGridStateChange = function (extensionName, eventName) {
        var _this = this;
        var extension = this.extensionService && this.extensionService.getExtensionByName && this.extensionService.getExtensionByName(extensionName);
        var slickEvent = extension && extension.instance && extension.instance[eventName];
        if (slickEvent && slickEvent.subscribe) {
            this._eventHandler.subscribe(slickEvent, function (e, args) {
                var columns = args && args.columns;
                var currentColumns = _this.getAssociatedCurrentColumns(columns);
                _this.onGridStateChanged.next({ change: { newValues: currentColumns, type: GridStateType.columns }, gridState: _this.getCurrentGridState() });
            });
        }
    };
    /**
     * Bind a Grid Event (of Column changes) to a Grid State change event
     * @param event name
     * @param grid
     */
    GridStateService.prototype.bindSlickGridColumnChangeEventToGridStateChange = function (eventName, grid) {
        var _this = this;
        var slickGridEvent = grid && grid[eventName];
        if (slickGridEvent && slickGridEvent.subscribe) {
            this._eventHandler.subscribe(slickGridEvent, function () {
                var columns = grid.getColumns();
                var currentColumns = _this.getAssociatedCurrentColumns(columns);
                _this.onGridStateChanged.next({ change: { newValues: currentColumns, type: GridStateType.columns }, gridState: _this.getCurrentGridState() });
            });
        }
    };
    /**
     * Bind a Grid Event of Row Selection change to a Grid State change event
     * For the row selection, we can't just use the getSelectedRows() since this will only return the visible rows shown in the UI which is not enough.
     * The process is much more complex, what we have to do instead is the following
     * 1. when changing a row selection, we'll add the new selection if it's not yet in the global array of selected IDs
     * 2. when deleting a row selection, we'll remove the selection from our global array of selected IDs (unless it came from a page change)
     * 3. if we use Pagination and we change page, we'll keep track with a flag (this flag will be used to skip any deletion when we're changing page)
     * 4. after the Page or DataView is changed or updated, we'll do an extra (and delayed) check to make sure that what we have in our global array of selected IDs is displayed on screen
     */
    GridStateService.prototype.bindSlickGridRowSelectionToGridStateChange = function () {
        var _this = this;
        if (this._grid && this._gridOptions && this._dataView) {
            this._eventHandler.subscribe(this._dataView.onBeforePagingInfoChanged, function () {
                _this._wasRecheckedAfterPageChange = false; // reset the page check flag, to skip deletions on page change (used in code below)
            });
            this._eventHandler.subscribe(this._dataView.onPagingInfoChanged, function () {
                // when user changes page, the selected row indexes might not show up
                // we can check to make sure it is but it has to be in a delay so it happens after the first "onSelectedRowsChanged" is triggered
                setTimeout(function () {
                    var shouldBeSelectedRowIndexes = _this._dataView.mapIdsToRows(_this._selectedRowDataContextIds || []);
                    var currentSelectedRowIndexes = _this._grid.getSelectedRows();
                    if (!isequal(shouldBeSelectedRowIndexes, currentSelectedRowIndexes)) {
                        _this._grid.setSelectedRows(shouldBeSelectedRowIndexes);
                    }
                });
            });
            this._eventHandler.subscribe(this._grid.onSelectedRowsChanged, function (e, args) {
                if (Array.isArray(args.rows) && Array.isArray(args.previousSelectedRows)) {
                    var newSelectedRows_1 = args.rows;
                    var prevSelectedRows_1 = args.previousSelectedRows;
                    var newSelectedAdditions = newSelectedRows_1.filter(function (i) { return prevSelectedRows_1.indexOf(i) < 0; });
                    var newSelectedDeletions = prevSelectedRows_1.filter(function (i) { return newSelectedRows_1.indexOf(i) < 0; });
                    // deletion might happen when user is changing page, if that is the case then skip the deletion since it's only a visual deletion (current page)
                    // if it's not a page change (when the flag is true), then proceed with the deletion in our global array of selected IDs
                    if (_this._wasRecheckedAfterPageChange && newSelectedDeletions.length > 0) {
                        var toDeleteDataIds = _this._dataView.mapRowsToIds(newSelectedDeletions) || [];
                        toDeleteDataIds.forEach(function (removeId) {
                            _this._selectedRowDataContextIds.splice(_this._selectedRowDataContextIds.indexOf(removeId), 1);
                        });
                    }
                    // if we have newly added selected row(s), let's update our global array of selected IDs
                    if (newSelectedAdditions.length > 0) {
                        var toAddDataIds = _this._dataView.mapRowsToIds(newSelectedAdditions) || [];
                        toAddDataIds.forEach(function (dataId) {
                            if (_this._selectedRowDataContextIds.indexOf(dataId) === -1) {
                                _this._selectedRowDataContextIds.push(dataId);
                            }
                        });
                    }
                    // we set this flag which will be used on the 2nd time the "onSelectedRowsChanged" event is called
                    // when it's the first time, we skip deletion and this is what this flag is for
                    _this._wasRecheckedAfterPageChange = true;
                    // form our full selected row IDs, let's make sure these indexes are selected in the grid, if not then let's call a reselect
                    // this could happen if the previous step was a page change
                    var shouldBeSelectedRowIndexes = _this._dataView.mapIdsToRows(_this._selectedRowDataContextIds || []);
                    var currentSelectedRowIndexes = _this._grid.getSelectedRows();
                    if (!isequal(shouldBeSelectedRowIndexes, currentSelectedRowIndexes)) {
                        _this._grid.setSelectedRows(shouldBeSelectedRowIndexes);
                    }
                    var filteredDataContextIds = _this.refreshFilteredRowSelections();
                    var newValues = { gridRowIndexes: _this._grid.getSelectedRows(), dataContextIds: _this._selectedRowDataContextIds, filteredDataContextIds: filteredDataContextIds };
                    _this.onGridStateChanged.next({ change: { newValues: newValues, type: GridStateType.rowSelection }, gridState: _this.getCurrentGridState() });
                }
            });
        }
    };
    /** Check wether the grid has the Row Selection enabled */
    GridStateService.prototype.hasRowSelectionEnabled = function () {
        var selectionModel = this._grid.getSelectionModel();
        var isRowSelectionEnabled = this._gridOptions.enableRowSelection || this._gridOptions.enableCheckboxSelector;
        return (isRowSelectionEnabled && selectionModel);
    };
    GridStateService.prototype.reEvaluateRowSelectionAfterFilterChange = function () {
        var currentSelectedRowIndexes = this._grid.getSelectedRows();
        var previousSelectedFilteredRowDataContextIds = this._selectedFilteredRowDataContextIds.slice();
        var filteredDataContextIds = this.refreshFilteredRowSelections();
        // when selection changed, we'll send a Grid State event with the selection changes
        if (!isequal(this._selectedFilteredRowDataContextIds, previousSelectedFilteredRowDataContextIds)) {
            var newValues = { gridRowIndexes: currentSelectedRowIndexes, dataContextIds: this._selectedRowDataContextIds, filteredDataContextIds: filteredDataContextIds };
            this.onGridStateChanged.next({ change: { newValues: newValues, type: GridStateType.rowSelection }, gridState: this.getCurrentGridState({ requestRefreshRowFilteredRow: false }) });
        }
    };
    /** When a Filter is triggered or when user request it, we will refresh the filtered selection array and return it */
    GridStateService.prototype.refreshFilteredRowSelections = function () {
        var _this = this;
        var tmpFilteredArray = [];
        var filteredDataset = this._dataView.getFilteredItems() || [];
        if (Array.isArray(this._selectedRowDataContextIds)) {
            var selectedFilteredRowDataContextIds = tslib_1.__spread(this._selectedRowDataContextIds); // take a fresh copy of all selections before filtering the row ids
            tmpFilteredArray = selectedFilteredRowDataContextIds.filter(function (selectedRowId) {
                return filteredDataset.findIndex(function (item) { return item[_this.datasetIdPropName] === selectedRowId; }) > -1;
            });
            this._selectedFilteredRowDataContextIds = tmpFilteredArray;
        }
        return tmpFilteredArray;
    };
    GridStateService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [ExtensionService,
            FilterService,
            SharedService,
            SortService])
    ], GridStateService);
    return GridStateService;
}());
export { GridStateService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZFN0YXRlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL3NlcnZpY2VzL2dyaWRTdGF0ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssUUFBUSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLElBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxDQUFDLDhCQUE4QjtBQUV4RCxPQUFPLEVBT0wsYUFBYSxFQUliLGFBQWEsR0FFZCxNQUFNLG1CQUFtQixDQUFDO0FBQzNCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBTTNDO0lBWUUsMEJBQ1UsZ0JBQWtDLEVBQ2xDLGFBQTRCLEVBQzVCLGFBQTRCLEVBQzVCLFdBQXdCO1FBSHhCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFkMUIsYUFBUSxHQUFhLEVBQUUsQ0FBQztRQUN4QixvQkFBZSxHQUFvQixFQUFFLENBQUM7UUFHdEMsbUJBQWMsR0FBbUIsRUFBRSxDQUFDO1FBQ3BDLCtCQUEwQixHQUF1QyxFQUFFLENBQUMsQ0FB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QyxFQUFFO1lBQ2xELElBQU0saUNBQWlDLG9CQUFPLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUMsbUVBQW1FO1lBQ25KLGdCQUFnQixHQUFHLGlDQUFpQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLGFBQThCO2dCQUN6RixPQUFPLGVBQWUsQ0FBQyxTQUFTLENBQUMsVUFBQyxJQUFTLElBQUssT0FBQSxJQUFJLENBQUMsS0FBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssYUFBYSxFQUE5QyxDQUE4QyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdkcsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsa0NBQWtDLEdBQUcsZ0JBQWdCLENBQUM7U0FDNUQ7UUFDRCxPQUFPLGdCQUFnQixDQUFDO0lBQzFCLENBQUM7SUFuZVUsZ0JBQWdCO1FBRDVCLFVBQVUsRUFBRTtpREFjaUIsZ0JBQWdCO1lBQ25CLGFBQWE7WUFDYixhQUFhO1lBQ2YsV0FBVztPQWhCdkIsZ0JBQWdCLENBb2U1QjtJQUFELHVCQUFDO0NBQUEsQUFwZUQsSUFvZUM7U0FwZVksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgaXNlcXVhbF8gZnJvbSAnbG9kYXNoLmlzZXF1YWwnO1xyXG5jb25zdCBpc2VxdWFsID0gaXNlcXVhbF87IC8vIHBhdGNoIHRvIGZpeCByb2xsdXAgdG8gd29ya1xyXG5cclxuaW1wb3J0IHtcclxuICBDb2x1bW4sXHJcbiAgQ3VycmVudENvbHVtbixcclxuICBDdXJyZW50RmlsdGVyLFxyXG4gIEN1cnJlbnRQYWdpbmF0aW9uLFxyXG4gIEN1cnJlbnRSb3dTZWxlY3Rpb24sXHJcbiAgQ3VycmVudFNvcnRlcixcclxuICBFeHRlbnNpb25OYW1lLFxyXG4gIEdyaWRPcHRpb24sXHJcbiAgR3JpZFN0YXRlLFxyXG4gIEdyaWRTdGF0ZUNoYW5nZSxcclxuICBHcmlkU3RhdGVUeXBlLFxyXG4gIFNsaWNrRXZlbnRIYW5kbGVyLFxyXG59IGZyb20gJy4vLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgRXh0ZW5zaW9uU2VydmljZSB9IGZyb20gJy4vZXh0ZW5zaW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGaWx0ZXJTZXJ2aWNlIH0gZnJvbSAnLi9maWx0ZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IFNvcnRTZXJ2aWNlIH0gZnJvbSAnLi9zb3J0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdW5zdWJzY3JpYmVBbGxPYnNlcnZhYmxlcyB9IGZyb20gJy4vdXRpbGl0aWVzJztcclxuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4vc2hhcmVkLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG4vLyB1c2luZyBleHRlcm5hbCBub24tdHlwZWQganMgbGlicmFyaWVzXHJcbmRlY2xhcmUgdmFyIFNsaWNrOiBhbnk7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBHcmlkU3RhdGVTZXJ2aWNlIHtcclxuICBwcml2YXRlIF9ldmVudEhhbmRsZXI6IFNsaWNrRXZlbnRIYW5kbGVyO1xyXG4gIHByaXZhdGUgX2NvbHVtbnM6IENvbHVtbltdID0gW107XHJcbiAgcHJpdmF0ZSBfY3VycmVudENvbHVtbnM6IEN1cnJlbnRDb2x1bW5bXSA9IFtdO1xyXG4gIHByaXZhdGUgX2RhdGFWaWV3OiBhbnk7XHJcbiAgcHJpdmF0ZSBfZ3JpZDogYW55O1xyXG4gIHByaXZhdGUgX3N1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XHJcbiAgcHJpdmF0ZSBfc2VsZWN0ZWRSb3dEYXRhQ29udGV4dElkczogQXJyYXk8bnVtYmVyIHwgc3RyaW5nPiB8IHVuZGVmaW5lZCA9IFtdOyAvLyB1c2VkIHdpdGggcm93IHNlbGVjdGlvblxyXG4gIHByaXZhdGUgX3NlbGVjdGVkRmlsdGVyZWRSb3dEYXRhQ29udGV4dElkczogQXJyYXk8bnVtYmVyIHwgc3RyaW5nPiB8IHVuZGVmaW5lZCA9IFtdOyAvLyB1c2VkIHdpdGggcm93IHNlbGVjdGlvblxyXG4gIHByaXZhdGUgX3dhc1JlY2hlY2tlZEFmdGVyUGFnZUNoYW5nZSA9IHRydWU7IC8vIHVzZWQgd2l0aCByb3cgc2VsZWN0aW9uICYgcGFnaW5hdGlvblxyXG4gIG9uR3JpZFN0YXRlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PEdyaWRTdGF0ZUNoYW5nZT4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGV4dGVuc2lvblNlcnZpY2U6IEV4dGVuc2lvblNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZpbHRlclNlcnZpY2U6IEZpbHRlclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHNoYXJlZFNlcnZpY2U6IFNoYXJlZFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHNvcnRTZXJ2aWNlOiBTb3J0U2VydmljZVxyXG4gICkge1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyID0gbmV3IFNsaWNrLkV2ZW50SGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldHRlciBmb3IgdGhlIEdyaWQgT3B0aW9ucyBwdWxsZWQgdGhyb3VnaCB0aGUgR3JpZCBPYmplY3QgKi9cclxuICBwcml2YXRlIGdldCBfZ3JpZE9wdGlvbnMoKTogR3JpZE9wdGlvbiB7XHJcbiAgICByZXR1cm4gKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZC5nZXRPcHRpb25zKSA/IHRoaXMuX2dyaWQuZ2V0T3B0aW9ucygpIDoge307XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldCBkYXRhc2V0SWRQcm9wTmFtZSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuX2dyaWRPcHRpb25zLmRhdGFzZXRJZFByb3BlcnR5TmFtZSB8fCAnaWQnO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldHRlciBvZiB0aGUgc2VsZWN0ZWQgZGF0YSBjb250ZXh0IG9iamVjdCBJRHMgKi9cclxuICBnZXQgc2VsZWN0ZWRSb3dEYXRhQ29udGV4dElkcygpOiBBcnJheTxudW1iZXIgfCBzdHJpbmc+IHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLl9zZWxlY3RlZFJvd0RhdGFDb250ZXh0SWRzO1xyXG4gIH1cclxuXHJcbiAgLyoqIFNldHRlciBvZiB0aGUgc2VsZWN0ZWQgZGF0YSBjb250ZXh0IG9iamVjdCBJRHMgKi9cclxuICBzZXQgc2VsZWN0ZWRSb3dEYXRhQ29udGV4dElkcyhkYXRhQ29udGV4dElkczogQXJyYXk8bnVtYmVyIHwgc3RyaW5nPiB8IHVuZGVmaW5lZCkge1xyXG4gICAgdGhpcy5fc2VsZWN0ZWRSb3dEYXRhQ29udGV4dElkcyA9IGRhdGFDb250ZXh0SWRzO1xyXG5cclxuICAgIC8vIHNpbmNlIHRoaXMgaXMgY29taW5nIGZyb20gYSBwcmVzZXQsIHdlIGFsc28gbmVlZCB0byB1cGRhdGUgdGhlIGZpbHRlcmVkIElEc1xyXG4gICAgdGhpcy5fc2VsZWN0ZWRGaWx0ZXJlZFJvd0RhdGFDb250ZXh0SWRzID0gZGF0YUNvbnRleHRJZHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbml0aWFsaXplIHRoZSBHcmlkIFN0YXRlIFNlcnZpY2VcclxuICAgKiBAcGFyYW0gZ3JpZFxyXG4gICAqL1xyXG4gIGluaXQoZ3JpZDogYW55LCBkYXRhVmlldzogYW55KTogdm9pZCB7XHJcbiAgICB0aGlzLl9ncmlkID0gZ3JpZDtcclxuICAgIHRoaXMuX2RhdGFWaWV3ID0gZGF0YVZpZXc7XHJcbiAgICB0aGlzLnN1YnNjcmliZVRvQWxsR3JpZENoYW5nZXMoZ3JpZCk7XHJcbiAgfVxyXG5cclxuICAvKiogRGlzcG9zZSBvZiBhbGwgdGhlIFNsaWNrR3JpZCAmIEFuZ3VsYXIgc3Vic2NyaXB0aW9ucyAqL1xyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICAvLyB1bnN1YnNjcmliZSBhbGwgU2xpY2tHcmlkIGV2ZW50c1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyLnVuc3Vic2NyaWJlQWxsKCk7XHJcblxyXG4gICAgLy8gYWxzbyB1bnN1YnNjcmliZSBhbGwgQW5ndWxhciBTdWJzY3JpcHRpb25zXHJcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gdW5zdWJzY3JpYmVBbGxPYnNlcnZhYmxlcyh0aGlzLl9zdWJzY3JpcHRpb25zKTtcclxuXHJcbiAgICB0aGlzLl9jdXJyZW50Q29sdW1ucyA9IFtdO1xyXG4gICAgdGhpcy5fY29sdW1ucyA9IFtdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBjdXJyZW50IGdyaWQgc3RhdGUgKGZpbHRlcnMvc29ydGVycy9wYWdpbmF0aW9uKVxyXG4gICAqIEByZXR1cm4gZ3JpZCBzdGF0ZVxyXG4gICAqL1xyXG4gIGdldEN1cnJlbnRHcmlkU3RhdGUoYXJncz86IHsgcmVxdWVzdFJlZnJlc2hSb3dGaWx0ZXJlZFJvdz86IGJvb2xlYW4gfSk6IEdyaWRTdGF0ZSB7XHJcbiAgICBjb25zdCBncmlkU3RhdGU6IEdyaWRTdGF0ZSA9IHtcclxuICAgICAgY29sdW1uczogdGhpcy5nZXRDdXJyZW50Q29sdW1ucygpLFxyXG4gICAgICBmaWx0ZXJzOiB0aGlzLmdldEN1cnJlbnRGaWx0ZXJzKCksXHJcbiAgICAgIHNvcnRlcnM6IHRoaXMuZ2V0Q3VycmVudFNvcnRlcnMoKSxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgY3VycmVudFBhZ2luYXRpb24gPSB0aGlzLmdldEN1cnJlbnRQYWdpbmF0aW9uKCk7XHJcbiAgICBpZiAoY3VycmVudFBhZ2luYXRpb24pIHtcclxuICAgICAgZ3JpZFN0YXRlLnBhZ2luYXRpb24gPSBjdXJyZW50UGFnaW5hdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5oYXNSb3dTZWxlY3Rpb25FbmFibGVkKCkpIHtcclxuICAgICAgY29uc3QgY3VycmVudFJvd1NlbGVjdGlvbiA9IHRoaXMuZ2V0Q3VycmVudFJvd1NlbGVjdGlvbnMoYXJncyAmJiBhcmdzLnJlcXVlc3RSZWZyZXNoUm93RmlsdGVyZWRSb3cpO1xyXG4gICAgICBpZiAoY3VycmVudFJvd1NlbGVjdGlvbikge1xyXG4gICAgICAgIGdyaWRTdGF0ZS5yb3dTZWxlY3Rpb24gPSBjdXJyZW50Um93U2VsZWN0aW9uO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZ3JpZFN0YXRlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBDb2x1bW5zIChhbmQgdGhlaXIgc3RhdGU6IHZpc2liaWxpdHkvcG9zaXRpb24pIHRoYXQgYXJlIGN1cnJlbnRseSBhcHBsaWVkIGluIHRoZSBncmlkXHJcbiAgICogQHJldHVybiBjdXJyZW50IGNvbHVtbnNcclxuICAgKi9cclxuICBnZXRDb2x1bW5zKCk6IENvbHVtbltdIHtcclxuICAgIHJldHVybiB0aGlzLl9jb2x1bW5zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRnJvbSBhbiBhcnJheSBvZiBHcmlkIENvbHVtbiBEZWZpbml0aW9ucywgZ2V0IHRoZSBhc3NvY2lhdGVkIEN1cnJlbnQgQ29sdW1uc1xyXG4gICAqIEBwYXJhbSBncmlkQ29sdW1uc1xyXG4gICAqL1xyXG4gIGdldEFzc29jaWF0ZWRDdXJyZW50Q29sdW1ucyhncmlkQ29sdW1uczogQ29sdW1uW10pOiBDdXJyZW50Q29sdW1uW10ge1xyXG4gICAgY29uc3QgY3VycmVudENvbHVtbnM6IEN1cnJlbnRDb2x1bW5bXSA9IFtdO1xyXG5cclxuICAgIGlmIChncmlkQ29sdW1ucyAmJiBBcnJheS5pc0FycmF5KGdyaWRDb2x1bW5zKSkge1xyXG4gICAgICBncmlkQ29sdW1ucy5mb3JFYWNoKChjb2x1bW46IENvbHVtbiwgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgIGlmIChjb2x1bW4gJiYgY29sdW1uLmlkKSB7XHJcbiAgICAgICAgICBjdXJyZW50Q29sdW1ucy5wdXNoKHtcclxuICAgICAgICAgICAgY29sdW1uSWQ6IGNvbHVtbi5pZCBhcyBzdHJpbmcsXHJcbiAgICAgICAgICAgIGNzc0NsYXNzOiBjb2x1bW4uY3NzQ2xhc3MgfHwgJycsXHJcbiAgICAgICAgICAgIGhlYWRlckNzc0NsYXNzOiBjb2x1bW4uaGVhZGVyQ3NzQ2xhc3MgfHwgJycsXHJcbiAgICAgICAgICAgIHdpZHRoOiBjb2x1bW4ud2lkdGggfHwgMFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHRoaXMuX2N1cnJlbnRDb2x1bW5zID0gY3VycmVudENvbHVtbnM7XHJcbiAgICByZXR1cm4gY3VycmVudENvbHVtbnM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGcm9tIGFuIGFycmF5IG9mIEN1cnJlbnQgQ29sdW1ucywgZ2V0IHRoZSBhc3NvY2lhdGVkIEdyaWQgQ29sdW1uIERlZmluaXRpb25zXHJcbiAgICogQHBhcmFtIGdyaWRcclxuICAgKiBAcGFyYW0gY3VycmVudENvbHVtbnNcclxuICAgKi9cclxuICBnZXRBc3NvY2lhdGVkR3JpZENvbHVtbnMoZ3JpZDogYW55LCBjdXJyZW50Q29sdW1uczogQ3VycmVudENvbHVtbltdKTogQ29sdW1uW10ge1xyXG4gICAgY29uc3QgY29sdW1uczogQ29sdW1uW10gPSBbXTtcclxuICAgIGNvbnN0IGdyaWRDb2x1bW5zOiBDb2x1bW5bXSA9IGdyaWQuZ2V0Q29sdW1ucygpO1xyXG5cclxuICAgIGlmIChjdXJyZW50Q29sdW1ucyAmJiBBcnJheS5pc0FycmF5KGN1cnJlbnRDb2x1bW5zKSkge1xyXG4gICAgICBjdXJyZW50Q29sdW1ucy5mb3JFYWNoKChjdXJyZW50Q29sdW1uOiBDdXJyZW50Q29sdW1uLCBpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZ3JpZENvbHVtbjogQ29sdW1uID0gZ3JpZENvbHVtbnMuZmluZCgoYzogQ29sdW1uKSA9PiBjLmlkID09PSBjdXJyZW50Q29sdW1uLmNvbHVtbklkKTtcclxuICAgICAgICBpZiAoZ3JpZENvbHVtbiAmJiBncmlkQ29sdW1uLmlkKSB7XHJcbiAgICAgICAgICBjb2x1bW5zLnB1c2goe1xyXG4gICAgICAgICAgICAuLi5ncmlkQ29sdW1uLFxyXG4gICAgICAgICAgICBjc3NDbGFzczogY3VycmVudENvbHVtbi5jc3NDbGFzcyxcclxuICAgICAgICAgICAgaGVhZGVyQ3NzQ2xhc3M6IGN1cnJlbnRDb2x1bW4uaGVhZGVyQ3NzQ2xhc3MsXHJcbiAgICAgICAgICAgIHdpZHRoOiBjdXJyZW50Q29sdW1uLndpZHRoXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fY29sdW1ucyA9IGNvbHVtbnM7XHJcbiAgICByZXR1cm4gY29sdW1ucztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB0aGUgQ29sdW1ucyAoYW5kIHRoZWlyIHN0YXRlOiB2aXNpYmlsaXR5L3Bvc2l0aW9uKSB0aGF0IGFyZSBjdXJyZW50bHkgYXBwbGllZCBpbiB0aGUgZ3JpZFxyXG4gICAqIEByZXR1cm4gY3VycmVudCBjb2x1bW5zXHJcbiAgICovXHJcbiAgZ2V0Q3VycmVudENvbHVtbnMoKTogQ3VycmVudENvbHVtbltdIHtcclxuICAgIGxldCBjdXJyZW50Q29sdW1uczogQ3VycmVudENvbHVtbltdID0gW107XHJcbiAgICBpZiAodGhpcy5fY3VycmVudENvbHVtbnMgJiYgQXJyYXkuaXNBcnJheSh0aGlzLl9jdXJyZW50Q29sdW1ucykgJiYgdGhpcy5fY3VycmVudENvbHVtbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjdXJyZW50Q29sdW1ucyA9IHRoaXMuX2N1cnJlbnRDb2x1bW5zO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY3VycmVudENvbHVtbnMgPSB0aGlzLmdldEFzc29jaWF0ZWRDdXJyZW50Q29sdW1ucyh0aGlzLl9ncmlkLmdldENvbHVtbnMoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGN1cnJlbnRDb2x1bW5zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBGaWx0ZXJzIChhbmQgdGhlaXIgc3RhdGUsIGNvbHVtbklkLCBzZWFyY2hUZXJtKHMpKSB0aGF0IGFyZSBjdXJyZW50bHkgYXBwbGllZCBpbiB0aGUgZ3JpZFxyXG4gICAqIEByZXR1cm4gY3VycmVudCBmaWx0ZXJzXHJcbiAgICovXHJcbiAgZ2V0Q3VycmVudEZpbHRlcnMoKTogQ3VycmVudEZpbHRlcltdIHwgbnVsbCB7XHJcbiAgICBpZiAodGhpcy5fZ3JpZE9wdGlvbnMgJiYgdGhpcy5fZ3JpZE9wdGlvbnMuYmFja2VuZFNlcnZpY2VBcGkpIHtcclxuICAgICAgY29uc3QgYmFja2VuZFNlcnZpY2UgPSB0aGlzLl9ncmlkT3B0aW9ucy5iYWNrZW5kU2VydmljZUFwaS5zZXJ2aWNlO1xyXG4gICAgICBpZiAoYmFja2VuZFNlcnZpY2UgJiYgYmFja2VuZFNlcnZpY2UuZ2V0Q3VycmVudEZpbHRlcnMpIHtcclxuICAgICAgICByZXR1cm4gYmFja2VuZFNlcnZpY2UuZ2V0Q3VycmVudEZpbHRlcnMoKSBhcyBDdXJyZW50RmlsdGVyW107XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAodGhpcy5maWx0ZXJTZXJ2aWNlICYmIHRoaXMuZmlsdGVyU2VydmljZS5nZXRDdXJyZW50TG9jYWxGaWx0ZXJzKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmZpbHRlclNlcnZpY2UuZ2V0Q3VycmVudExvY2FsRmlsdGVycygpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgY3VycmVudCBQYWdpbmF0aW9uIChhbmQgaXQncyBzdGF0ZSwgcGFnZU51bWJlciwgcGFnZVNpemUpIHRoYXQgYXJlIGN1cnJlbnRseSBhcHBsaWVkIGluIHRoZSBncmlkXHJcbiAgICogQHJldHVybiBjdXJyZW50IHBhZ2luYXRpb24gc3RhdGVcclxuICAgKi9cclxuICBnZXRDdXJyZW50UGFnaW5hdGlvbigpOiBDdXJyZW50UGFnaW5hdGlvbiB8IG51bGwge1xyXG4gICAgaWYgKHRoaXMuX2dyaWRPcHRpb25zLmVuYWJsZVBhZ2luYXRpb24pIHtcclxuICAgICAgaWYgKHRoaXMuX2dyaWRPcHRpb25zICYmIHRoaXMuX2dyaWRPcHRpb25zLmJhY2tlbmRTZXJ2aWNlQXBpKSB7XHJcbiAgICAgICAgY29uc3QgYmFja2VuZFNlcnZpY2UgPSB0aGlzLl9ncmlkT3B0aW9ucy5iYWNrZW5kU2VydmljZUFwaS5zZXJ2aWNlO1xyXG4gICAgICAgIGlmIChiYWNrZW5kU2VydmljZSAmJiBiYWNrZW5kU2VydmljZS5nZXRDdXJyZW50UGFnaW5hdGlvbikge1xyXG4gICAgICAgICAgcmV0dXJuIGJhY2tlbmRTZXJ2aWNlLmdldEN1cnJlbnRQYWdpbmF0aW9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNoYXJlZFNlcnZpY2UuY3VycmVudFBhZ2luYXRpb247XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHRoZSBjdXJyZW50IFNvcnRlcnMgKGFuZCB0aGVpciBzdGF0ZSwgY29sdW1uSWQsIGRpcmVjdGlvbikgdGhhdCBhcmUgY3VycmVudGx5IGFwcGxpZWQgaW4gdGhlIGdyaWRcclxuICAgKiBAcmV0dXJuIGN1cnJlbnQgc29ydGVyc1xyXG4gICAqL1xyXG4gIGdldEN1cnJlbnRSb3dTZWxlY3Rpb25zKHJlcXVlc3RSZWZyZXNoRmlsdGVyZWRSb3cgPSB0cnVlKTogQ3VycmVudFJvd1NlbGVjdGlvbiB8IG51bGwge1xyXG4gICAgaWYgKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZE9wdGlvbnMgJiYgdGhpcy5fZGF0YVZpZXcgJiYgdGhpcy5oYXNSb3dTZWxlY3Rpb25FbmFibGVkKCkpIHtcclxuICAgICAgaWYgKHRoaXMuX2dyaWQuZ2V0U2VsZWN0ZWRSb3dzICYmIHRoaXMuX2RhdGFWaWV3Lm1hcFJvd3NUb0lkcykge1xyXG4gICAgICAgIGxldCBmaWx0ZXJlZERhdGFDb250ZXh0SWRzOiBBcnJheTxudW1iZXIgfCBzdHJpbmc+IHwgdW5kZWZpbmVkID0gW107XHJcbiAgICAgICAgY29uc3QgZ3JpZFJvd0luZGV4ZXM6IG51bWJlcltdID0gdGhpcy5fZGF0YVZpZXcubWFwSWRzVG9Sb3dzKHRoaXMuX3NlbGVjdGVkUm93RGF0YUNvbnRleHRJZHMgfHwgW10pOyAvLyBub3RlIHRoYXQgdGhpcyB3aWxsIHJldHVybiBvbmx5IHdoYXQgaXMgdmlzaWJsZSBpbiBjdXJyZW50IHBhZ2VcclxuICAgICAgICBjb25zdCBkYXRhQ29udGV4dElkczogQXJyYXk8bnVtYmVyIHwgc3RyaW5nPiB8IHVuZGVmaW5lZCA9IHRoaXMuX3NlbGVjdGVkUm93RGF0YUNvbnRleHRJZHM7XHJcblxyXG4gICAgICAgIC8vIHVzZXIgbWlnaHQgcmVxdWVzdCB0byByZWZyZXNoIHRoZSBmaWx0ZXJlZCBzZWxlY3Rpb24gZGF0YXNldFxyXG4gICAgICAgIC8vIHR5cGljYWxseSBhbHdheXMgVHJ1ZSwgZXhjZXB0IHdoZW4gXCJyZUV2YWx1YXRlUm93U2VsZWN0aW9uQWZ0ZXJGaWx0ZXJDaGFuZ2VcIiBpcyBjYWxsZWQgYW5kIHdlIGRvbid0IG5lZWQgdG8gcmVmcmVzaCB0aGUgZmlsdGVyZWQgZGF0YXNldCB0d2ljZVxyXG4gICAgICAgIGlmIChyZXF1ZXN0UmVmcmVzaEZpbHRlcmVkUm93ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICBmaWx0ZXJlZERhdGFDb250ZXh0SWRzID0gdGhpcy5yZWZyZXNoRmlsdGVyZWRSb3dTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZpbHRlcmVkRGF0YUNvbnRleHRJZHMgPSB0aGlzLl9zZWxlY3RlZEZpbHRlcmVkUm93RGF0YUNvbnRleHRJZHM7XHJcblxyXG4gICAgICAgIHJldHVybiB7IGdyaWRSb3dJbmRleGVzLCBkYXRhQ29udGV4dElkcywgZmlsdGVyZWREYXRhQ29udGV4dElkcyB9O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB0aGUgY3VycmVudCBTb3J0ZXJzIChhbmQgdGhlaXIgc3RhdGUsIGNvbHVtbklkLCBkaXJlY3Rpb24pIHRoYXQgYXJlIGN1cnJlbnRseSBhcHBsaWVkIGluIHRoZSBncmlkXHJcbiAgICogQHJldHVybiBjdXJyZW50IHNvcnRlcnNcclxuICAgKi9cclxuICBnZXRDdXJyZW50U29ydGVycygpOiBDdXJyZW50U29ydGVyW10gfCBudWxsIHtcclxuICAgIGlmICh0aGlzLl9ncmlkT3B0aW9ucyAmJiB0aGlzLl9ncmlkT3B0aW9ucy5iYWNrZW5kU2VydmljZUFwaSkge1xyXG4gICAgICBjb25zdCBiYWNrZW5kU2VydmljZSA9IHRoaXMuX2dyaWRPcHRpb25zLmJhY2tlbmRTZXJ2aWNlQXBpLnNlcnZpY2U7XHJcbiAgICAgIGlmIChiYWNrZW5kU2VydmljZSAmJiBiYWNrZW5kU2VydmljZS5nZXRDdXJyZW50U29ydGVycykge1xyXG4gICAgICAgIHJldHVybiBiYWNrZW5kU2VydmljZS5nZXRDdXJyZW50U29ydGVycygpIGFzIEN1cnJlbnRTb3J0ZXJbXTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmICh0aGlzLnNvcnRTZXJ2aWNlICYmIHRoaXMuc29ydFNlcnZpY2UuZ2V0Q3VycmVudExvY2FsU29ydGVycykge1xyXG4gICAgICByZXR1cm4gdGhpcy5zb3J0U2VydmljZS5nZXRDdXJyZW50TG9jYWxTb3J0ZXJzKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKiBDaGVjayB3aGV0aGVyIHRoZSByb3cgc2VsZWN0aW9uIG5lZWRzIHRvIGJlIHByZXNlcnZlZCAqL1xyXG4gIG5lZWRUb1ByZXNlcnZlUm93U2VsZWN0aW9uKCk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHByZXNlcnZlZFJvd1NlbGVjdGlvbiA9IGZhbHNlO1xyXG4gICAgaWYgKHRoaXMuX2dyaWRPcHRpb25zICYmIHRoaXMuX2dyaWRPcHRpb25zLmRhdGFWaWV3ICYmIHRoaXMuX2dyaWRPcHRpb25zLmRhdGFWaWV3Lmhhc093blByb3BlcnR5KCdzeW5jR3JpZFNlbGVjdGlvbicpKSB7XHJcbiAgICAgIGNvbnN0IHN5bmNHcmlkU2VsZWN0aW9uID0gdGhpcy5fZ3JpZE9wdGlvbnMuZGF0YVZpZXcuc3luY0dyaWRTZWxlY3Rpb247XHJcbiAgICAgIGlmICh0eXBlb2Ygc3luY0dyaWRTZWxlY3Rpb24gPT09ICdib29sZWFuJykge1xyXG4gICAgICAgIHByZXNlcnZlZFJvd1NlbGVjdGlvbiA9IHRoaXMuX2dyaWRPcHRpb25zLmRhdGFWaWV3LnN5bmNHcmlkU2VsZWN0aW9uIGFzIGJvb2xlYW47XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcHJlc2VydmVkUm93U2VsZWN0aW9uID0gc3luY0dyaWRTZWxlY3Rpb24ucHJlc2VydmVIaWRkZW47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGlmIHRoZSByZXN1bHQgaXMgVHJ1ZSBidXQgdGhlIGdyaWQgaXMgdXNpbmcgYSBCYWNrZW5kIFNlcnZpY2UsIHdlIHdpbGwgZG8gYW4gZXh0cmEgZmxhZyBjaGVjayB0aGUgcmVhc29uIGlzIGJlY2F1c2UgaXQgbWlnaHQgaGF2ZSBzb21lIHVuaW50ZW5kZWQgYmVoYXZpb3JzXHJcbiAgICAgIC8vIHdpdGggdGhlIEJhY2tlbmRTZXJ2aWNlQXBpIGJlY2F1c2UgdGVjaG5pY2FsbHkgdGhlIGRhdGEgaW4gdGhlIHBhZ2UgY2hhbmdlcyB0aGUgRGF0YVZpZXcgb24gZXZlcnkgcGFnZS5cclxuICAgICAgaWYgKHByZXNlcnZlZFJvd1NlbGVjdGlvbiAmJiB0aGlzLl9ncmlkT3B0aW9ucy5iYWNrZW5kU2VydmljZUFwaSAmJiB0aGlzLl9ncmlkT3B0aW9ucy5kYXRhVmlldy5oYXNPd25Qcm9wZXJ0eSgnc3luY0dyaWRTZWxlY3Rpb25XaXRoQmFja2VuZFNlcnZpY2UnKSkge1xyXG4gICAgICAgIHByZXNlcnZlZFJvd1NlbGVjdGlvbiA9IHRoaXMuX2dyaWRPcHRpb25zLmRhdGFWaWV3LnN5bmNHcmlkU2VsZWN0aW9uV2l0aEJhY2tlbmRTZXJ2aWNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcHJlc2VydmVkUm93U2VsZWN0aW9uO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRDb2x1bW5zKGNvbHVtbkRlZmluaXRpb25zPzogQ29sdW1uW10pIHtcclxuICAgIGNvbnN0IGNvbHVtbnM6IENvbHVtbltdID0gY29sdW1uRGVmaW5pdGlvbnMgfHwgdGhpcy5fY29sdW1ucztcclxuICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5zOiBDdXJyZW50Q29sdW1uW10gPSB0aGlzLmdldEFzc29jaWF0ZWRDdXJyZW50Q29sdW1ucyhjb2x1bW5zKTtcclxuICAgIHRoaXMub25HcmlkU3RhdGVDaGFuZ2VkLm5leHQoeyBjaGFuZ2U6IHsgbmV3VmFsdWVzOiBjdXJyZW50Q29sdW1ucywgdHlwZTogR3JpZFN0YXRlVHlwZS5jb2x1bW5zIH0sIGdyaWRTdGF0ZTogdGhpcy5nZXRDdXJyZW50R3JpZFN0YXRlKCkgfSk7XHJcbiAgfVxyXG5cclxuICAvKiogaWYgd2UgdXNlIFJvdyBTZWxlY3Rpb24gb3IgdGhlIENoZWNrYm94IFNlbGVjdG9yLCB3ZSBuZWVkIHRvIHJlc2V0IGFueSBzZWxlY3Rpb24gKi9cclxuICByZXNldFJvd1NlbGVjdGlvbldoZW5SZXF1aXJlZCgpIHtcclxuICAgIGlmICghdGhpcy5uZWVkVG9QcmVzZXJ2ZVJvd1NlbGVjdGlvbigpICYmICh0aGlzLl9ncmlkT3B0aW9ucy5lbmFibGVSb3dTZWxlY3Rpb24gfHwgdGhpcy5fZ3JpZE9wdGlvbnMuZW5hYmxlQ2hlY2tib3hTZWxlY3RvcikpIHtcclxuICAgICAgLy8gdGhpcyBhbHNvIHJlcXVpcmVzIHRoZSBSb3cgU2VsZWN0aW9uIE1vZGVsIHRvIGJlIHJlZ2lzdGVyZWQgYXMgd2VsbFxyXG4gICAgICBjb25zdCByb3dTZWxlY3Rpb25FeHRlbnNpb24gPSB0aGlzLmV4dGVuc2lvblNlcnZpY2UgJiYgdGhpcy5leHRlbnNpb25TZXJ2aWNlLmdldEV4dGVuc2lvbkJ5TmFtZSAmJiB0aGlzLmV4dGVuc2lvblNlcnZpY2UuZ2V0RXh0ZW5zaW9uQnlOYW1lKEV4dGVuc2lvbk5hbWUucm93U2VsZWN0aW9uKTtcclxuICAgICAgaWYgKHJvd1NlbGVjdGlvbkV4dGVuc2lvbiAmJiByb3dTZWxlY3Rpb25FeHRlbnNpb24uaW5zdGFuY2UpIHtcclxuICAgICAgICB0aGlzLl9ncmlkLnNldFNlbGVjdGVkUm93cyhbXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN1YnNjcmliZSB0byBhbGwgbmVjZXNzYXJ5IFNsaWNrR3JpZCBvciBTZXJ2aWNlIEV2ZW50cyB0aGF0IGRlYWxzIHdpdGggYSBHcmlkIGNoYW5nZSxcclxuICAgKiB3aGVuIHRyaWdnZXJlZCwgd2Ugd2lsbCBwdWJsaXNoIGEgR3JpZCBTdGF0ZSBFdmVudCB3aXRoIGN1cnJlbnQgR3JpZCBTdGF0ZVxyXG4gICAqL1xyXG4gIHN1YnNjcmliZVRvQWxsR3JpZENoYW5nZXMoZ3JpZDogYW55KSB7XHJcbiAgICAvLyBTdWJzY3JpYmUgdG8gRXZlbnQgRW1pdHRlciBvZiBGaWx0ZXIgY2hhbmdlZFxyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKFxyXG4gICAgICB0aGlzLmZpbHRlclNlcnZpY2Uub25GaWx0ZXJDaGFuZ2VkLnN1YnNjcmliZSgoY3VycmVudEZpbHRlcnM6IEN1cnJlbnRGaWx0ZXJbXSkgPT4ge1xyXG4gICAgICAgIHRoaXMucmVzZXRSb3dTZWxlY3Rpb25XaGVuUmVxdWlyZWQoKTtcclxuXHJcbiAgICAgICAgLy8gdHJpZ2dlciBhIEdyaWQgU3RhdGUgZmlsdGVyIGNoYW5nZSwgaG93ZXZlciBkb24ndCByZWV2YWx1YXRlIHRoZSBmaWx0ZXJlZCByb3cgc2VsZWN0aW9ucywgd2UnbGwgZG8gdGhhdCBvbiB0aGUgbmV4dCBHcmlkIFN0YXRlIGNoYW5nZSBiZWxvd1xyXG4gICAgICAgIHRoaXMub25HcmlkU3RhdGVDaGFuZ2VkLm5leHQoeyBjaGFuZ2U6IHsgbmV3VmFsdWVzOiBjdXJyZW50RmlsdGVycywgdHlwZTogR3JpZFN0YXRlVHlwZS5maWx0ZXIgfSwgZ3JpZFN0YXRlOiB0aGlzLmdldEN1cnJlbnRHcmlkU3RhdGUoeyByZXF1ZXN0UmVmcmVzaFJvd0ZpbHRlcmVkUm93OiAhdGhpcy5oYXNSb3dTZWxlY3Rpb25FbmFibGVkKCkgfSkgfSk7XHJcblxyXG4gICAgICAgIC8vIHdoZW4gUm93IFNlbGVjdGlvbiBpcyBlbmFibGVkLCB3ZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgdGhlIHJvdyBzZWxlY3Rpb24gd2l0aCB0aGUgbGVmdG92ZXIgZmlsdGVyZWQgZGF0YXNldFxyXG4gICAgICAgIGlmICh0aGlzLmhhc1Jvd1NlbGVjdGlvbkVuYWJsZWQoKSkge1xyXG4gICAgICAgICAgdGhpcy5yZUV2YWx1YXRlUm93U2VsZWN0aW9uQWZ0ZXJGaWx0ZXJDaGFuZ2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vIFN1YnNjcmliZSB0byBFdmVudCBFbWl0dGVyIG9mIEZpbHRlciBjbGVhcmVkXHJcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLnB1c2goXHJcbiAgICAgIHRoaXMuZmlsdGVyU2VydmljZS5vbkZpbHRlckNsZWFyZWQuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICB0aGlzLnJlc2V0Um93U2VsZWN0aW9uV2hlblJlcXVpcmVkKCk7XHJcbiAgICAgICAgdGhpcy5vbkdyaWRTdGF0ZUNoYW5nZWQubmV4dCh7IGNoYW5nZTogeyBuZXdWYWx1ZXM6IFtdLCB0eXBlOiBHcmlkU3RhdGVUeXBlLmZpbHRlciB9LCBncmlkU3RhdGU6IHRoaXMuZ2V0Q3VycmVudEdyaWRTdGF0ZSgpIH0pO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBTdWJzY3JpYmUgdG8gRXZlbnQgRW1pdHRlciBvZiBTb3J0IGNoYW5nZWRcclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChcclxuICAgICAgdGhpcy5zb3J0U2VydmljZS5vblNvcnRDaGFuZ2VkLnN1YnNjcmliZSgoY3VycmVudFNvcnRlcnM6IEN1cnJlbnRTb3J0ZXJbXSkgPT4ge1xyXG4gICAgICAgIHRoaXMucmVzZXRSb3dTZWxlY3Rpb25XaGVuUmVxdWlyZWQoKTtcclxuICAgICAgICB0aGlzLm9uR3JpZFN0YXRlQ2hhbmdlZC5uZXh0KHsgY2hhbmdlOiB7IG5ld1ZhbHVlczogY3VycmVudFNvcnRlcnMsIHR5cGU6IEdyaWRTdGF0ZVR5cGUuc29ydGVyIH0sIGdyaWRTdGF0ZTogdGhpcy5nZXRDdXJyZW50R3JpZFN0YXRlKCkgfSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vIFN1YnNjcmliZSB0byBFdmVudCBFbWl0dGVyIG9mIFNvcnQgY2xlYXJlZFxyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKFxyXG4gICAgICB0aGlzLnNvcnRTZXJ2aWNlLm9uU29ydENsZWFyZWQuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICB0aGlzLnJlc2V0Um93U2VsZWN0aW9uV2hlblJlcXVpcmVkKCk7XHJcbiAgICAgICAgdGhpcy5vbkdyaWRTdGF0ZUNoYW5nZWQubmV4dCh7IGNoYW5nZTogeyBuZXdWYWx1ZXM6IFtdLCB0eXBlOiBHcmlkU3RhdGVUeXBlLnNvcnRlciB9LCBncmlkU3RhdGU6IHRoaXMuZ2V0Q3VycmVudEdyaWRTdGF0ZSgpIH0pO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBTdWJzY3JpYmUgdG8gQ29sdW1uUGlja2VyIGFuZC9vciBHcmlkTWVudSBmb3Igc2hvdy9oaWRlIENvbHVtbnMgdmlzaWJpbGl0eSBjaGFuZ2VzXHJcbiAgICB0aGlzLmJpbmRFeHRlbnNpb25BZGRvbkV2ZW50VG9HcmlkU3RhdGVDaGFuZ2UoRXh0ZW5zaW9uTmFtZS5jb2x1bW5QaWNrZXIsICdvbkNvbHVtbnNDaGFuZ2VkJyk7XHJcbiAgICB0aGlzLmJpbmRFeHRlbnNpb25BZGRvbkV2ZW50VG9HcmlkU3RhdGVDaGFuZ2UoRXh0ZW5zaW9uTmFtZS5ncmlkTWVudSwgJ29uQ29sdW1uc0NoYW5nZWQnKTtcclxuXHJcbiAgICAvLyBzdWJzY3JpYmUgdG8gQ29sdW1uIFJlc2l6ZSAmIFJlb3JkZXJpbmdcclxuICAgIHRoaXMuYmluZFNsaWNrR3JpZENvbHVtbkNoYW5nZUV2ZW50VG9HcmlkU3RhdGVDaGFuZ2UoJ29uQ29sdW1uc1Jlb3JkZXJlZCcsIGdyaWQpO1xyXG4gICAgdGhpcy5iaW5kU2xpY2tHcmlkQ29sdW1uQ2hhbmdlRXZlbnRUb0dyaWRTdGF0ZUNoYW5nZSgnb25Db2x1bW5zUmVzaXplZCcsIGdyaWQpO1xyXG5cclxuICAgIC8vIHN1YnNjcmliZSB0byBSb3cgU2VsZWN0aW9uIGNoYW5nZXMgKHdoZW4gZW5hYmxlZClcclxuICAgIGlmICh0aGlzLl9ncmlkT3B0aW9ucy5lbmFibGVSb3dTZWxlY3Rpb24gfHwgdGhpcy5fZ3JpZE9wdGlvbnMuZW5hYmxlQ2hlY2tib3hTZWxlY3Rvcikge1xyXG4gICAgICB0aGlzLmJpbmRTbGlja0dyaWRSb3dTZWxlY3Rpb25Ub0dyaWRTdGF0ZUNoYW5nZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHN1YnNjcmliZSB0byBIZWFkZXJNZW51IChoaWRlIGNvbHVtbilcclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLm9uQ29sdW1uc0NoYW5nZWQuc3Vic2NyaWJlKCh2aXNpYmxlQ29sdW1uczogQ29sdW1uW10pID0+IHtcclxuICAgICAgICBjb25zdCBjdXJyZW50Q29sdW1uczogQ3VycmVudENvbHVtbltdID0gdGhpcy5nZXRBc3NvY2lhdGVkQ3VycmVudENvbHVtbnModmlzaWJsZUNvbHVtbnMpO1xyXG4gICAgICAgIHRoaXMub25HcmlkU3RhdGVDaGFuZ2VkLm5leHQoeyBjaGFuZ2U6IHsgbmV3VmFsdWVzOiBjdXJyZW50Q29sdW1ucywgdHlwZTogR3JpZFN0YXRlVHlwZS5jb2x1bW5zIH0sIGdyaWRTdGF0ZTogdGhpcy5nZXRDdXJyZW50R3JpZFN0YXRlKCkgfSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gLS1cclxuICAvLyBwcml2YXRlIG1ldGhvZHNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgLyoqXHJcbiAgICogQmluZCBhIFNsaWNrR3JpZCBFeHRlbnNpb24gRXZlbnQgdG8gYSBHcmlkIFN0YXRlIGNoYW5nZSBldmVudFxyXG4gICAqIEBwYXJhbSBleHRlbnNpb24gbmFtZVxyXG4gICAqIEBwYXJhbSBncmlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBiaW5kRXh0ZW5zaW9uQWRkb25FdmVudFRvR3JpZFN0YXRlQ2hhbmdlKGV4dGVuc2lvbk5hbWU6IEV4dGVuc2lvbk5hbWUsIGV2ZW50TmFtZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBleHRlbnNpb24gPSB0aGlzLmV4dGVuc2lvblNlcnZpY2UgJiYgdGhpcy5leHRlbnNpb25TZXJ2aWNlLmdldEV4dGVuc2lvbkJ5TmFtZSAmJiB0aGlzLmV4dGVuc2lvblNlcnZpY2UuZ2V0RXh0ZW5zaW9uQnlOYW1lKGV4dGVuc2lvbk5hbWUpO1xyXG4gICAgY29uc3Qgc2xpY2tFdmVudCA9IGV4dGVuc2lvbiAmJiBleHRlbnNpb24uaW5zdGFuY2UgJiYgZXh0ZW5zaW9uLmluc3RhbmNlW2V2ZW50TmFtZV07XHJcblxyXG4gICAgaWYgKHNsaWNrRXZlbnQgJiYgc2xpY2tFdmVudC5zdWJzY3JpYmUpIHtcclxuICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZShzbGlja0V2ZW50LCAoZTogRXZlbnQsIGFyZ3M6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbnM6IENvbHVtbltdID0gYXJncyAmJiBhcmdzLmNvbHVtbnM7XHJcbiAgICAgICAgY29uc3QgY3VycmVudENvbHVtbnM6IEN1cnJlbnRDb2x1bW5bXSA9IHRoaXMuZ2V0QXNzb2NpYXRlZEN1cnJlbnRDb2x1bW5zKGNvbHVtbnMpO1xyXG4gICAgICAgIHRoaXMub25HcmlkU3RhdGVDaGFuZ2VkLm5leHQoeyBjaGFuZ2U6IHsgbmV3VmFsdWVzOiBjdXJyZW50Q29sdW1ucywgdHlwZTogR3JpZFN0YXRlVHlwZS5jb2x1bW5zIH0sIGdyaWRTdGF0ZTogdGhpcy5nZXRDdXJyZW50R3JpZFN0YXRlKCkgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQmluZCBhIEdyaWQgRXZlbnQgKG9mIENvbHVtbiBjaGFuZ2VzKSB0byBhIEdyaWQgU3RhdGUgY2hhbmdlIGV2ZW50XHJcbiAgICogQHBhcmFtIGV2ZW50IG5hbWVcclxuICAgKiBAcGFyYW0gZ3JpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmluZFNsaWNrR3JpZENvbHVtbkNoYW5nZUV2ZW50VG9HcmlkU3RhdGVDaGFuZ2UoZXZlbnROYW1lOiBzdHJpbmcsIGdyaWQ6IGFueSkge1xyXG4gICAgY29uc3Qgc2xpY2tHcmlkRXZlbnQgPSBncmlkICYmIGdyaWRbZXZlbnROYW1lXTtcclxuXHJcbiAgICBpZiAoc2xpY2tHcmlkRXZlbnQgJiYgc2xpY2tHcmlkRXZlbnQuc3Vic2NyaWJlKSB7XHJcbiAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUoc2xpY2tHcmlkRXZlbnQsICgpID0+IHtcclxuICAgICAgICBjb25zdCBjb2x1bW5zOiBDb2x1bW5bXSA9IGdyaWQuZ2V0Q29sdW1ucygpO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5zOiBDdXJyZW50Q29sdW1uW10gPSB0aGlzLmdldEFzc29jaWF0ZWRDdXJyZW50Q29sdW1ucyhjb2x1bW5zKTtcclxuICAgICAgICB0aGlzLm9uR3JpZFN0YXRlQ2hhbmdlZC5uZXh0KHsgY2hhbmdlOiB7IG5ld1ZhbHVlczogY3VycmVudENvbHVtbnMsIHR5cGU6IEdyaWRTdGF0ZVR5cGUuY29sdW1ucyB9LCBncmlkU3RhdGU6IHRoaXMuZ2V0Q3VycmVudEdyaWRTdGF0ZSgpIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJpbmQgYSBHcmlkIEV2ZW50IG9mIFJvdyBTZWxlY3Rpb24gY2hhbmdlIHRvIGEgR3JpZCBTdGF0ZSBjaGFuZ2UgZXZlbnRcclxuICAgKiBGb3IgdGhlIHJvdyBzZWxlY3Rpb24sIHdlIGNhbid0IGp1c3QgdXNlIHRoZSBnZXRTZWxlY3RlZFJvd3MoKSBzaW5jZSB0aGlzIHdpbGwgb25seSByZXR1cm4gdGhlIHZpc2libGUgcm93cyBzaG93biBpbiB0aGUgVUkgd2hpY2ggaXMgbm90IGVub3VnaC5cclxuICAgKiBUaGUgcHJvY2VzcyBpcyBtdWNoIG1vcmUgY29tcGxleCwgd2hhdCB3ZSBoYXZlIHRvIGRvIGluc3RlYWQgaXMgdGhlIGZvbGxvd2luZ1xyXG4gICAqIDEuIHdoZW4gY2hhbmdpbmcgYSByb3cgc2VsZWN0aW9uLCB3ZSdsbCBhZGQgdGhlIG5ldyBzZWxlY3Rpb24gaWYgaXQncyBub3QgeWV0IGluIHRoZSBnbG9iYWwgYXJyYXkgb2Ygc2VsZWN0ZWQgSURzXHJcbiAgICogMi4gd2hlbiBkZWxldGluZyBhIHJvdyBzZWxlY3Rpb24sIHdlJ2xsIHJlbW92ZSB0aGUgc2VsZWN0aW9uIGZyb20gb3VyIGdsb2JhbCBhcnJheSBvZiBzZWxlY3RlZCBJRHMgKHVubGVzcyBpdCBjYW1lIGZyb20gYSBwYWdlIGNoYW5nZSlcclxuICAgKiAzLiBpZiB3ZSB1c2UgUGFnaW5hdGlvbiBhbmQgd2UgY2hhbmdlIHBhZ2UsIHdlJ2xsIGtlZXAgdHJhY2sgd2l0aCBhIGZsYWcgKHRoaXMgZmxhZyB3aWxsIGJlIHVzZWQgdG8gc2tpcCBhbnkgZGVsZXRpb24gd2hlbiB3ZSdyZSBjaGFuZ2luZyBwYWdlKVxyXG4gICAqIDQuIGFmdGVyIHRoZSBQYWdlIG9yIERhdGFWaWV3IGlzIGNoYW5nZWQgb3IgdXBkYXRlZCwgd2UnbGwgZG8gYW4gZXh0cmEgKGFuZCBkZWxheWVkKSBjaGVjayB0byBtYWtlIHN1cmUgdGhhdCB3aGF0IHdlIGhhdmUgaW4gb3VyIGdsb2JhbCBhcnJheSBvZiBzZWxlY3RlZCBJRHMgaXMgZGlzcGxheWVkIG9uIHNjcmVlblxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmluZFNsaWNrR3JpZFJvd1NlbGVjdGlvblRvR3JpZFN0YXRlQ2hhbmdlKCkge1xyXG4gICAgaWYgKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZE9wdGlvbnMgJiYgdGhpcy5fZGF0YVZpZXcpIHtcclxuICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9kYXRhVmlldy5vbkJlZm9yZVBhZ2luZ0luZm9DaGFuZ2VkLCAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fd2FzUmVjaGVja2VkQWZ0ZXJQYWdlQ2hhbmdlID0gZmFsc2U7IC8vIHJlc2V0IHRoZSBwYWdlIGNoZWNrIGZsYWcsIHRvIHNraXAgZGVsZXRpb25zIG9uIHBhZ2UgY2hhbmdlICh1c2VkIGluIGNvZGUgYmVsb3cpXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9kYXRhVmlldy5vblBhZ2luZ0luZm9DaGFuZ2VkLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gd2hlbiB1c2VyIGNoYW5nZXMgcGFnZSwgdGhlIHNlbGVjdGVkIHJvdyBpbmRleGVzIG1pZ2h0IG5vdCBzaG93IHVwXHJcbiAgICAgICAgLy8gd2UgY2FuIGNoZWNrIHRvIG1ha2Ugc3VyZSBpdCBpcyBidXQgaXQgaGFzIHRvIGJlIGluIGEgZGVsYXkgc28gaXQgaGFwcGVucyBhZnRlciB0aGUgZmlyc3QgXCJvblNlbGVjdGVkUm93c0NoYW5nZWRcIiBpcyB0cmlnZ2VyZWRcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHNob3VsZEJlU2VsZWN0ZWRSb3dJbmRleGVzID0gdGhpcy5fZGF0YVZpZXcubWFwSWRzVG9Sb3dzKHRoaXMuX3NlbGVjdGVkUm93RGF0YUNvbnRleHRJZHMgfHwgW10pO1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudFNlbGVjdGVkUm93SW5kZXhlcyA9IHRoaXMuX2dyaWQuZ2V0U2VsZWN0ZWRSb3dzKCk7XHJcbiAgICAgICAgICBpZiAoIWlzZXF1YWwoc2hvdWxkQmVTZWxlY3RlZFJvd0luZGV4ZXMsIGN1cnJlbnRTZWxlY3RlZFJvd0luZGV4ZXMpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2dyaWQuc2V0U2VsZWN0ZWRSb3dzKHNob3VsZEJlU2VsZWN0ZWRSb3dJbmRleGVzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2dyaWQub25TZWxlY3RlZFJvd3NDaGFuZ2VkLCAoZSwgYXJncykgPT4ge1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFyZ3Mucm93cykgJiYgQXJyYXkuaXNBcnJheShhcmdzLnByZXZpb3VzU2VsZWN0ZWRSb3dzKSkge1xyXG4gICAgICAgICAgY29uc3QgbmV3U2VsZWN0ZWRSb3dzID0gYXJncy5yb3dzIGFzIG51bWJlcltdO1xyXG4gICAgICAgICAgY29uc3QgcHJldlNlbGVjdGVkUm93cyA9IGFyZ3MucHJldmlvdXNTZWxlY3RlZFJvd3MgYXMgbnVtYmVyW107XHJcblxyXG4gICAgICAgICAgY29uc3QgbmV3U2VsZWN0ZWRBZGRpdGlvbnMgPSBuZXdTZWxlY3RlZFJvd3MuZmlsdGVyKChpKSA9PiBwcmV2U2VsZWN0ZWRSb3dzLmluZGV4T2YoaSkgPCAwKTtcclxuICAgICAgICAgIGNvbnN0IG5ld1NlbGVjdGVkRGVsZXRpb25zID0gcHJldlNlbGVjdGVkUm93cy5maWx0ZXIoKGkpID0+IG5ld1NlbGVjdGVkUm93cy5pbmRleE9mKGkpIDwgMCk7XHJcblxyXG4gICAgICAgICAgLy8gZGVsZXRpb24gbWlnaHQgaGFwcGVuIHdoZW4gdXNlciBpcyBjaGFuZ2luZyBwYWdlLCBpZiB0aGF0IGlzIHRoZSBjYXNlIHRoZW4gc2tpcCB0aGUgZGVsZXRpb24gc2luY2UgaXQncyBvbmx5IGEgdmlzdWFsIGRlbGV0aW9uIChjdXJyZW50IHBhZ2UpXHJcbiAgICAgICAgICAvLyBpZiBpdCdzIG5vdCBhIHBhZ2UgY2hhbmdlICh3aGVuIHRoZSBmbGFnIGlzIHRydWUpLCB0aGVuIHByb2NlZWQgd2l0aCB0aGUgZGVsZXRpb24gaW4gb3VyIGdsb2JhbCBhcnJheSBvZiBzZWxlY3RlZCBJRHNcclxuICAgICAgICAgIGlmICh0aGlzLl93YXNSZWNoZWNrZWRBZnRlclBhZ2VDaGFuZ2UgJiYgbmV3U2VsZWN0ZWREZWxldGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCB0b0RlbGV0ZURhdGFJZHM6IEFycmF5PG51bWJlciB8IHN0cmluZz4gfCB1bmRlZmluZWQgPSB0aGlzLl9kYXRhVmlldy5tYXBSb3dzVG9JZHMobmV3U2VsZWN0ZWREZWxldGlvbnMpIHx8IFtdO1xyXG4gICAgICAgICAgICB0b0RlbGV0ZURhdGFJZHMuZm9yRWFjaCgocmVtb3ZlSWQ6IG51bWJlciB8IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGVkUm93RGF0YUNvbnRleHRJZHMuc3BsaWNlKCh0aGlzLl9zZWxlY3RlZFJvd0RhdGFDb250ZXh0SWRzIGFzIEFycmF5PG51bWJlciB8IHN0cmluZz4gfCB1bmRlZmluZWQpLmluZGV4T2YocmVtb3ZlSWQpLCAxKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgLy8gaWYgd2UgaGF2ZSBuZXdseSBhZGRlZCBzZWxlY3RlZCByb3cocyksIGxldCdzIHVwZGF0ZSBvdXIgZ2xvYmFsIGFycmF5IG9mIHNlbGVjdGVkIElEc1xyXG4gICAgICAgICAgaWYgKG5ld1NlbGVjdGVkQWRkaXRpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgdG9BZGREYXRhSWRzOiBBcnJheTxudW1iZXIgfCBzdHJpbmc+IHwgdW5kZWZpbmVkID0gdGhpcy5fZGF0YVZpZXcubWFwUm93c1RvSWRzKG5ld1NlbGVjdGVkQWRkaXRpb25zKSB8fCBbXTtcclxuICAgICAgICAgICAgdG9BZGREYXRhSWRzLmZvckVhY2goKGRhdGFJZDogbnVtYmVyIHwgc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKCh0aGlzLl9zZWxlY3RlZFJvd0RhdGFDb250ZXh0SWRzIGFzIEFycmF5PG51bWJlciB8IHN0cmluZz4gfCB1bmRlZmluZWQpLmluZGV4T2YoZGF0YUlkKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICh0aGlzLl9zZWxlY3RlZFJvd0RhdGFDb250ZXh0SWRzIGFzIEFycmF5PG51bWJlciB8IHN0cmluZz4gfCB1bmRlZmluZWQpLnB1c2goZGF0YUlkKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIHdlIHNldCB0aGlzIGZsYWcgd2hpY2ggd2lsbCBiZSB1c2VkIG9uIHRoZSAybmQgdGltZSB0aGUgXCJvblNlbGVjdGVkUm93c0NoYW5nZWRcIiBldmVudCBpcyBjYWxsZWRcclxuICAgICAgICAgIC8vIHdoZW4gaXQncyB0aGUgZmlyc3QgdGltZSwgd2Ugc2tpcCBkZWxldGlvbiBhbmQgdGhpcyBpcyB3aGF0IHRoaXMgZmxhZyBpcyBmb3JcclxuICAgICAgICAgIHRoaXMuX3dhc1JlY2hlY2tlZEFmdGVyUGFnZUNoYW5nZSA9IHRydWU7XHJcblxyXG4gICAgICAgICAgLy8gZm9ybSBvdXIgZnVsbCBzZWxlY3RlZCByb3cgSURzLCBsZXQncyBtYWtlIHN1cmUgdGhlc2UgaW5kZXhlcyBhcmUgc2VsZWN0ZWQgaW4gdGhlIGdyaWQsIGlmIG5vdCB0aGVuIGxldCdzIGNhbGwgYSByZXNlbGVjdFxyXG4gICAgICAgICAgLy8gdGhpcyBjb3VsZCBoYXBwZW4gaWYgdGhlIHByZXZpb3VzIHN0ZXAgd2FzIGEgcGFnZSBjaGFuZ2VcclxuICAgICAgICAgIGNvbnN0IHNob3VsZEJlU2VsZWN0ZWRSb3dJbmRleGVzID0gdGhpcy5fZGF0YVZpZXcubWFwSWRzVG9Sb3dzKHRoaXMuX3NlbGVjdGVkUm93RGF0YUNvbnRleHRJZHMgfHwgW10pO1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudFNlbGVjdGVkUm93SW5kZXhlcyA9IHRoaXMuX2dyaWQuZ2V0U2VsZWN0ZWRSb3dzKCk7XHJcbiAgICAgICAgICBpZiAoIWlzZXF1YWwoc2hvdWxkQmVTZWxlY3RlZFJvd0luZGV4ZXMsIGN1cnJlbnRTZWxlY3RlZFJvd0luZGV4ZXMpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2dyaWQuc2V0U2VsZWN0ZWRSb3dzKHNob3VsZEJlU2VsZWN0ZWRSb3dJbmRleGVzKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBjb25zdCBmaWx0ZXJlZERhdGFDb250ZXh0SWRzID0gdGhpcy5yZWZyZXNoRmlsdGVyZWRSb3dTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgICBjb25zdCBuZXdWYWx1ZXMgPSB7IGdyaWRSb3dJbmRleGVzOiB0aGlzLl9ncmlkLmdldFNlbGVjdGVkUm93cygpLCBkYXRhQ29udGV4dElkczogdGhpcy5fc2VsZWN0ZWRSb3dEYXRhQ29udGV4dElkcywgZmlsdGVyZWREYXRhQ29udGV4dElkcyB9IGFzIEN1cnJlbnRSb3dTZWxlY3Rpb247XHJcbiAgICAgICAgICB0aGlzLm9uR3JpZFN0YXRlQ2hhbmdlZC5uZXh0KHsgY2hhbmdlOiB7IG5ld1ZhbHVlcywgdHlwZTogR3JpZFN0YXRlVHlwZS5yb3dTZWxlY3Rpb24gfSwgZ3JpZFN0YXRlOiB0aGlzLmdldEN1cnJlbnRHcmlkU3RhdGUoKSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIENoZWNrIHdldGhlciB0aGUgZ3JpZCBoYXMgdGhlIFJvdyBTZWxlY3Rpb24gZW5hYmxlZCAqL1xyXG4gIHByaXZhdGUgaGFzUm93U2VsZWN0aW9uRW5hYmxlZCgpIHtcclxuICAgIGNvbnN0IHNlbGVjdGlvbk1vZGVsID0gdGhpcy5fZ3JpZC5nZXRTZWxlY3Rpb25Nb2RlbCgpO1xyXG4gICAgY29uc3QgaXNSb3dTZWxlY3Rpb25FbmFibGVkID0gdGhpcy5fZ3JpZE9wdGlvbnMuZW5hYmxlUm93U2VsZWN0aW9uIHx8IHRoaXMuX2dyaWRPcHRpb25zLmVuYWJsZUNoZWNrYm94U2VsZWN0b3I7XHJcbiAgICByZXR1cm4gKGlzUm93U2VsZWN0aW9uRW5hYmxlZCAmJiBzZWxlY3Rpb25Nb2RlbCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlRXZhbHVhdGVSb3dTZWxlY3Rpb25BZnRlckZpbHRlckNoYW5nZSgpIHtcclxuICAgIGNvbnN0IGN1cnJlbnRTZWxlY3RlZFJvd0luZGV4ZXMgPSB0aGlzLl9ncmlkLmdldFNlbGVjdGVkUm93cygpO1xyXG4gICAgY29uc3QgcHJldmlvdXNTZWxlY3RlZEZpbHRlcmVkUm93RGF0YUNvbnRleHRJZHMgPSB0aGlzLl9zZWxlY3RlZEZpbHRlcmVkUm93RGF0YUNvbnRleHRJZHMuc2xpY2UoKTtcclxuICAgIGNvbnN0IGZpbHRlcmVkRGF0YUNvbnRleHRJZHMgPSB0aGlzLnJlZnJlc2hGaWx0ZXJlZFJvd1NlbGVjdGlvbnMoKTtcclxuXHJcbiAgICAvLyB3aGVuIHNlbGVjdGlvbiBjaGFuZ2VkLCB3ZSdsbCBzZW5kIGEgR3JpZCBTdGF0ZSBldmVudCB3aXRoIHRoZSBzZWxlY3Rpb24gY2hhbmdlc1xyXG4gICAgaWYgKCFpc2VxdWFsKHRoaXMuX3NlbGVjdGVkRmlsdGVyZWRSb3dEYXRhQ29udGV4dElkcywgcHJldmlvdXNTZWxlY3RlZEZpbHRlcmVkUm93RGF0YUNvbnRleHRJZHMpKSB7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IHsgZ3JpZFJvd0luZGV4ZXM6IGN1cnJlbnRTZWxlY3RlZFJvd0luZGV4ZXMsIGRhdGFDb250ZXh0SWRzOiB0aGlzLl9zZWxlY3RlZFJvd0RhdGFDb250ZXh0SWRzLCBmaWx0ZXJlZERhdGFDb250ZXh0SWRzIH0gYXMgQ3VycmVudFJvd1NlbGVjdGlvbjtcclxuICAgICAgdGhpcy5vbkdyaWRTdGF0ZUNoYW5nZWQubmV4dCh7IGNoYW5nZTogeyBuZXdWYWx1ZXMsIHR5cGU6IEdyaWRTdGF0ZVR5cGUucm93U2VsZWN0aW9uIH0sIGdyaWRTdGF0ZTogdGhpcy5nZXRDdXJyZW50R3JpZFN0YXRlKHsgcmVxdWVzdFJlZnJlc2hSb3dGaWx0ZXJlZFJvdzogZmFsc2UgfSkgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiogV2hlbiBhIEZpbHRlciBpcyB0cmlnZ2VyZWQgb3Igd2hlbiB1c2VyIHJlcXVlc3QgaXQsIHdlIHdpbGwgcmVmcmVzaCB0aGUgZmlsdGVyZWQgc2VsZWN0aW9uIGFycmF5IGFuZCByZXR1cm4gaXQgKi9cclxuICBwcml2YXRlIHJlZnJlc2hGaWx0ZXJlZFJvd1NlbGVjdGlvbnMoKTogQXJyYXk8bnVtYmVyIHwgc3RyaW5nPiB8IHVuZGVmaW5lZCB7XHJcbiAgICBsZXQgdG1wRmlsdGVyZWRBcnJheSA9IFtdO1xyXG4gICAgY29uc3QgZmlsdGVyZWREYXRhc2V0ID0gdGhpcy5fZGF0YVZpZXcuZ2V0RmlsdGVyZWRJdGVtcygpIHx8IFtdO1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5fc2VsZWN0ZWRSb3dEYXRhQ29udGV4dElkcykpIHtcclxuICAgICAgY29uc3Qgc2VsZWN0ZWRGaWx0ZXJlZFJvd0RhdGFDb250ZXh0SWRzID0gWy4uLnRoaXMuX3NlbGVjdGVkUm93RGF0YUNvbnRleHRJZHNdOyAvLyB0YWtlIGEgZnJlc2ggY29weSBvZiBhbGwgc2VsZWN0aW9ucyBiZWZvcmUgZmlsdGVyaW5nIHRoZSByb3cgaWRzXHJcbiAgICAgIHRtcEZpbHRlcmVkQXJyYXkgPSBzZWxlY3RlZEZpbHRlcmVkUm93RGF0YUNvbnRleHRJZHMuZmlsdGVyKChzZWxlY3RlZFJvd0lkOiBudW1iZXIgfCBzdHJpbmcpID0+IHtcclxuICAgICAgICByZXR1cm4gZmlsdGVyZWREYXRhc2V0LmZpbmRJbmRleCgoaXRlbTogYW55KSA9PiBpdGVtW3RoaXMuZGF0YXNldElkUHJvcE5hbWVdID09PSBzZWxlY3RlZFJvd0lkKSA+IC0xO1xyXG4gICAgICB9KTtcclxuICAgICAgdGhpcy5fc2VsZWN0ZWRGaWx0ZXJlZFJvd0RhdGFDb250ZXh0SWRzID0gdG1wRmlsdGVyZWRBcnJheTtcclxuICAgIH1cclxuICAgIHJldHVybiB0bXBGaWx0ZXJlZEFycmF5O1xyXG4gIH1cclxufVxyXG4iXX0=