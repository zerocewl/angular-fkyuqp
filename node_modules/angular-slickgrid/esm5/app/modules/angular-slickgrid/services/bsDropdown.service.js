import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { AngularUtilService } from './angularUtil.service';
// Boostrap dropdown service
var BsDropDownService = /** @class */ (function () {
    function BsDropDownService(angularUtilService) {
        this.angularUtilService = angularUtilService;
    }
    Object.defineProperty(BsDropDownService.prototype, "domElement", {
        get: function () {
            return this._domElement;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BsDropDownService.prototype, "domContainerElement", {
        get: function () {
            return this._domContainerElement;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BsDropDownService.prototype, "gridViewport", {
        get: function () {
            return $('.slick-viewport');
        },
        enumerable: true,
        configurable: true
    });
    BsDropDownService.prototype.dispose = function () {
        if (this._domElement && this._domElement.remove) {
            this._domElement.remove();
        }
    };
    BsDropDownService.prototype.dropContainerShow = function () {
        if (this._domContainerElement && this._domContainerElement.show) {
            this._domContainerElement.show();
        }
    };
    BsDropDownService.prototype.render = function (dropdownParams) {
        var _this = this;
        return new Promise(function (resolve) {
            var component = dropdownParams.component, args = dropdownParams.args, parent = dropdownParams.parent, offsetTop = dropdownParams.offsetTop, offsetLeft = dropdownParams.offsetLeft, offsetDropupBottom = dropdownParams.offsetDropupBottom;
            var cell = args.cell;
            var row = args.row;
            _this._domContainerElement = $("#myDrop-r" + row + "-c" + cell);
            if (_this._domContainerElement) {
                // hide the dropdown we created as a formatter Component, we'll redisplay it later
                var cellPos_1 = _this._domContainerElement.offset();
                var componentOutput_1 = _this.angularUtilService.createAngularComponent(component);
                var componentInstance = componentOutput_1 && componentOutput_1.componentRef && componentOutput_1.componentRef.instance;
                if (componentInstance) {
                    var myDropId_1 = componentInstance.dropdownId || 'myDrop';
                    var dropDownToggleId_1 = componentInstance.dropDownToggleId || 'dropdownMenu1';
                    _this._domElement = $("#" + myDropId_1);
                    if (_this._domElement) {
                        // make sure to remove any previous Action dropdown elements, to avoid having multiple element of the same on top of each other
                        _this.dispose();
                        // assign the row data to the dropdown component instance
                        Object.assign(componentInstance, { parent: parent, row: args.row, dataContext: args.grid.getDataItem(args.row) });
                        // use a delay to make sure Angular ran at least a full cycle and make sure it finished rendering the Component before using it
                        setTimeout(function () {
                            // create a new dropdown element
                            _this._domElement = $(componentOutput_1.domElement);
                            var topPos = (cellPos_1 && cellPos_1.top || 0) + 30 + (offsetTop || 0);
                            var leftPos = (cellPos_1 && cellPos_1.left || 0) + (offsetLeft || 0);
                            _this._domElement.appendTo('body');
                            _this._domElement.css('position', 'absolute');
                            _this._domElement.css('top', topPos);
                            _this._domElement.css('left', leftPos);
                            $("#" + myDropId_1).addClass('open');
                            $("#" + dropDownToggleId_1).hide();
                            // check if it should drop Up or Down
                            var offset = 35;
                            var iElement = $('.dropdown-menu');
                            var iElementWrapper = iElement.parent();
                            var iElementWrapperOffset = iElementWrapper.offset() || {};
                            var iElementWrapperOffsetTop = iElementWrapperOffset.top || iElementWrapper && iElementWrapper.length > 0 && iElementWrapper[0].offsetTop;
                            var iElementHeight = iElement.height();
                            var windowHeight = window.innerHeight;
                            var shouldDropUp = (windowHeight - iElementHeight - offset) < iElementWrapperOffsetTop;
                            var menuMarginTop = '0px';
                            if (shouldDropUp) {
                                var offsetBottom = offsetDropupBottom || 0;
                                menuMarginTop = '-'.concat("" + (iElementHeight + offset + offsetBottom + 5), 'px');
                            }
                            _this._domElement.css({ 'margin-top': menuMarginTop });
                            // set dropdown margin left according to the document width
                            var parentOffset = iElementWrapperOffset.left;
                            var leftMargin = parentOffset - $(document).width();
                            _this._domElement.css({ 'margin-left': (_this._domElement.width() + leftMargin + 60) + 'px' });
                            try {
                                _this._domElement.dropdown('show'); // required for Bootstrap 4 only
                            }
                            catch (e) {
                                // Bootstrap 3 wil throw an error since that method doesn't exist, we can safely disregard it
                            }
                            _this._domElement.on('hidden.bs.dropdown', function () { return _this.dropContainerShow(); });
                            // hide dropdown menu on grid scroll
                            _this.gridViewport.on('scroll', function () { return _this.dispose(); });
                            // hide on dropdown click
                            _this._domElement.on('click', function () { return _this.dispose(); });
                            resolve(true);
                        });
                    }
                }
            }
        });
    };
    BsDropDownService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [AngularUtilService])
    ], BsDropDownService);
    return BsDropDownService;
}());
export { BsDropDownService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnNEcm9wZG93bi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9ic0Ryb3Bkb3duLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUF5QjNELDRCQUE0QjtBQUU1QjtJQUlFLDJCQUFvQixrQkFBc0M7UUFBdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUFJLENBQUM7SUFFL0Qsc0JBQUkseUNBQVU7YUFBZDtZQUNFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUMxQixDQUFDOzs7T0FBQTtJQUVELHNCQUFJLGtEQUFtQjthQUF2QjtZQUNFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDO1FBQ25DLENBQUM7OztPQUFBO0lBRUQsc0JBQUksMkNBQVk7YUFBaEI7WUFDRSxPQUFPLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzlCLENBQUM7OztPQUFBO0lBRUQsbUNBQU8sR0FBUDtRQUNFLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUMvQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztJQUVELDZDQUFpQixHQUFqQjtRQUNFLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUU7WUFDL0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQztJQUVELGtDQUFNLEdBQU4sVUFBTyxjQUFxQztRQUE1QyxpQkFpRkM7UUFoRkMsT0FBTyxJQUFJ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LENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsZ0NBQWdDOzZCQUNwRTs0QkFBQyxPQUFPLENBQUMsRUFBRTtnQ0FDViw2RkFBNkY7NkJBQzlGOzRCQUVELEtBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLGNBQU0sT0FBQSxLQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBeEIsQ0FBd0IsQ0FBQyxDQUFDOzRCQUUxRSxvQ0FBb0M7NEJBQ3BDLEtBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxjQUFNLE9BQUEsS0FBSSxDQUFDLE9BQU8sRUFBRSxFQUFkLENBQWMsQ0FBQyxDQUFDOzRCQUVyRCx5QkFBeUI7NEJBQ3pCLEtBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxjQUFNLE9BQUEsS0FBSSxDQUFDLE9BQU8sRUFBRSxFQUFkLENBQWMsQ0FBQyxDQUFDOzRCQUNuRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ2hCLENBQUMsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUEvR1UsaUJBQWlCO1FBRDdCLFVBQVUsRUFBRTtpREFLNkIsa0JBQWtCO09BSi9DLGlCQUFpQixDQWdIN0I7SUFBRCx3QkFBQztDQUFBLEFBaEhELElBZ0hDO1NBaEhZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFuZ3VsYXJVdGlsU2VydmljZSB9IGZyb20gJy4vYW5ndWxhclV0aWwuc2VydmljZSc7XHJcblxyXG5pbnRlcmZhY2UgRHJvcERvd25TZXJ2aWNlUGFyYW1zIHtcclxuICAvKiogdGhlIGN1c3RvbSBhY3Rpb24gZm9ybWF0dGVyIGNvbXBvbmVudCB0aGF0IGNvbnRhaW5zIHRoZSBkcm9wZG93biAqL1xyXG4gIGNvbXBvbmVudDogYW55O1xyXG5cclxuICAvKiogaGVscCB0byBnZXQgdGhlIGRhdGEgY29udGV4dCAqL1xyXG4gIGFyZ3M6IGFueTtcclxuXHJcbiAgLyoqIHBhcmVudCBjb250YWluZXIgKi9cclxuICBwYXJlbnQ6IGFueTtcclxuXHJcbiAgLyoqIE9mZnNldCBib3R0b20gd2hlbiB1c2luZyBhIERyb3AgVXAsIGlmIHdlIG5lZWQgdG8gcmVwb3NpdGlvbiB0aGUgZHJvcGRvd24gY29tcG9uZW50ICovXHJcbiAgb2Zmc2V0RHJvcHVwQm90dG9tPzogbnVtYmVyO1xyXG5cclxuICAvKiogT2Zmc2V0IGxlZnQgaWYgd2UgbmVlZCB0byByZXBvc2l0aW9uIHRoZSBkcm9wZG93biBjb21wb25lbnQgKi9cclxuICBvZmZzZXRMZWZ0PzogbnVtYmVyO1xyXG5cclxuICAvKiogT2Zmc2V0IHRvcCBpZiB3ZSBuZWVkIHRvIHJlcG9zaXRpb24gdGhlIGRyb3Bkb3duIGNvbXBvbmVudCAqL1xyXG4gIG9mZnNldFRvcD86IG51bWJlcjtcclxufVxyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIHZhciAkOiBhbnk7XHJcblxyXG4vLyBCb29zdHJhcCBkcm9wZG93biBzZXJ2aWNlXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJzRHJvcERvd25TZXJ2aWNlIHtcclxuICBwcml2YXRlIF9kb21Db250YWluZXJFbGVtZW50OiBhbnk7XHJcbiAgcHJpdmF0ZSBfZG9tRWxlbWVudDogYW55O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFuZ3VsYXJVdGlsU2VydmljZTogQW5ndWxhclV0aWxTZXJ2aWNlKSB7IH1cclxuXHJcbiAgZ2V0IGRvbUVsZW1lbnQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fZG9tRWxlbWVudDtcclxuICB9XHJcblxyXG4gIGdldCBkb21Db250YWluZXJFbGVtZW50KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2RvbUNvbnRhaW5lckVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICBnZXQgZ3JpZFZpZXdwb3J0KCkge1xyXG4gICAgcmV0dXJuICQoJy5zbGljay12aWV3cG9ydCcpO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIGlmICh0aGlzLl9kb21FbGVtZW50ICYmIHRoaXMuX2RvbUVsZW1lbnQucmVtb3ZlKSB7XHJcbiAgICAgIHRoaXMuX2RvbUVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkcm9wQ29udGFpbmVyU2hvdygpIHtcclxuICAgIGlmICh0aGlzLl9kb21Db250YWluZXJFbGVtZW50ICYmIHRoaXMuX2RvbUNvbnRhaW5lckVsZW1lbnQuc2hvdykge1xyXG4gICAgICB0aGlzLl9kb21Db250YWluZXJFbGVtZW50LnNob3coKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbmRlcihkcm9wZG93blBhcmFtczogRHJvcERvd25TZXJ2aWNlUGFyYW1zKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgY29uc3QgeyBjb21wb25lbnQsIGFyZ3MsIHBhcmVudCwgb2Zmc2V0VG9wLCBvZmZzZXRMZWZ0LCBvZmZzZXREcm9wdXBCb3R0b20gfSA9IGRyb3Bkb3duUGFyYW1zO1xyXG5cclxuICAgICAgY29uc3QgY2VsbCA9IGFyZ3MuY2VsbDtcclxuICAgICAgY29uc3Qgcm93ID0gYXJncy5yb3c7XHJcblxyXG4gICAgICB0aGlzLl9kb21Db250YWluZXJFbGVtZW50ID0gJChgI215RHJvcC1yJHtyb3d9LWMke2NlbGx9YCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5fZG9tQ29udGFpbmVyRWxlbWVudCkge1xyXG4gICAgICAgIC8vIGhpZGUgdGhlIGRyb3Bkb3duIHdlIGNyZWF0ZWQgYXMgYSBmb3JtYXR0ZXIgQ29tcG9uZW50LCB3ZSdsbCByZWRpc3BsYXkgaXQgbGF0ZXJcclxuICAgICAgICBjb25zdCBjZWxsUG9zID0gdGhpcy5fZG9tQ29udGFpbmVyRWxlbWVudC5vZmZzZXQoKTtcclxuXHJcbiAgICAgICAgY29uc3QgY29tcG9uZW50T3V0cHV0ID0gdGhpcy5hbmd1bGFyVXRpbFNlcnZpY2UuY3JlYXRlQW5ndWxhckNvbXBvbmVudChjb21wb25lbnQpO1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudEluc3RhbmNlID0gY29tcG9uZW50T3V0cHV0ICYmIGNvbXBvbmVudE91dHB1dC5jb21wb25lbnRSZWYgJiYgY29tcG9uZW50T3V0cHV0LmNvbXBvbmVudFJlZi5pbnN0YW5jZTtcclxuXHJcbiAgICAgICAgaWYgKGNvbXBvbmVudEluc3RhbmNlKSB7XHJcbiAgICAgICAgICBjb25zdCBteURyb3BJZCA9IGNvbXBvbmVudEluc3RhbmNlLmRyb3Bkb3duSWQgfHwgJ215RHJvcCc7XHJcbiAgICAgICAgICBjb25zdCBkcm9wRG93blRvZ2dsZUlkID0gY29tcG9uZW50SW5zdGFuY2UuZHJvcERvd25Ub2dnbGVJZCB8fCAnZHJvcGRvd25NZW51MSc7XHJcbiAgICAgICAgICB0aGlzLl9kb21FbGVtZW50ID0gJChgIyR7bXlEcm9wSWR9YCk7XHJcblxyXG4gICAgICAgICAgaWYgKHRoaXMuX2RvbUVsZW1lbnQpIHtcclxuICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSBhbnkgcHJldmlvdXMgQWN0aW9uIGRyb3Bkb3duIGVsZW1lbnRzLCB0byBhdm9pZCBoYXZpbmcgbXVsdGlwbGUgZWxlbWVudCBvZiB0aGUgc2FtZSBvbiB0b3Agb2YgZWFjaCBvdGhlclxyXG4gICAgICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGFzc2lnbiB0aGUgcm93IGRhdGEgdG8gdGhlIGRyb3Bkb3duIGNvbXBvbmVudCBpbnN0YW5jZVxyXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGNvbXBvbmVudEluc3RhbmNlLCB7IHBhcmVudCwgcm93OiBhcmdzLnJvdywgZGF0YUNvbnRleHQ6IGFyZ3MuZ3JpZC5nZXREYXRhSXRlbShhcmdzLnJvdykgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyB1c2UgYSBkZWxheSB0byBtYWtlIHN1cmUgQW5ndWxhciByYW4gYXQgbGVhc3QgYSBmdWxsIGN5Y2xlIGFuZCBtYWtlIHN1cmUgaXQgZmluaXNoZWQgcmVuZGVyaW5nIHRoZSBDb21wb25lbnQgYmVmb3JlIHVzaW5nIGl0XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIC8vIGNyZWF0ZSBhIG5ldyBkcm9wZG93biBlbGVtZW50XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudCA9ICQoY29tcG9uZW50T3V0cHV0LmRvbUVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHRvcFBvcyA9IChjZWxsUG9zICYmIGNlbGxQb3MudG9wIHx8IDApICsgMzAgKyAob2Zmc2V0VG9wIHx8IDApO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGxlZnRQb3MgPSAoY2VsbFBvcyAmJiBjZWxsUG9zLmxlZnQgfHwgMCkgKyAob2Zmc2V0TGVmdCB8fCAwKTtcclxuICAgICAgICAgICAgICB0aGlzLl9kb21FbGVtZW50LmFwcGVuZFRvKCdib2R5Jyk7XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5jc3MoJ3Bvc2l0aW9uJywgJ2Fic29sdXRlJyk7XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5jc3MoJ3RvcCcsIHRvcFBvcyk7XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5jc3MoJ2xlZnQnLCBsZWZ0UG9zKTtcclxuICAgICAgICAgICAgICAkKGAjJHtteURyb3BJZH1gKS5hZGRDbGFzcygnb3BlbicpO1xyXG4gICAgICAgICAgICAgICQoYCMke2Ryb3BEb3duVG9nZ2xlSWR9YCkuaGlkZSgpO1xyXG5cclxuICAgICAgICAgICAgICAvLyBjaGVjayBpZiBpdCBzaG91bGQgZHJvcCBVcCBvciBEb3duXHJcbiAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gMzU7XHJcbiAgICAgICAgICAgICAgY29uc3QgaUVsZW1lbnQgPSAkKCcuZHJvcGRvd24tbWVudScpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlFbGVtZW50V3JhcHBlciA9IGlFbGVtZW50LnBhcmVudCgpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlFbGVtZW50V3JhcHBlck9mZnNldCA9IGlFbGVtZW50V3JhcHBlci5vZmZzZXQoKSB8fCB7fTtcclxuICAgICAgICAgICAgICBjb25zdCBpRWxlbWVudFdyYXBwZXJPZmZzZXRUb3AgPSBpRWxlbWVudFdyYXBwZXJPZmZzZXQudG9wIHx8IGlFbGVtZW50V3JhcHBlciAmJiBpRWxlbWVudFdyYXBwZXIubGVuZ3RoID4gMCAmJiBpRWxlbWVudFdyYXBwZXJbMF0ub2Zmc2V0VG9wO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlFbGVtZW50SGVpZ2h0ID0gaUVsZW1lbnQuaGVpZ2h0KCk7XHJcbiAgICAgICAgICAgICAgY29uc3Qgd2luZG93SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xyXG4gICAgICAgICAgICAgIGNvbnN0IHNob3VsZERyb3BVcCA9ICh3aW5kb3dIZWlnaHQgLSBpRWxlbWVudEhlaWdodCAtIG9mZnNldCkgPCBpRWxlbWVudFdyYXBwZXJPZmZzZXRUb3A7XHJcbiAgICAgICAgICAgICAgbGV0IG1lbnVNYXJnaW5Ub3AgPSAnMHB4JztcclxuICAgICAgICAgICAgICBpZiAoc2hvdWxkRHJvcFVwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXRCb3R0b20gPSBvZmZzZXREcm9wdXBCb3R0b20gfHwgMDtcclxuICAgICAgICAgICAgICAgIG1lbnVNYXJnaW5Ub3AgPSAnLScuY29uY2F0KGAke2lFbGVtZW50SGVpZ2h0ICsgb2Zmc2V0ICsgb2Zmc2V0Qm90dG9tICsgNX1gLCAncHgnKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5jc3MoeyAnbWFyZ2luLXRvcCc6IG1lbnVNYXJnaW5Ub3AgfSk7XHJcblxyXG4gICAgICAgICAgICAgIC8vIHNldCBkcm9wZG93biBtYXJnaW4gbGVmdCBhY2NvcmRpbmcgdG8gdGhlIGRvY3VtZW50IHdpZHRoXHJcbiAgICAgICAgICAgICAgY29uc3QgcGFyZW50T2Zmc2V0ID0gaUVsZW1lbnRXcmFwcGVyT2Zmc2V0LmxlZnQ7XHJcbiAgICAgICAgICAgICAgY29uc3QgbGVmdE1hcmdpbiA9IHBhcmVudE9mZnNldCAtICQoZG9jdW1lbnQpLndpZHRoKCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5jc3MoeyAnbWFyZ2luLWxlZnQnOiAodGhpcy5fZG9tRWxlbWVudC53aWR0aCgpICsgbGVmdE1hcmdpbiArIDYwKSArICdweCcgfSk7XHJcblxyXG4gICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9kb21FbGVtZW50LmRyb3Bkb3duKCdzaG93Jyk7IC8vIHJlcXVpcmVkIGZvciBCb290c3RyYXAgNCBvbmx5XHJcbiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgLy8gQm9vdHN0cmFwIDMgd2lsIHRocm93IGFuIGVycm9yIHNpbmNlIHRoYXQgbWV0aG9kIGRvZXNuJ3QgZXhpc3QsIHdlIGNhbiBzYWZlbHkgZGlzcmVnYXJkIGl0XHJcbiAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICB0aGlzLl9kb21FbGVtZW50Lm9uKCdoaWRkZW4uYnMuZHJvcGRvd24nLCAoKSA9PiB0aGlzLmRyb3BDb250YWluZXJTaG93KCkpO1xyXG5cclxuICAgICAgICAgICAgICAvLyBoaWRlIGRyb3Bkb3duIG1lbnUgb24gZ3JpZCBzY3JvbGxcclxuICAgICAgICAgICAgICB0aGlzLmdyaWRWaWV3cG9ydC5vbignc2Nyb2xsJywgKCkgPT4gdGhpcy5kaXNwb3NlKCkpO1xyXG5cclxuICAgICAgICAgICAgICAvLyBoaWRlIG9uIGRyb3Bkb3duIGNsaWNrXHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5vbignY2xpY2snLCAoKSA9PiB0aGlzLmRpc3Bvc2UoKSk7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19