import * as tslib_1 from "tslib";
import { CaseType } from '../models/index';
import { titleCase } from './utilities';
var OdataQueryBuilderService = /** @class */ (function () {
    function OdataQueryBuilderService() {
        this._odataOptions = {
            filterQueue: [],
            orderBy: ''
        };
        this._defaultSortBy = '';
        this._columnFilters = {};
    }
    /*
      * Build the OData query string from all the options provided
      * @return string OData query
      */
    OdataQueryBuilderService.prototype.buildQuery = function () {
        if (!this._odataOptions) {
            throw new Error('Odata Service requires certain options like "top" for it to work');
        }
        this._odataOptions.filterQueue = [];
        var queryTmpArray = [];
        // When enableCount is set, add it to the OData query
        if (this._odataOptions.enableCount === true) {
            var countQuery = (this._odataOptions.version >= 4) ? '$count=true' : '$inlinecount=allpages';
            queryTmpArray.push(countQuery);
        }
        if (this._odataOptions.top) {
            queryTmpArray.push("$top=" + this._odataOptions.top);
        }
        if (this._odataOptions.skip) {
            queryTmpArray.push("$skip=" + this._odataOptions.skip);
        }
        if (this._odataOptions.orderBy) {
            var argument = '';
            if (Array.isArray(this._odataOptions.orderBy)) {
                argument = this._odataOptions.orderBy.join(','); // csv, that will form a query, for example: $orderby=RoleName asc, Id desc
            }
            else {
                argument = this._odataOptions.orderBy;
            }
            queryTmpArray.push("$orderby=" + argument);
        }
        if (this._odataOptions.filterBy || this._odataOptions.filter) {
            var filterBy = this._odataOptions.filter || this._odataOptions.filterBy;
            if (filterBy) {
                this._filterCount = 1;
                this._odataOptions.filterQueue = [];
                var filterStr = filterBy;
                if (Array.isArray(filterBy)) {
                    this._filterCount = filterBy.length;
                    filterStr = filterBy.join(" " + (this._odataOptions.filterBySeparator || 'and') + " ");
                }
                if (typeof filterStr === 'string') {
                    if (!(filterStr[0] === '(' && filterStr.slice(-1) === ')')) {
                        this.addToFilterQueueWhenNotExists("(" + filterStr + ")");
                    }
                    else {
                        this.addToFilterQueueWhenNotExists(filterStr);
                    }
                }
            }
        }
        if (this._odataOptions.filterQueue.length > 0) {
            var query = this._odataOptions.filterQueue.join(" " + (this._odataOptions.filterBySeparator || 'and') + " ");
            this._odataOptions.filter = query; // overwrite with
            queryTmpArray.push("$filter=" + query);
        }
        // join all the odata functions by a '&'
        return queryTmpArray.join('&');
    };
    OdataQueryBuilderService.prototype.getFilterCount = function () {
        return this._filterCount;
    };
    Object.defineProperty(OdataQueryBuilderService.prototype, "columnFilters", {
        get: function () {
            return this._columnFilters;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(OdataQueryBuilderService.prototype, "options", {
        get: function () {
            return this._odataOptions;
        },
        set: function (options) {
            this._odataOptions = options;
        },
        enumerable: true,
        configurable: true
    });
    OdataQueryBuilderService.prototype.removeColumnFilter = function (fieldName) {
        if (this._columnFilters && this._columnFilters.hasOwnProperty(fieldName)) {
            delete this._columnFilters[fieldName];
        }
    };
    OdataQueryBuilderService.prototype.saveColumnFilter = function (fieldName, value, searchTerms) {
        this._columnFilters[fieldName] = {
            search: searchTerms,
            value: value
        };
    };
    /**
     * Change any OData options that will be used to build the query
     * @param object options
     */
    OdataQueryBuilderService.prototype.updateOptions = function (options) {
        var e_1, _a;
        try {
            for (var _b = tslib_1.__values(Object.keys(options)), _c = _b.next(); !_c.done; _c = _b.next()) {
                var property = _c.value;
                if (options.hasOwnProperty(property)) {
                    this._odataOptions[property] = options[property]; // replace of the property
                }
                // we need to keep the defaultSortBy for references whenever the user removes his Sorting
                // then we would revert to the defaultSortBy and the only way is to keep a hard copy here
                if (property === 'orderBy' || property === 'sortBy') {
                    var sortBy = options[property];
                    // make sure first char of each orderBy field is capitalize
                    if (this._odataOptions.caseType === CaseType.pascalCase) {
                        if (Array.isArray(sortBy)) {
                            sortBy.forEach(function (field, index, inputArray) {
                                inputArray[index] = titleCase(field);
                            });
                        }
                        else {
                            sortBy = titleCase(options[property]);
                        }
                    }
                    this._odataOptions.orderBy = sortBy;
                    this._defaultSortBy = sortBy;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    //
    // private functions
    // -------------------
    OdataQueryBuilderService.prototype.addToFilterQueueWhenNotExists = function (filterStr) {
        if (this._odataOptions.filterQueue && this._odataOptions.filterQueue.indexOf(filterStr) === -1) {
            this._odataOptions.filterQueue.push(filterStr);
        }
    };
    return OdataQueryBuilderService;
}());
export { OdataQueryBuilderService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGFRdWVyeUJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvc2VydmljZXMvb2RhdGFRdWVyeUJ1aWxkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBZSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFeEM7SUFNRTtRQUNFLElBQUksQ0FBQyxhQUFhLEdBQUc7WUFDbkIsV0FBVyxFQUFFLEVBQUU7WUFDZixPQUFPLEVBQUUsRUFBRTtTQUNaLENBQUM7UUFDRixJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQ7OztRQUdJO0lBQ0osNkNBQVUsR0FBVjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0VBQWtFLENBQUMsQ0FBQztTQUNyRjtRQUNELElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUNwQyxJQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFFekIscURBQXFEO1FBQ3JELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEtBQUssSUFBSSxFQUFFO1lBQzNDLElBQU0sVUFBVSxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUM7WUFDL0YsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUNoQztRQUVELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUU7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QUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTs0QkFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsVUFBVTtnQ0FDdEMsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQzs0QkFDdkMsQ0FBQyxDQUFDLENBQUM7eUJBQ0o7NkJBQU07NEJBQ0wsTUFBTSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzt5QkFDdkM7cUJBQ0Y7b0JBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO29CQUNwQyxJQUFJLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQztpQkFDOUI7YUFDRjs7Ozs7Ozs7O0lBQ0gsQ0FBQztJQUVELEVBQUU7SUFDRixvQkFBb0I7SUFDcEIsc0JBQXNCO0lBRWQsZ0VBQTZCLEdBQXJDLFVBQXNDLFNBQWlCO1FBQ3JELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQzlGLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNoRDtJQUNILENBQUM7SUFDSCwrQkFBQztBQUFELENBQUMsQUFsSkQsSUFrSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYXNlVHlwZSwgT2RhdGFPcHRpb24gfSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyB0aXRsZUNhc2UgfSBmcm9tICcuL3V0aWxpdGllcyc7XHJcblxyXG5leHBvcnQgY2xhc3MgT2RhdGFRdWVyeUJ1aWxkZXJTZXJ2aWNlIHtcclxuICBfY29sdW1uRmlsdGVyczogYW55O1xyXG4gIF9kZWZhdWx0U29ydEJ5OiBzdHJpbmc7XHJcbiAgX2ZpbHRlckNvdW50OiBudW1iZXI7XHJcbiAgX29kYXRhT3B0aW9uczogUGFydGlhbDxPZGF0YU9wdGlvbj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5fb2RhdGFPcHRpb25zID0ge1xyXG4gICAgICBmaWx0ZXJRdWV1ZTogW10sXHJcbiAgICAgIG9yZGVyQnk6ICcnXHJcbiAgICB9O1xyXG4gICAgdGhpcy5fZGVmYXVsdFNvcnRCeSA9ICcnO1xyXG4gICAgdGhpcy5fY29sdW1uRmlsdGVycyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgICogQnVpbGQgdGhlIE9EYXRhIHF1ZXJ5IHN0cmluZyBmcm9tIGFsbCB0aGUgb3B0aW9ucyBwcm92aWRlZFxyXG4gICAgKiBAcmV0dXJuIHN0cmluZyBPRGF0YSBxdWVyeVxyXG4gICAgKi9cclxuICBidWlsZFF1ZXJ5KCk6IHN0cmluZyB7XHJcbiAgICBpZiAoIXRoaXMuX29kYXRhT3B0aW9ucykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09kYXRhIFNlcnZpY2UgcmVxdWlyZXMgY2VydGFpbiBvcHRpb25zIGxpa2UgXCJ0b3BcIiBmb3IgaXQgdG8gd29yaycpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlclF1ZXVlID0gW107XHJcbiAgICBjb25zdCBxdWVyeVRtcEFycmF5ID0gW107XHJcblxyXG4gICAgLy8gV2hlbiBlbmFibGVDb3VudCBpcyBzZXQsIGFkZCBpdCB0byB0aGUgT0RhdGEgcXVlcnlcclxuICAgIGlmICh0aGlzLl9vZGF0YU9wdGlvbnMuZW5hYmxlQ291bnQgPT09IHRydWUpIHtcclxuICAgICAgY29uc3QgY291bnRRdWVyeSA9ICh0aGlzLl9vZGF0YU9wdGlvbnMudmVyc2lvbiA+PSA0KSA/ICckY291bnQ9dHJ1ZScgOiAnJGlubGluZWNvdW50PWFsbHBhZ2VzJztcclxuICAgICAgcXVlcnlUbXBBcnJheS5wdXNoKGNvdW50UXVlcnkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9vZGF0YU9wdGlvbnMudG9wKSB7XHJcbiAgICAgIHF1ZXJ5VG1wQXJyYXkucHVzaChgJHRvcD0ke3RoaXMuX29kYXRhT3B0aW9ucy50b3B9YCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fb2RhdGFPcHRpb25zLnNraXApIHtcclxuICAgICAgcXVlcnlUbXBBcnJheS5wdXNoKGAkc2tpcD0ke3RoaXMuX29kYXRhT3B0aW9ucy5za2lwfWApO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuX29kYXRhT3B0aW9ucy5vcmRlckJ5KSB7XHJcbiAgICAgIGxldCBhcmd1bWVudCA9ICcnO1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLl9vZGF0YU9wdGlvbnMub3JkZXJCeSkpIHtcclxuICAgICAgICBhcmd1bWVudCA9IHRoaXMuX29kYXRhT3B0aW9ucy5vcmRlckJ5LmpvaW4oJywnKTsgLy8gY3N2LCB0aGF0IHdpbGwgZm9ybSBhIHF1ZXJ5LCBmb3IgZXhhbXBsZTogJG9yZGVyYnk9Um9sZU5hbWUgYXNjLCBJZCBkZXNjXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXJndW1lbnQgPSB0aGlzLl9vZGF0YU9wdGlvbnMub3JkZXJCeTtcclxuICAgICAgfVxyXG4gICAgICBxdWVyeVRtcEFycmF5LnB1c2goYCRvcmRlcmJ5PSR7YXJndW1lbnR9YCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlckJ5IHx8IHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXIpIHtcclxuICAgICAgY29uc3QgZmlsdGVyQnkgPSB0aGlzLl9vZGF0YU9wdGlvbnMuZmlsdGVyIHx8IHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJCeTtcclxuICAgICAgaWYgKGZpbHRlckJ5KSB7XHJcbiAgICAgICAgdGhpcy5fZmlsdGVyQ291bnQgPSAxO1xyXG4gICAgICAgIHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJRdWV1ZSA9IFtdO1xyXG4gICAgICAgIGxldCBmaWx0ZXJTdHIgPSBmaWx0ZXJCeTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJCeSkpIHtcclxuICAgICAgICAgIHRoaXMuX2ZpbHRlckNvdW50ID0gZmlsdGVyQnkubGVuZ3RoO1xyXG4gICAgICAgICAgZmlsdGVyU3RyID0gZmlsdGVyQnkuam9pbihgICR7dGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlckJ5U2VwYXJhdG9yIHx8ICdhbmQnfSBgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgZmlsdGVyU3RyID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgaWYgKCEoZmlsdGVyU3RyWzBdID09PSAnKCcgJiYgZmlsdGVyU3RyLnNsaWNlKC0xKSA9PT0gJyknKSkge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFRvRmlsdGVyUXVldWVXaGVuTm90RXhpc3RzKGAoJHtmaWx0ZXJTdHJ9KWApO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRUb0ZpbHRlclF1ZXVlV2hlbk5vdEV4aXN0cyhmaWx0ZXJTdHIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJRdWV1ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5fb2RhdGFPcHRpb25zLmZpbHRlclF1ZXVlLmpvaW4oYCAke3RoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJCeVNlcGFyYXRvciB8fCAnYW5kJ30gYCk7XHJcbiAgICAgIHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXIgPSBxdWVyeTsgLy8gb3ZlcndyaXRlIHdpdGhcclxuICAgICAgcXVlcnlUbXBBcnJheS5wdXNoKGAkZmlsdGVyPSR7cXVlcnl9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gam9pbiBhbGwgdGhlIG9kYXRhIGZ1bmN0aW9ucyBieSBhICcmJ1xyXG4gICAgcmV0dXJuIHF1ZXJ5VG1wQXJyYXkuam9pbignJicpO1xyXG4gIH1cclxuXHJcbiAgZ2V0RmlsdGVyQ291bnQoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9maWx0ZXJDb3VudDtcclxuICB9XHJcblxyXG4gIGdldCBjb2x1bW5GaWx0ZXJzKCk6IGFueVtdIHtcclxuICAgIHJldHVybiB0aGlzLl9jb2x1bW5GaWx0ZXJzO1xyXG4gIH1cclxuXHJcbiAgZ2V0IG9wdGlvbnMoKTogUGFydGlhbDxPZGF0YU9wdGlvbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX29kYXRhT3B0aW9ucztcclxuICB9XHJcblxyXG4gIHNldCBvcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8T2RhdGFPcHRpb24+KSB7XHJcbiAgICB0aGlzLl9vZGF0YU9wdGlvbnMgPSBvcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlQ29sdW1uRmlsdGVyKGZpZWxkTmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpcy5fY29sdW1uRmlsdGVycyAmJiB0aGlzLl9jb2x1bW5GaWx0ZXJzLmhhc093blByb3BlcnR5KGZpZWxkTmFtZSkpIHtcclxuICAgICAgZGVsZXRlIHRoaXMuX2NvbHVtbkZpbHRlcnNbZmllbGROYW1lXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNhdmVDb2x1bW5GaWx0ZXIoZmllbGROYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIHNlYXJjaFRlcm1zPzogYW55W10pIHtcclxuICAgIHRoaXMuX2NvbHVtbkZpbHRlcnNbZmllbGROYW1lXSA9IHtcclxuICAgICAgc2VhcmNoOiBzZWFyY2hUZXJtcyxcclxuICAgICAgdmFsdWVcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDaGFuZ2UgYW55IE9EYXRhIG9wdGlvbnMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gYnVpbGQgdGhlIHF1ZXJ5XHJcbiAgICogQHBhcmFtIG9iamVjdCBvcHRpb25zXHJcbiAgICovXHJcbiAgdXBkYXRlT3B0aW9ucyhvcHRpb25zOiBQYXJ0aWFsPE9kYXRhT3B0aW9uPikge1xyXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPYmplY3Qua2V5cyhvcHRpb25zKSkge1xyXG4gICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHtcclxuICAgICAgICB0aGlzLl9vZGF0YU9wdGlvbnNbcHJvcGVydHldID0gb3B0aW9uc1twcm9wZXJ0eV07IC8vIHJlcGxhY2Ugb2YgdGhlIHByb3BlcnR5XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIHdlIG5lZWQgdG8ga2VlcCB0aGUgZGVmYXVsdFNvcnRCeSBmb3IgcmVmZXJlbmNlcyB3aGVuZXZlciB0aGUgdXNlciByZW1vdmVzIGhpcyBTb3J0aW5nXHJcbiAgICAgIC8vIHRoZW4gd2Ugd291bGQgcmV2ZXJ0IHRvIHRoZSBkZWZhdWx0U29ydEJ5IGFuZCB0aGUgb25seSB3YXkgaXMgdG8ga2VlcCBhIGhhcmQgY29weSBoZXJlXHJcbiAgICAgIGlmIChwcm9wZXJ0eSA9PT0gJ29yZGVyQnknIHx8IHByb3BlcnR5ID09PSAnc29ydEJ5Jykge1xyXG4gICAgICAgIGxldCBzb3J0QnkgPSBvcHRpb25zW3Byb3BlcnR5XTtcclxuXHJcbiAgICAgICAgLy8gbWFrZSBzdXJlIGZpcnN0IGNoYXIgb2YgZWFjaCBvcmRlckJ5IGZpZWxkIGlzIGNhcGl0YWxpemVcclxuICAgICAgICBpZiAodGhpcy5fb2RhdGFPcHRpb25zLmNhc2VUeXBlID09PSBDYXNlVHlwZS5wYXNjYWxDYXNlKSB7XHJcbiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzb3J0QnkpKSB7XHJcbiAgICAgICAgICAgIHNvcnRCeS5mb3JFYWNoKChmaWVsZCwgaW5kZXgsIGlucHV0QXJyYXkpID0+IHtcclxuICAgICAgICAgICAgICBpbnB1dEFycmF5W2luZGV4XSA9IHRpdGxlQ2FzZShmaWVsZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc29ydEJ5ID0gdGl0bGVDYXNlKG9wdGlvbnNbcHJvcGVydHldKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fb2RhdGFPcHRpb25zLm9yZGVyQnkgPSBzb3J0Qnk7XHJcbiAgICAgICAgdGhpcy5fZGVmYXVsdFNvcnRCeSA9IHNvcnRCeTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy9cclxuICAvLyBwcml2YXRlIGZ1bmN0aW9uc1xyXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgcHJpdmF0ZSBhZGRUb0ZpbHRlclF1ZXVlV2hlbk5vdEV4aXN0cyhmaWx0ZXJTdHI6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuX29kYXRhT3B0aW9ucy5maWx0ZXJRdWV1ZSAmJiB0aGlzLl9vZGF0YU9wdGlvbnMuZmlsdGVyUXVldWUuaW5kZXhPZihmaWx0ZXJTdHIpID09PSAtMSkge1xyXG4gICAgICB0aGlzLl9vZGF0YU9wdGlvbnMuZmlsdGVyUXVldWUucHVzaChmaWx0ZXJTdHIpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=