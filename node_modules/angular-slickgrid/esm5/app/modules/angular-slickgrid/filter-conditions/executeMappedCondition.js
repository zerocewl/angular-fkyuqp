import { booleanFilterCondition } from './booleanFilterCondition';
import { collectionSearchFilterCondition } from './collectionSearchFilterCondition';
import { numberFilterCondition } from './numberFilterCondition';
import { objectFilterCondition } from './objectFilterCondition';
import { stringFilterCondition } from './stringFilterCondition';
import { FieldType, OperatorType } from '../models/index';
import { mapMomentDateFormatWithFieldType } from './../services/utilities';
import { testFilterCondition } from './filterUtilities';
import * as moment_ from 'moment-mini';
var moment = moment_; // patch to fix rollup "moment has no default export" issue, document here https://github.com/rollup/rollup/issues/670
export var executeMappedCondition = function (options) {
    // when using a multi-select ('IN' operator) we will not use the field type but instead go directly with a collection search
    var operator = options && options.operator && options.operator.toUpperCase();
    if (operator === 'IN' || operator === 'NIN' || operator === 'IN_CONTAINS' || operator === 'NIN_CONTAINS') {
        return collectionSearchFilterCondition(options);
    }
    // execute the mapped type, or default to String condition check
    switch (options.fieldType) {
        case FieldType.boolean:
            return booleanFilterCondition(options);
        case FieldType.date:
        case FieldType.dateIso:
        case FieldType.dateUtc:
        case FieldType.dateTime:
        case FieldType.dateTimeIso:
        case FieldType.dateTimeIsoAmPm:
        case FieldType.dateTimeIsoAM_PM:
        case FieldType.dateTimeShortIso:
        case FieldType.dateEuro:
        case FieldType.dateEuroShort:
        case FieldType.dateTimeShortEuro:
        case FieldType.dateTimeEuro:
        case FieldType.dateTimeEuroAmPm:
        case FieldType.dateTimeEuroAM_PM:
        case FieldType.dateTimeEuroShort:
        case FieldType.dateTimeEuroShortAmPm:
        case FieldType.dateTimeEuroShortAM_PM:
        case FieldType.dateUs:
        case FieldType.dateUsShort:
        case FieldType.dateTimeShortUs:
        case FieldType.dateTimeUs:
        case FieldType.dateTimeUsAmPm:
        case FieldType.dateTimeUsAM_PM:
        case FieldType.dateTimeUsShort:
        case FieldType.dateTimeUsShortAmPm:
        case FieldType.dateTimeUsShortAM_PM:
            return executeAssociatedDateCondition(options);
        case FieldType.integer:
        case FieldType.float:
        case FieldType.number:
            return numberFilterCondition(options);
        case FieldType.object:
            return objectFilterCondition(options);
        case FieldType.string:
        default:
            return stringFilterCondition(options);
    }
};
/**
 * Execute Date filter condition and use correct date format depending on it's field type (or filterSearchType when that is provided)
 * @param options
 */
function executeAssociatedDateCondition(options) {
    var filterSearchType = options && (options.filterSearchType || options.fieldType) || FieldType.dateIso;
    var FORMAT = mapMomentDateFormatWithFieldType(filterSearchType);
    var searchTerms = Array.isArray(options.searchTerms) && options.searchTerms || [];
    var isRangeSearch = false;
    var dateSearch1;
    var dateSearch2;
    // return when cell value is not a valid date
    if (searchTerms.length === 0 || searchTerms[0] === '' || searchTerms[0] === null || !moment(options.cellValue, FORMAT, true).isValid()) {
        return false;
    }
    // cell value in moment format
    var dateCell = moment(options.cellValue, FORMAT, true);
    if (searchTerms.length === 2 || (searchTerms[0].indexOf('..') > 0)) {
        isRangeSearch = true;
        var searchValues = (searchTerms.length === 2) ? searchTerms : searchTerms[0].split('..');
        var searchValue1 = (Array.isArray(searchValues) && searchValues[0] || '');
        var searchValue2 = (Array.isArray(searchValues) && searchValues[1] || '');
        var searchTerm1 = moment(searchValue1, FORMAT, true);
        var searchTerm2 = moment(searchValue2, FORMAT, true);
        // return if any of the 2 values are invalid dates
        if (!moment(searchTerm1, FORMAT, true).isValid() || !moment(searchTerm2, FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerm1, FORMAT, true);
        dateSearch2 = moment(searchTerm2, FORMAT, true);
    }
    else {
        // return if the search term is an invalid date
        if (!moment(searchTerms[0], FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerms[0], FORMAT, true);
    }
    // run the filter condition with date in Unix Timestamp format
    if (isRangeSearch) {
        var isInclusive = options.operator && options.operator === OperatorType.rangeInclusive;
        var resultCondition1 = testFilterCondition((isInclusive ? '>=' : '>'), parseInt(dateCell.format('X'), 10), parseInt(dateSearch1.format('X'), 10));
        var resultCondition2 = testFilterCondition((isInclusive ? '<=' : '<'), parseInt(dateCell.format('X'), 10), parseInt(dateSearch2.format('X'), 10));
        return (resultCondition1 && resultCondition2);
    }
    return testFilterCondition(options.operator || '==', parseInt(dateCell.format('X'), 10), parseInt(dateSearch1.format('X'), 10));
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvZmlsdGVyLWNvbmRpdGlvbnMvZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVoRSxPQUFPLEVBQUUsU0FBUyxFQUEwQyxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNsRyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEtBQUssT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUV2QyxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxzSEFBc0g7QUFFOUksTUFBTSxDQUFDLElBQU0sc0JBQXNCLEdBQW9CLFVBQUMsT0FBOEI7SUFDcEYsNEhBQTRIO0lBQzVILElBQU0sUUFBUSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDL0UsSUFBSSxRQUFRLEtBQUssSUFBSSxJQUFJLFFBQVEsS0FBSyxLQUFLLElBQUksUUFBUSxLQUFLLGFBQWEsSUFBSSxRQUFRLEtBQUssY0FBYyxFQUFFO1FBQ3hHLE9BQU8sK0JBQStCLENB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LE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BKLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFDO0tBQy9DO0lBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsUUFBUSxJQUFJLElBQUksRUFBRSxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ2xJLENBQUM7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYm9vbGVhbkZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vYm9vbGVhbkZpbHRlckNvbmRpdGlvbic7XHJcbmltcG9ydCB7IGNvbGxlY3Rpb25TZWFyY2hGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL2NvbGxlY3Rpb25TZWFyY2hGaWx0ZXJDb25kaXRpb24nO1xyXG5pbXBvcnQgeyBudW1iZXJGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL251bWJlckZpbHRlckNvbmRpdGlvbic7XHJcbmltcG9ydCB7IG9iamVjdEZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vb2JqZWN0RmlsdGVyQ29uZGl0aW9uJztcclxuaW1wb3J0IHsgc3RyaW5nRmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9zdHJpbmdGaWx0ZXJDb25kaXRpb24nO1xyXG5cclxuaW1wb3J0IHsgRmllbGRUeXBlLCBGaWx0ZXJDb25kaXRpb24sIEZpbHRlckNvbmRpdGlvbk9wdGlvbiwgT3BlcmF0b3JUeXBlIH0gZnJvbSAnLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgbWFwTW9tZW50RGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUgfSBmcm9tICcuLy4uL3NlcnZpY2VzL3V0aWxpdGllcyc7XHJcbmltcG9ydCB7IHRlc3RGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL2ZpbHRlclV0aWxpdGllcyc7XHJcbmltcG9ydCAqIGFzIG1vbWVudF8gZnJvbSAnbW9tZW50LW1pbmknO1xyXG5cclxuY29uc3QgbW9tZW50ID0gbW9tZW50XzsgLy8gcGF0Y2ggdG8gZml4IHJvbGx1cCBcIm1vbWVudCBoYXMgbm8gZGVmYXVsdCBleHBvcnRcIiBpc3N1ZSwgZG9jdW1lbnQgaGVyZSBodHRwczovL2dpdGh1Yi5jb20vcm9sbHVwL3JvbGx1cC9pc3N1ZXMvNjcwXHJcblxyXG5leHBvcnQgY29uc3QgZXhlY3V0ZU1hcHBlZENvbmRpdGlvbjogRmlsdGVyQ29uZGl0aW9uID0gKG9wdGlvbnM6IEZpbHRlckNvbmRpdGlvbk9wdGlvbikgPT4ge1xyXG4gIC8vIHdoZW4gdXNpbmcgYSBtdWx0aS1zZWxlY3QgKCdJTicgb3BlcmF0b3IpIHdlIHdpbGwgbm90IHVzZSB0aGUgZmllbGQgdHlwZSBidXQgaW5zdGVhZCBnbyBkaXJlY3RseSB3aXRoIGEgY29sbGVjdGlvbiBzZWFyY2hcclxuICBjb25zdCBvcGVyYXRvciA9IG9wdGlvbnMgJiYgb3B0aW9ucy5vcGVyYXRvciAmJiBvcHRpb25zLm9wZXJhdG9yLnRvVXBwZXJDYXNlKCk7XHJcbiAgaWYgKG9wZXJhdG9yID09PSAnSU4nIHx8IG9wZXJhdG9yID09PSAnTklOJyB8fCBvcGVyYXRvciA9PT0gJ0lOX0NPTlRBSU5TJyB8fCBvcGVyYXRvciA9PT0gJ05JTl9DT05UQUlOUycpIHtcclxuICAgIHJldHVybiBjb2xsZWN0aW9uU2VhcmNoRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgLy8gZXhlY3V0ZSB0aGUgbWFwcGVkIHR5cGUsIG9yIGRlZmF1bHQgdG8gU3RyaW5nIGNvbmRpdGlvbiBjaGVja1xyXG4gIHN3aXRjaCAob3B0aW9ucy5maWVsZFR5cGUpIHtcclxuICAgIGNhc2UgRmllbGRUeXBlLmJvb2xlYW46XHJcbiAgICAgIHJldHVybiBib29sZWFuRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVJc286XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVXRjOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWU6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUlzbzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lSXNvQW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lSXNvQU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVNob3J0SXNvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZUV1cm86XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlRXVyb1Nob3J0OlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVTaG9ydEV1cm86XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm86XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9BbVBtOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvQU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9TaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb1Nob3J0QW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb1Nob3J0QU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVXM6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVXNTaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lU2hvcnRVczpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXM6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzQW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNBTV9QTTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNTaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNTaG9ydEFtUG06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzU2hvcnRBTV9QTTpcclxuICAgICAgcmV0dXJuIGV4ZWN1dGVBc3NvY2lhdGVkRGF0ZUNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLmludGVnZXI6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5mbG9hdDpcclxuICAgIGNhc2UgRmllbGRUeXBlLm51bWJlcjpcclxuICAgICAgcmV0dXJuIG51bWJlckZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLm9iamVjdDpcclxuICAgICAgcmV0dXJuIG9iamVjdEZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLnN0cmluZzpcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIHJldHVybiBzdHJpbmdGaWx0ZXJDb25kaXRpb24ob3B0aW9ucyk7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEV4ZWN1dGUgRGF0ZSBmaWx0ZXIgY29uZGl0aW9uIGFuZCB1c2UgY29ycmVjdCBkYXRlIGZvcm1hdCBkZXBlbmRpbmcgb24gaXQncyBmaWVsZCB0eXBlIChvciBmaWx0ZXJTZWFyY2hUeXBlIHdoZW4gdGhhdCBpcyBwcm92aWRlZClcclxuICogQHBhcmFtIG9wdGlvbnNcclxuICovXHJcbmZ1bmN0aW9uIGV4ZWN1dGVBc3NvY2lhdGVkRGF0ZUNvbmRpdGlvbihvcHRpb25zOiBGaWx0ZXJDb25kaXRpb25PcHRpb24pOiBib29sZWFuIHtcclxuICBjb25zdCBmaWx0ZXJTZWFyY2hUeXBlID0gb3B0aW9ucyAmJiAob3B0aW9ucy5maWx0ZXJTZWFyY2hUeXBlIHx8IG9wdGlvbnMuZmllbGRUeXBlKSB8fCBGaWVsZFR5cGUuZGF0ZUlzbztcclxuICBjb25zdCBGT1JNQVQgPSBtYXBNb21lbnREYXRlRm9ybWF0V2l0aEZpZWxkVHlwZShmaWx0ZXJTZWFyY2hUeXBlKTtcclxuICBjb25zdCBzZWFyY2hUZXJtcyA9IEFycmF5LmlzQXJyYXkob3B0aW9ucy5zZWFyY2hUZXJtcykgJiYgb3B0aW9ucy5zZWFyY2hUZXJtcyB8fCBbXTtcclxuXHJcbiAgbGV0IGlzUmFuZ2VTZWFyY2ggPSBmYWxzZTtcclxuICBsZXQgZGF0ZVNlYXJjaDE6IGFueTtcclxuICBsZXQgZGF0ZVNlYXJjaDI6IGFueTtcclxuXHJcbiAgLy8gcmV0dXJuIHdoZW4gY2VsbCB2YWx1ZSBpcyBub3QgYSB2YWxpZCBkYXRlXHJcbiAgaWYgKHNlYXJjaFRlcm1zLmxlbmd0aCA9PT0gMCB8fCBzZWFyY2hUZXJtc1swXSA9PT0gJycgfHwgc2VhcmNoVGVybXNbMF0gPT09IG51bGwgfHwgIW1vbWVudChvcHRpb25zLmNlbGxWYWx1ZSwgRk9STUFULCB0cnVlKS5pc1ZhbGlkKCkpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIC8vIGNlbGwgdmFsdWUgaW4gbW9tZW50IGZvcm1hdFxyXG4gIGNvbnN0IGRhdGVDZWxsID0gbW9tZW50KG9wdGlvbnMuY2VsbFZhbHVlLCBGT1JNQVQsIHRydWUpO1xyXG5cclxuICBpZiAoc2VhcmNoVGVybXMubGVuZ3RoID09PSAyIHx8ICgoc2VhcmNoVGVybXNbMF0gYXMgc3RyaW5nKS5pbmRleE9mKCcuLicpID4gMCkpIHtcclxuICAgIGlzUmFuZ2VTZWFyY2ggPSB0cnVlO1xyXG4gICAgY29uc3Qgc2VhcmNoVmFsdWVzID0gKHNlYXJjaFRlcm1zLmxlbmd0aCA9PT0gMikgPyBzZWFyY2hUZXJtcyA6IChzZWFyY2hUZXJtc1swXSBhcyBzdHJpbmcpLnNwbGl0KCcuLicpO1xyXG4gICAgY29uc3Qgc2VhcmNoVmFsdWUxID0gKEFycmF5LmlzQXJyYXkoc2VhcmNoVmFsdWVzKSAmJiBzZWFyY2hWYWx1ZXNbMF0gfHwgJycpIGFzIERhdGUgfCBzdHJpbmc7XHJcbiAgICBjb25zdCBzZWFyY2hWYWx1ZTIgPSAoQXJyYXkuaXNBcnJheShzZWFyY2hWYWx1ZXMpICYmIHNlYXJjaFZhbHVlc1sxXSB8fCAnJykgYXMgRGF0ZSB8IHN0cmluZztcclxuICAgIGNvbnN0IHNlYXJjaFRlcm0xID0gbW9tZW50KHNlYXJjaFZhbHVlMSwgRk9STUFULCB0cnVlKTtcclxuICAgIGNvbnN0IHNlYXJjaFRlcm0yID0gbW9tZW50KHNlYXJjaFZhbHVlMiwgRk9STUFULCB0cnVlKTtcclxuXHJcbiAgICAvLyByZXR1cm4gaWYgYW55IG9mIHRoZSAyIHZhbHVlcyBhcmUgaW52YWxpZCBkYXRlc1xyXG4gICAgaWYgKCFtb21lbnQoc2VhcmNoVGVybTEsIEZPUk1BVCwgdHJ1ZSkuaXNWYWxpZCgpIHx8ICFtb21lbnQoc2VhcmNoVGVybTIsIEZPUk1BVCwgdHJ1ZSkuaXNWYWxpZCgpKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGRhdGVTZWFyY2gxID0gbW9tZW50KHNlYXJjaFRlcm0xLCBGT1JNQVQsIHRydWUpO1xyXG4gICAgZGF0ZVNlYXJjaDIgPSBtb21lbnQoc2VhcmNoVGVybTIsIEZPUk1BVCwgdHJ1ZSk7XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vIHJldHVybiBpZiB0aGUgc2VhcmNoIHRlcm0gaXMgYW4gaW52YWxpZCBkYXRlXHJcbiAgICBpZiAoIW1vbWVudChzZWFyY2hUZXJtc1swXSBhcyBEYXRlIHwgc3RyaW5nLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBkYXRlU2VhcmNoMSA9IG1vbWVudChzZWFyY2hUZXJtc1swXSBhcyBEYXRlIHwgc3RyaW5nLCBGT1JNQVQsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLy8gcnVuIHRoZSBmaWx0ZXIgY29uZGl0aW9uIHdpdGggZGF0ZSBpbiBVbml4IFRpbWVzdGFtcCBmb3JtYXRcclxuICBpZiAoaXNSYW5nZVNlYXJjaCkge1xyXG4gICAgY29uc3QgaXNJbmNsdXNpdmUgPSBvcHRpb25zLm9wZXJhdG9yICYmIG9wdGlvbnMub3BlcmF0b3IgPT09IE9wZXJhdG9yVHlwZS5yYW5nZUluY2x1c2l2ZTtcclxuICAgIGNvbnN0IHJlc3VsdENvbmRpdGlvbjEgPSB0ZXN0RmlsdGVyQ29uZGl0aW9uKChpc0luY2x1c2l2ZSA/ICc+PScgOiAnPicpLCBwYXJzZUludChkYXRlQ2VsbC5mb3JtYXQoJ1gnKSwgMTApLCBwYXJzZUludChkYXRlU2VhcmNoMS5mb3JtYXQoJ1gnKSwgMTApKTtcclxuICAgIGNvbnN0IHJlc3VsdENvbmRpdGlvbjIgPSB0ZXN0RmlsdGVyQ29uZGl0aW9uKChpc0luY2x1c2l2ZSA/ICc8PScgOiAnPCcpLCBwYXJzZUludChkYXRlQ2VsbC5mb3JtYXQoJ1gnKSwgMTApLCBwYXJzZUludChkYXRlU2VhcmNoMi5mb3JtYXQoJ1gnKSwgMTApKTtcclxuICAgIHJldHVybiAocmVzdWx0Q29uZGl0aW9uMSAmJiByZXN1bHRDb25kaXRpb24yKTtcclxuICB9XHJcbiAgcmV0dXJuIHRlc3RGaWx0ZXJDb25kaXRpb24ob3B0aW9ucy5vcGVyYXRvciB8fCAnPT0nLCBwYXJzZUludChkYXRlQ2VsbC5mb3JtYXQoJ1gnKSwgMTApLCBwYXJzZUludChkYXRlU2VhcmNoMS5mb3JtYXQoJ1gnKSwgMTApKTtcclxufTtcclxuIl19