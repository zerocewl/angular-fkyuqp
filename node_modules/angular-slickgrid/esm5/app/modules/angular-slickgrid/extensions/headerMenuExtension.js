import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { Constants } from '../constants';
import { EmitterType, ExtensionName, } from '../models/index';
import { FilterService } from '../services/filter.service';
import { SortService } from '../services/sort.service';
import { SharedService } from '../services/shared.service';
import { ExtensionUtility } from './extensionUtility';
var HeaderMenuExtension = /** @class */ (function () {
    function HeaderMenuExtension(extensionUtility, filterService, sharedService, sortService, translate) {
        this.extensionUtility = extensionUtility;
        this.filterService = filterService;
        this.sharedService = sharedService;
        this.sortService = sortService;
        this.translate = translate;
        this._eventHandler = new Slick.EventHandler();
    }
    Object.defineProperty(HeaderMenuExtension.prototype, "eventHandler", {
        get: function () {
            return this._eventHandler;
        },
        enumerable: true,
        configurable: true
    });
    HeaderMenuExtension.prototype.dispose = function () {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
    };
    /** Get the instance of the SlickGrid addon (control or plugin). */
    HeaderMenuExtension.prototype.getAddonInstance = function () {
        return this._addon;
    };
    /**
     * Create the Header Menu and expose all the available hooks that user can subscribe (onCommand, onBeforeMenuShow, ...)
     * @param grid
     * @param dataView
     * @param columnDefinitions
     */
    HeaderMenuExtension.prototype.register = function () {
        var _this = this;
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.enableTranslate && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions) {
            // get locales provided by user in forRoot or else use default English locales via the Constants
            this._locales = this.sharedService.gridOptions && this.sharedService.gridOptions.locales || Constants.locales;
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.headerMenu);
            this.sharedService.gridOptions.headerMenu = tslib_1.__assign({}, this.getDefaultHeaderMenuOptions(), this.sharedService.gridOptions.headerMenu);
            if (this.sharedService.gridOptions.enableHeaderMenu) {
                this.sharedService.gridOptions.headerMenu = this.addHeaderMenuCustomCommands(this.sharedService.gridOptions, this.sharedService.columnDefinitions);
            }
            this._addon = new Slick.Plugins.HeaderMenu(this.sharedService.gridOptions.headerMenu);
            this.sharedService.grid.registerPlugin(this._addon);
            // hook all events
            if (this.sharedService.grid && this.sharedService.gridOptions.headerMenu) {
                if (this.sharedService.gridOptions.headerMenu.onExtensionRegistered) {
                    this.sharedService.gridOptions.headerMenu.onExtensionRegistered(this._addon);
                }
                this._eventHandler.subscribe(this._addon.onCommand, function (e, args) {
                    _this.executeHeaderMenuInternalCommands(e, args);
                    if (_this.sharedService.gridOptions.headerMenu && typeof _this.sharedService.gridOptions.headerMenu.onCommand === 'function') {
                        _this.sharedService.gridOptions.headerMenu.onCommand(e, args);
                    }
                });
                if (this.sharedService.gridOptions.headerMenu && typeof this.sharedService.gridOptions.headerMenu.onBeforeMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuShow, function (e, args) {
                        _this.sharedService.gridOptions.headerMenu.onBeforeMenuShow(e, args);
                    });
                }
                if (this.sharedService.gridOptions.headerMenu && typeof this.sharedService.gridOptions.headerMenu.onAfterMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onAfterMenuShow, function (e, args) {
                        _this.sharedService.gridOptions.headerMenu.onAfterMenuShow(e, args);
                    });
                }
            }
            return this._addon;
        }
        return null;
    };
    /**
     * Create Header Menu with Custom Commands if user has enabled Header Menu
     * @param options
     * @param columnDefinitions
     * @return header menu
     */
    HeaderMenuExtension.prototype.addHeaderMenuCustomCommands = function (options, columnDefinitions) {
        var _this = this;
        var headerMenuOptions = options.headerMenu || {};
        if (columnDefinitions && Array.isArray(columnDefinitions) && options.enableHeaderMenu) {
            columnDefinitions.forEach(function (columnDef) {
                if (columnDef && !columnDef.excludeFromHeaderMenu) {
                    if (!columnDef.header || !columnDef.header.menu) {
                        columnDef.header = {
                            menu: {
                                items: []
                            }
                        };
                    }
                    var columnHeaderMenuItems = columnDef && columnDef.header && columnDef.header.menu && columnDef.header.menu.items || [];
                    // Sorting Commands
                    if (options.enableSorting && columnDef.sortable && headerMenuOptions && !headerMenuOptions.hideSortCommands) {
                        if (columnHeaderMenuItems.filter(function (item) { return item.hasOwnProperty('command') && item.command === 'sort-asc'; }).length === 0) {
                            columnHeaderMenuItems.push({
                                iconCssClass: headerMenuOptions.iconSortAscCommand || 'fa fa-sort-asc',
                                title: options.enableTranslate ? _this.translate.instant('SORT_ASCENDING') : _this._locales && _this._locales.TEXT_SORT_ASCENDING,
                                command: 'sort-asc',
                                positionOrder: 50
                            });
                        }
                        if (columnHeaderMenuItems.filter(function (item) { return item.hasOwnProperty('command') && item.command === 'sort-desc'; }).length === 0) {
                            columnHeaderMenuItems.push({
                                iconCssClass: headerMenuOptions.iconSortDescCommand || 'fa fa-sort-desc',
                                title: options.enableTranslate ? _this.translate.instant('SORT_DESCENDING') : _this._locales && _this._locales.TEXT_SORT_DESCENDING,
                                command: 'sort-desc',
                                positionOrder: 51
                            });
                        }
                        // add a divider (separator) between the top sort commands and the other clear commands
                        if (columnHeaderMenuItems.filter(function (item) { return item.hasOwnProperty('command') && item.positionOrder === 52; }).length === 0) {
                            columnHeaderMenuItems.push({ divider: true, command: '', positionOrder: 52 });
                        }
                        if (!headerMenuOptions.hideClearSortCommand && columnHeaderMenuItems.filter(function (item) { return item.hasOwnProperty('command') && item.command === 'clear-sort'; }).length === 0) {
                            columnHeaderMenuItems.push({
                                iconCssClass: headerMenuOptions.iconClearSortCommand || 'fa fa-unsorted',
                                title: options.enableTranslate ? _this.translate.instant('REMOVE_SORT') : _this._locales && _this._locales.TEXT_REMOVE_SORT,
                                command: 'clear-sort',
                                positionOrder: 54
                            });
                        }
                    }
                    // Filtering Commands
                    if (options.enableFiltering && columnDef.filterable && headerMenuOptions && !headerMenuOptions.hideFilterCommands) {
                        if (!headerMenuOptions.hideClearFilterCommand && columnHeaderMenuItems.filter(function (item) { return item.hasOwnProperty('command') && item.command === 'clear-filter'; }).length === 0) {
                            columnHeaderMenuItems.push({
                                iconCssClass: headerMenuOptions.iconClearFilterCommand || 'fa fa-filter',
                                title: options.enableTranslate ? _this.translate.instant('REMOVE_FILTER') : _this._locales && _this._locales.TEXT_REMOVE_FILTER,
                                command: 'clear-filter',
                                positionOrder: 53
                            });
                        }
                    }
                    // Hide Column Command
                    if (headerMenuOptions && !headerMenuOptions.hideColumnHideCommand && columnHeaderMenuItems.filter(function (item) { return item.hasOwnProperty('command') && item.command === 'hide'; }).length === 0) {
                        columnHeaderMenuItems.push({
                            iconCssClass: headerMenuOptions.iconColumnHideCommand || 'fa fa-times',
                            title: options.enableTranslate ? _this.translate.instant('HIDE_COLUMN') : _this._locales && _this._locales.TEXT_HIDE_COLUMN,
                            command: 'hide',
                            positionOrder: 55
                        });
                    }
                    _this.extensionUtility.translateItems(columnHeaderMenuItems, 'titleKey', 'title');
                    _this.extensionUtility.sortItems(columnHeaderMenuItems, 'positionOrder');
                }
            });
        }
        return headerMenuOptions;
    };
    /** Hide a column from the grid */
    HeaderMenuExtension.prototype.hideColumn = function (column) {
        if (this.sharedService.grid && this.sharedService.grid.getColumns && this.sharedService.grid.setColumns && this.sharedService.grid.getColumnIndex) {
            var columnIndex = this.sharedService.grid.getColumnIndex(column.id);
            var currentColumns = this.sharedService.grid.getColumns();
            var visibleColumns = this.extensionUtility.arrayRemoveItemByIndex(currentColumns, columnIndex);
            this.sharedService.visibleColumns = visibleColumns;
            this.sharedService.grid.setColumns(visibleColumns);
            this.sharedService.onColumnsChanged.next(visibleColumns);
        }
    };
    /**
     * Translate the Header Menu titles, we need to loop through all column definition to re-translate them
     */
    HeaderMenuExtension.prototype.translateHeaderMenu = function () {
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.headerMenu) {
            this.resetHeaderMenuTranslations(this.sharedService.visibleColumns);
        }
    };
    // --
    // private functions
    // ------------------
    /** @return default Header Menu options */
    HeaderMenuExtension.prototype.getDefaultHeaderMenuOptions = function () {
        return {
            autoAlignOffset: 12,
            minWidth: 140,
            hideColumnHideCommand: false,
            hideSortCommands: false,
            title: ''
        };
    };
    /**
     * Reset all the internal Menu options which have text to translate
     * @param header menu object
     */
    HeaderMenuExtension.prototype.resetHeaderMenuTranslations = function (columnDefinitions) {
        var _this = this;
        columnDefinitions.forEach(function (columnDef) {
            if (columnDef && columnDef.header && columnDef.header && columnDef.header.menu && columnDef.header.menu.items) {
                if (!columnDef.excludeFromHeaderMenu) {
                    var columnHeaderMenuItems_1 = columnDef.header.menu.items || [];
                    columnHeaderMenuItems_1.forEach(function (item) {
                        if (item.hasOwnProperty('command')) {
                            switch (item.command) {
                                case 'clear-filter':
                                    item.title = _this.translate.instant('REMOVE_FILTER') || _this._locales && _this._locales.TEXT_REMOVE_FILTER;
                                    break;
                                case 'clear-sort':
                                    item.title = _this.translate.instant('REMOVE_SORT') || _this._locales && _this._locales.TEXT_REMOVE_SORT;
                                    break;
                                case 'sort-asc':
                                    item.title = _this.translate.instant('SORT_ASCENDING') || _this._locales && _this._locales.TEXT_SORT_ASCENDING;
                                    break;
                                case 'sort-desc':
                                    item.title = _this.translate.instant('SORT_DESCENDING') || _this._locales && _this._locales.TEXT_SORT_DESCENDING;
                                    break;
                                case 'hide':
                                    item.title = _this.translate.instant('HIDE_COLUMN') || _this._locales && _this._locales.TEXT_HIDE_COLUMN;
                                    break;
                            }
                        }
                        // re-translate if there's a "titleKey"
                        if (_this.sharedService.gridOptions && _this.sharedService.gridOptions.enableTranslate) {
                            _this.extensionUtility.translateItems(columnHeaderMenuItems_1, 'titleKey', 'title');
                        }
                    });
                }
            }
        });
    };
    /** Clear the Filter on the current column (if it's actually filtered) */
    HeaderMenuExtension.prototype.clearColumnFilter = function (event, args) {
        if (args && args.column) {
            this.filterService.clearFilterByColumnId(event, args.column.id);
        }
    };
    /** Clear the Sort on the current column (if it's actually sorted) */
    HeaderMenuExtension.prototype.clearColumnSort = function (event, args) {
        if (args && args.column && this.sharedService) {
            // get current sorted columns, prior to calling the new column sort
            var allSortedCols = this.sortService.getCurrentColumnSorts();
            var sortedColsWithoutCurrent = this.sortService.getCurrentColumnSorts(args.column.id + '');
            if (Array.isArray(allSortedCols) && Array.isArray(sortedColsWithoutCurrent) && allSortedCols.length !== sortedColsWithoutCurrent.length) {
                if (this.sharedService.gridOptions && this.sharedService.gridOptions.backendServiceApi) {
                    this.sortService.onBackendSortChanged(event, { multiColumnSort: true, sortCols: sortedColsWithoutCurrent, grid: this.sharedService.grid });
                }
                else if (this.sharedService.dataView) {
                    this.sortService.onLocalSortChanged(this.sharedService.grid, this.sharedService.dataView, sortedColsWithoutCurrent, true);
                }
                else {
                    // when using customDataView, we will simply send it as a onSort event with notify
                    var isMultiSort = this.sharedService.gridOptions && this.sharedService.gridOptions.multiColumnSort || false;
                    var sortOutput = isMultiSort ? sortedColsWithoutCurrent : sortedColsWithoutCurrent[0];
                    args.grid.onSort.notify(sortOutput);
                }
                // update the this.sharedService.gridObj sortColumns array which will at the same add the visual sort icon(s) on the UI
                var updatedSortColumns = sortedColsWithoutCurrent.map(function (col) {
                    return {
                        columnId: col && col.sortCol && col.sortCol.id,
                        sortAsc: col && col.sortAsc,
                        sortCol: col && col.sortCol,
                    };
                });
                this.sharedService.grid.setSortColumns(updatedSortColumns); // add sort icon in UI
            }
        }
    };
    /** Execute the Header Menu Commands that was triggered by the onCommand subscribe */
    HeaderMenuExtension.prototype.executeHeaderMenuInternalCommands = function (event, args) {
        if (args && args.command) {
            switch (args.command) {
                case 'hide':
                    this.hideColumn(args.column);
                    if (this.sharedService.gridOptions && this.sharedService.gridOptions.enableAutoSizeColumns) {
                        this.sharedService.grid.autosizeColumns();
                    }
                    break;
                case 'clear-filter':
                    this.clearColumnFilter(event, args);
                    break;
                case 'clear-sort':
                    this.clearColumnSort(event, args);
                    break;
                case 'sort-asc':
                case 'sort-desc':
                    var isSortingAsc = (args.command === 'sort-asc');
                    this.sortColumn(event, args, isSortingAsc);
                    break;
                default:
                    break;
            }
        }
    };
    /** Sort the current column */
    HeaderMenuExtension.prototype.sortColumn = function (event, args, isSortingAsc) {
        if (isSortingAsc === void 0) { isSortingAsc = true; }
        if (args && args.column) {
            // get previously sorted columns
            var sortedColsWithoutCurrent = this.sortService.getCurrentColumnSorts(args.column.id + '');
            var emitterType = void 0;
            // add to the column array, the column sorted by the header menu
            sortedColsWithoutCurrent.push({ sortCol: args.column, sortAsc: isSortingAsc });
            if (this.sharedService.gridOptions.backendServiceApi) {
                this.sortService.onBackendSortChanged(event, { multiColumnSort: true, sortCols: sortedColsWithoutCurrent, grid: this.sharedService.grid });
                emitterType = EmitterType.remote;
            }
            else if (this.sharedService.dataView) {
                this.sortService.onLocalSortChanged(this.sharedService.grid, this.sharedService.dataView, sortedColsWithoutCurrent);
                emitterType = EmitterType.local;
            }
            else {
                // when using customDataView, we will simply send it as a onSort event with notify
                var isMultiSort = this.sharedService && this.sharedService.gridOptions && this.sharedService.gridOptions.multiColumnSort || false;
                var sortOutput = isMultiSort ? sortedColsWithoutCurrent : sortedColsWithoutCurrent[0];
                args.grid.onSort.notify(sortOutput);
            }
            // update the this.sharedService.gridObj sortColumns array which will at the same add the visual sort icon(s) on the UI
            var newSortColumns = sortedColsWithoutCurrent.map(function (col) {
                return {
                    columnId: col && col.sortCol && col.sortCol.id,
                    sortAsc: col && col.sortAsc,
                    sortCol: col && col.sortCol,
                };
            });
            // add sort icon in UI
            this.sharedService.grid.setSortColumns(newSortColumns);
            // if we have an emitter type set, we will emit a sort changed
            // for the Grid State Service to see the change.
            // We also need to pass current sorters changed to the emitSortChanged method
            if (emitterType) {
                var currentLocalSorters_1 = [];
                newSortColumns.forEach(function (sortCol) {
                    currentLocalSorters_1.push({
                        columnId: sortCol.columnId + '',
                        direction: sortCol.sortAsc ? 'ASC' : 'DESC'
                    });
                });
                this.sortService.emitSortChanged(emitterType, currentLocalSorters_1);
            }
        }
    };
    HeaderMenuExtension = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(4, Optional()),
        tslib_1.__metadata("design:paramtypes", [ExtensionUtility,
            FilterService,
            SharedService,
            SortService,
            TranslateService])
    ], HeaderMenuExtension);
    return HeaderMenuExtension;
}());
export { HeaderMenuExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhZGVyTWVudUV4dGVuc2lvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvZXh0ZW5zaW9ucy9oZWFkZXJNZW51RXh0ZW5zaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3pDLE9BQU8sRUFJTCxXQUFXLEVBRVgsYUFBYSxHQU9kLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzNELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFNdEQ7SUFLRSw2QkFDVSxnQkFBa0MsRUFDbEMsYUFBNEIsRUFDNUIsYUFBNEIsRUFDNUIsV0FBd0IsRUFDWixTQUEyQjtRQUp2QyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ1osY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFFL0MsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNoRCxDQUFDO0lBRUQsc0JBQUksNkNBQVk7YUFBaEI7WUFDRSxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFF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REFBZ0Q7WUFDaEQsNkVBQTZFO1lBQzdFLElBQUksV0FBVyxFQUFFO2dCQUNmLElBQU0scUJBQW1CLEdBQW9CLEVBQUUsQ0FBQztnQkFDaEQsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFDLE9BQU87b0JBQzdCLHFCQUFtQixDQUFDLElBQUksQ0FBQzt3QkFDdkIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEdBQUcsRUFBRTt3QkFDL0IsU0FBUyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTTtxQkFDNUMsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUNILElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxxQkFBbUIsQ0FBQyxDQUFDO2FBQ3BFO1NBQ0Y7SUFDSCxDQUFDO0lBeldVLG1CQUFtQjtRQUQvQixVQUFVLEVBQUU7UUFXUixtQkFBQSxRQUFRLEVBQUUsQ0FBQTtpREFKZSxnQkFBZ0I7WUFDbkIsYUFBYTtZQUNiLGFBQWE7WUFDZixXQUFXO1lBQ0QsZ0JBQWdCO09BVnRDLG1CQUFtQixDQTBXL0I7SUFBRCwwQkFBQztDQUFBLEFBMVdELElBMFdDO1NBMVdZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcclxuaW1wb3J0IHsgQ29uc3RhbnRzIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcclxuaW1wb3J0IHtcclxuICBDb2x1bW4sXHJcbiAgQ29sdW1uU29ydCxcclxuICBDdXJyZW50U29ydGVyLFxyXG4gIEVtaXR0ZXJUeXBlLFxyXG4gIEV4dGVuc2lvbixcclxuICBFeHRlbnNpb25OYW1lLFxyXG4gIEdyaWRPcHRpb24sXHJcbiAgSGVhZGVyTWVudSxcclxuICBMb2NhbGUsXHJcbiAgTWVudUNvbW1hbmRJdGVtLFxyXG4gIE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncyxcclxuICBTbGlja0V2ZW50SGFuZGxlcixcclxufSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBGaWx0ZXJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZmlsdGVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTb3J0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3NvcnQuc2VydmljZSc7XHJcbmltcG9ydCB7IFNoYXJlZFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zaGFyZWQuc2VydmljZSc7XHJcbmltcG9ydCB7IEV4dGVuc2lvblV0aWxpdHkgfSBmcm9tICcuL2V4dGVuc2lvblV0aWxpdHknO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIHZhciBTbGljazogYW55O1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgSGVhZGVyTWVudUV4dGVuc2lvbiBpbXBsZW1lbnRzIEV4dGVuc2lvbiB7XHJcbiAgcHJpdmF0ZSBfYWRkb246IGFueTtcclxuICBwcml2YXRlIF9ldmVudEhhbmRsZXI6IFNsaWNrRXZlbnRIYW5kbGVyO1xyXG4gIHByaXZhdGUgX2xvY2FsZXM6IExvY2FsZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGV4dGVuc2lvblV0aWxpdHk6IEV4dGVuc2lvblV0aWxpdHksXHJcbiAgICBwcml2YXRlIGZpbHRlclNlcnZpY2U6IEZpbHRlclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHNoYXJlZFNlcnZpY2U6IFNoYXJlZFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHNvcnRTZXJ2aWNlOiBTb3J0U2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyID0gbmV3IFNsaWNrLkV2ZW50SGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGV2ZW50SGFuZGxlcigpOiBTbGlja0V2ZW50SGFuZGxlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRIYW5kbGVyO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIC8vIHVuc3Vic2NyaWJlIGFsbCBTbGlja0dyaWQgZXZlbnRzXHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIudW5zdWJzY3JpYmVBbGwoKTtcclxuICAgIGlmICh0aGlzLl9hZGRvbiAmJiB0aGlzLl9hZGRvbi5kZXN0cm95KSB7XHJcbiAgICAgIHRoaXMuX2FkZG9uLmRlc3Ryb3koKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKiBHZXQgdGhlIGluc3RhbmNlIG9mIHRoZSBTbGlja0dyaWQgYWRkb24gKGNvbnRyb2wgb3IgcGx1Z2luKS4gKi9cclxuICBnZXRBZGRvbkluc3RhbmNlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2FkZG9uO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIHRoZSBIZWFkZXIgTWVudSBhbmQgZXhwb3NlIGFsbCB0aGUgYXZhaWxhYmxlIGhvb2tzIHRoYXQgdXNlciBjYW4gc3Vic2NyaWJlIChvbkNvbW1hbmQsIG9uQmVmb3JlTWVudVNob3csIC4uLilcclxuICAgKiBAcGFyYW0gZ3JpZFxyXG4gICAqIEBwYXJhbSBkYXRhVmlld1xyXG4gICAqIEBwYXJhbSBjb2x1bW5EZWZpbml0aW9uc1xyXG4gICAqL1xyXG4gIHJlZ2lzdGVyKCk6IGFueSB7XHJcbiAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5lbmFibGVUcmFuc2xhdGUgJiYgKCF0aGlzLnRyYW5zbGF0ZSB8fCAhdGhpcy50cmFuc2xhdGUuaW5zdGFudCkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdbQW5ndWxhci1TbGlja2dyaWRdIHJlcXVpcmVzIFwibmd4LXRyYW5zbGF0ZVwiIHRvIGJlIGluc3RhbGxlZCBhbmQgY29uZmlndXJlZCB3aGVuIHRoZSBncmlkIG9wdGlvbiBcImVuYWJsZVRyYW5zbGF0ZVwiIGlzIGVuYWJsZWQuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMpIHtcclxuICAgICAgLy8gZ2V0IGxvY2FsZXMgcHJvdmlkZWQgYnkgdXNlciBpbiBmb3JSb290IG9yIGVsc2UgdXNlIGRlZmF1bHQgRW5nbGlzaCBsb2NhbGVzIHZpYSB0aGUgQ29uc3RhbnRzXHJcbiAgICAgIHRoaXMuX2xvY2FsZXMgPSB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmxvY2FsZXMgfHwgQ29uc3RhbnRzLmxvY2FsZXM7XHJcblxyXG4gICAgICAvLyBkeW5hbWljYWxseSBpbXBvcnQgdGhlIFNsaWNrR3JpZCBwbHVnaW4gKGFkZG9uKSB3aXRoIFJlcXVpcmVKU1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkubG9hZEV4dGVuc2lvbkR5bmFtaWNhbGx5KEV4dGVuc2lvbk5hbWUuaGVhZGVyTWVudSk7XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51ID0geyAuLi50aGlzLmdldERlZmF1bHRIZWFkZXJNZW51T3B0aW9ucygpLCAuLi50aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudSB9O1xyXG4gICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmVuYWJsZUhlYWRlck1lbnUpIHtcclxuICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudSA9IHRoaXMuYWRkSGVhZGVyTWVudUN1c3RvbUNvbW1hbmRzKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucywgdGhpcy5zaGFyZWRTZXJ2aWNlLmNvbHVtbkRlZmluaXRpb25zKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5fYWRkb24gPSBuZXcgU2xpY2suUGx1Z2lucy5IZWFkZXJNZW51KHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51KTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQucmVnaXN0ZXJQbHVnaW4odGhpcy5fYWRkb24pO1xyXG5cclxuICAgICAgLy8gaG9vayBhbGwgZXZlbnRzXHJcbiAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudSkge1xyXG4gICAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudS5vbkV4dGVuc2lvblJlZ2lzdGVyZWQpIHtcclxuICAgICAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51Lm9uRXh0ZW5zaW9uUmVnaXN0ZXJlZCh0aGlzLl9hZGRvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25Db21tYW5kLCAoZTogYW55LCBhcmdzOiBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MpID0+IHtcclxuICAgICAgICAgIHRoaXMuZXhlY3V0ZUhlYWRlck1lbnVJbnRlcm5hbENvbW1hbmRzKGUsIGFyZ3MpO1xyXG4gICAgICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51ICYmIHR5cGVvZiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudS5vbkNvbW1hbmQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmhlYWRlck1lbnUub25Db21tYW5kKGUsIGFyZ3MpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudSAmJiB0eXBlb2YgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmhlYWRlck1lbnUub25CZWZvcmVNZW51U2hvdyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkJlZm9yZU1lbnVTaG93LCAoZTogRXZlbnQsIGFyZ3M6IHsgZ3JpZDogYW55OyBjb2x1bW46IENvbHVtbjsgbWVudTogYW55OyB9KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51Lm9uQmVmb3JlTWVudVNob3coZSwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51ICYmIHR5cGVvZiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuaGVhZGVyTWVudS5vbkFmdGVyTWVudVNob3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25BZnRlck1lbnVTaG93LCAoZTogRXZlbnQsIGFyZ3M6IHsgZ3JpZDogYW55OyBjb2x1bW46IENvbHVtbjsgbWVudTogYW55OyB9KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5oZWFkZXJNZW51Lm9uQWZ0ZXJNZW51U2hvdyhlLCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZSBIZWFkZXIgTWVudSB3aXRoIEN1c3RvbSBDb21tYW5kcyBpZiB1c2VyIGhhcyBlbmFibGVkIEhlYWRlciBNZW51XHJcbiAgICogQHBhcmFtIG9wdGlvbnNcclxuICAgKiBAcGFyYW0gY29sdW1uRGVmaW5pdGlvbnNcclxuICAgKiBAcmV0dXJuIGhlYWRlciBtZW51XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhZGRIZWFkZXJNZW51Q3VzdG9tQ29tbWFuZHMob3B0aW9uczogR3JpZE9wdGlvbiwgY29sdW1uRGVmaW5pdGlvbnM6IENvbHVtbltdKTogSGVhZGVyTWVudSB7XHJcbiAgICBjb25zdCBoZWFkZXJNZW51T3B0aW9ucyA9IG9wdGlvbnMuaGVhZGVyTWVudSB8fCB7fTtcclxuXHJcbiAgICBpZiAoY29sdW1uRGVmaW5pdGlvbnMgJiYgQXJyYXkuaXNBcnJheShjb2x1bW5EZWZpbml0aW9ucykgJiYgb3B0aW9ucy5lbmFibGVIZWFkZXJNZW51KSB7XHJcbiAgICAgIGNvbHVtbkRlZmluaXRpb25zLmZvckVhY2goKGNvbHVtbkRlZjogQ29sdW1uKSA9PiB7XHJcbiAgICAgICAgaWYgKGNvbHVtbkRlZiAmJiAhY29sdW1uRGVmLmV4Y2x1ZGVGcm9tSGVhZGVyTWVudSkge1xyXG4gICAgICAgICAgaWYgKCFjb2x1bW5EZWYuaGVhZGVyIHx8ICFjb2x1bW5EZWYuaGVhZGVyLm1lbnUpIHtcclxuICAgICAgICAgICAgY29sdW1uRGVmLmhlYWRlciA9IHtcclxuICAgICAgICAgICAgICBtZW51OiB7XHJcbiAgICAgICAgICAgICAgICBpdGVtczogW11cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgY29uc3QgY29sdW1uSGVhZGVyTWVudUl0ZW1zOiBBcnJheTxNZW51Q29tbWFuZEl0ZW0gfCAnZGl2aWRlcic+ID0gY29sdW1uRGVmICYmIGNvbHVtbkRlZi5oZWFkZXIgJiYgY29sdW1uRGVmLmhlYWRlci5tZW51ICYmIGNvbHVtbkRlZi5oZWFkZXIubWVudS5pdGVtcyB8fCBbXTtcclxuXHJcbiAgICAgICAgICAvLyBTb3J0aW5nIENvbW1hbmRzXHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5lbmFibGVTb3J0aW5nICYmIGNvbHVtbkRlZi5zb3J0YWJsZSAmJiBoZWFkZXJNZW51T3B0aW9ucyAmJiAhaGVhZGVyTWVudU9wdGlvbnMuaGlkZVNvcnRDb21tYW5kcykge1xyXG4gICAgICAgICAgICBpZiAoY29sdW1uSGVhZGVyTWVudUl0ZW1zLmZpbHRlcigoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSAnc29ydC1hc2MnKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICBjb2x1bW5IZWFkZXJNZW51SXRlbXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGhlYWRlck1lbnVPcHRpb25zLmljb25Tb3J0QXNjQ29tbWFuZCB8fCAnZmEgZmEtc29ydC1hc2MnLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IG9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlID8gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnU09SVF9BU0NFTkRJTkcnKSA6IHRoaXMuX2xvY2FsZXMgJiYgdGhpcy5fbG9jYWxlcy5URVhUX1NPUlRfQVNDRU5ESU5HLFxyXG4gICAgICAgICAgICAgICAgY29tbWFuZDogJ3NvcnQtYXNjJyxcclxuICAgICAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDUwXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNvbHVtbkhlYWRlck1lbnVJdGVtcy5maWx0ZXIoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gJ3NvcnQtZGVzYycpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIGNvbHVtbkhlYWRlck1lbnVJdGVtcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIGljb25Dc3NDbGFzczogaGVhZGVyTWVudU9wdGlvbnMuaWNvblNvcnREZXNjQ29tbWFuZCB8fCAnZmEgZmEtc29ydC1kZXNjJyxcclxuICAgICAgICAgICAgICAgIHRpdGxlOiBvcHRpb25zLmVuYWJsZVRyYW5zbGF0ZSA/IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ1NPUlRfREVTQ0VORElORycpIDogdGhpcy5fbG9jYWxlcyAmJiB0aGlzLl9sb2NhbGVzLlRFWFRfU09SVF9ERVNDRU5ESU5HLFxyXG4gICAgICAgICAgICAgICAgY29tbWFuZDogJ3NvcnQtZGVzYycsXHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBhZGQgYSBkaXZpZGVyIChzZXBhcmF0b3IpIGJldHdlZW4gdGhlIHRvcCBzb3J0IGNvbW1hbmRzIGFuZCB0aGUgb3RoZXIgY2xlYXIgY29tbWFuZHNcclxuICAgICAgICAgICAgaWYgKGNvbHVtbkhlYWRlck1lbnVJdGVtcy5maWx0ZXIoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0ucG9zaXRpb25PcmRlciA9PT0gNTIpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIGNvbHVtbkhlYWRlck1lbnVJdGVtcy5wdXNoKHsgZGl2aWRlcjogdHJ1ZSwgY29tbWFuZDogJycsIHBvc2l0aW9uT3JkZXI6IDUyIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoIWhlYWRlck1lbnVPcHRpb25zLmhpZGVDbGVhclNvcnRDb21tYW5kICYmIGNvbHVtbkhlYWRlck1lbnVJdGVtcy5maWx0ZXIoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gJ2NsZWFyLXNvcnQnKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICBjb2x1bW5IZWFkZXJNZW51SXRlbXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGhlYWRlck1lbnVPcHRpb25zLmljb25DbGVhclNvcnRDb21tYW5kIHx8ICdmYSBmYS11bnNvcnRlZCcsXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogb3B0aW9ucy5lbmFibGVUcmFuc2xhdGUgPyB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdSRU1PVkVfU09SVCcpIDogdGhpcy5fbG9jYWxlcyAmJiB0aGlzLl9sb2NhbGVzLlRFWFRfUkVNT1ZFX1NPUlQsXHJcbiAgICAgICAgICAgICAgICBjb21tYW5kOiAnY2xlYXItc29ydCcsXHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NFxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgLy8gRmlsdGVyaW5nIENvbW1hbmRzXHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5lbmFibGVGaWx0ZXJpbmcgJiYgY29sdW1uRGVmLmZpbHRlcmFibGUgJiYgaGVhZGVyTWVudU9wdGlvbnMgJiYgIWhlYWRlck1lbnVPcHRpb25zLmhpZGVGaWx0ZXJDb21tYW5kcykge1xyXG4gICAgICAgICAgICBpZiAoIWhlYWRlck1lbnVPcHRpb25zLmhpZGVDbGVhckZpbHRlckNvbW1hbmQgJiYgY29sdW1uSGVhZGVyTWVudUl0ZW1zLmZpbHRlcigoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSAnY2xlYXItZmlsdGVyJykubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgY29sdW1uSGVhZGVyTWVudUl0ZW1zLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBoZWFkZXJNZW51T3B0aW9ucy5pY29uQ2xlYXJGaWx0ZXJDb21tYW5kIHx8ICdmYSBmYS1maWx0ZXInLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IG9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlID8gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnUkVNT1ZFX0ZJTFRFUicpIDogdGhpcy5fbG9jYWxlcyAmJiB0aGlzLl9sb2NhbGVzLlRFWFRfUkVNT1ZFX0ZJTFRFUixcclxuICAgICAgICAgICAgICAgIGNvbW1hbmQ6ICdjbGVhci1maWx0ZXInLFxyXG4gICAgICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTNcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIEhpZGUgQ29sdW1uIENvbW1hbmRcclxuICAgICAgICAgIGlmIChoZWFkZXJNZW51T3B0aW9ucyAmJiAhaGVhZGVyTWVudU9wdGlvbnMuaGlkZUNvbHVtbkhpZGVDb21tYW5kICYmIGNvbHVtbkhlYWRlck1lbnVJdGVtcy5maWx0ZXIoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gJ2hpZGUnKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgY29sdW1uSGVhZGVyTWVudUl0ZW1zLnB1c2goe1xyXG4gICAgICAgICAgICAgIGljb25Dc3NDbGFzczogaGVhZGVyTWVudU9wdGlvbnMuaWNvbkNvbHVtbkhpZGVDb21tYW5kIHx8ICdmYSBmYS10aW1lcycsXHJcbiAgICAgICAgICAgICAgdGl0bGU6IG9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlID8gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnSElERV9DT0xVTU4nKSA6IHRoaXMuX2xvY2FsZXMgJiYgdGhpcy5fbG9jYWxlcy5URVhUX0hJREVfQ09MVU1OLFxyXG4gICAgICAgICAgICAgIGNvbW1hbmQ6ICdoaWRlJyxcclxuICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlSXRlbXMoY29sdW1uSGVhZGVyTWVudUl0ZW1zLCAndGl0bGVLZXknLCAndGl0bGUnKTtcclxuICAgICAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5zb3J0SXRlbXMoY29sdW1uSGVhZGVyTWVudUl0ZW1zLCAncG9zaXRpb25PcmRlcicpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGVhZGVyTWVudU9wdGlvbnM7XHJcbiAgfVxyXG5cclxuICAvKiogSGlkZSBhIGNvbHVtbiBmcm9tIHRoZSBncmlkICovXHJcbiAgaGlkZUNvbHVtbihjb2x1bW46IENvbHVtbikge1xyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLmdldENvbHVtbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQuc2V0Q29sdW1ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZC5nZXRDb2x1bW5JbmRleCkge1xyXG4gICAgICBjb25zdCBjb2x1bW5JbmRleCA9IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLmdldENvbHVtbkluZGV4KGNvbHVtbi5pZCk7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5zID0gdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQuZ2V0Q29sdW1ucygpIGFzIENvbHVtbltdO1xyXG4gICAgICBjb25zdCB2aXNpYmxlQ29sdW1ucyA9IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5hcnJheVJlbW92ZUl0ZW1CeUluZGV4KGN1cnJlbnRDb2x1bW5zLCBjb2x1bW5JbmRleCk7XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS52aXNpYmxlQ29sdW1ucyA9IHZpc2libGVDb2x1bW5zO1xyXG4gICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZC5zZXRDb2x1bW5zKHZpc2libGVDb2x1bW5zKTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLm9uQ29sdW1uc0NoYW5nZWQubmV4dCh2aXNpYmxlQ29sdW1ucyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUcmFuc2xhdGUgdGhlIEhlYWRlciBNZW51IHRpdGxlcywgd2UgbmVlZCB0byBsb29wIHRocm91Z2ggYWxsIGNvbHVtbiBkZWZpbml0aW9uIHRvIHJlLXRyYW5zbGF0ZSB0aGVtXHJcbiAgICovXHJcbiAgdHJhbnNsYXRlSGVhZGVyTWVudSgpIHtcclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmhlYWRlck1lbnUpIHtcclxuICAgICAgdGhpcy5yZXNldEhlYWRlck1lbnVUcmFuc2xhdGlvbnModGhpcy5zaGFyZWRTZXJ2aWNlLnZpc2libGVDb2x1bW5zKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIC0tXHJcbiAgLy8gcHJpdmF0ZSBmdW5jdGlvbnNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgLyoqIEByZXR1cm4gZGVmYXVsdCBIZWFkZXIgTWVudSBvcHRpb25zICovXHJcbiAgcHJpdmF0ZSBnZXREZWZhdWx0SGVhZGVyTWVudU9wdGlvbnMoKTogSGVhZGVyTWVudSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBhdXRvQWxpZ25PZmZzZXQ6IDEyLFxyXG4gICAgICBtaW5XaWR0aDogMTQwLFxyXG4gICAgICBoaWRlQ29sdW1uSGlkZUNvbW1hbmQ6IGZhbHNlLFxyXG4gICAgICBoaWRlU29ydENvbW1hbmRzOiBmYWxzZSxcclxuICAgICAgdGl0bGU6ICcnXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzZXQgYWxsIHRoZSBpbnRlcm5hbCBNZW51IG9wdGlvbnMgd2hpY2ggaGF2ZSB0ZXh0IHRvIHRyYW5zbGF0ZVxyXG4gICAqIEBwYXJhbSBoZWFkZXIgbWVudSBvYmplY3RcclxuICAgKi9cclxuICBwcml2YXRlIHJlc2V0SGVhZGVyTWVudVRyYW5zbGF0aW9ucyhjb2x1bW5EZWZpbml0aW9uczogQ29sdW1uW10pIHtcclxuICAgIGNvbHVtbkRlZmluaXRpb25zLmZvckVhY2goKGNvbHVtbkRlZjogQ29sdW1uKSA9PiB7XHJcbiAgICAgIGlmIChjb2x1bW5EZWYgJiYgY29sdW1uRGVmLmhlYWRlciAmJiBjb2x1bW5EZWYuaGVhZGVyICYmIGNvbHVtbkRlZi5oZWFkZXIubWVudSAmJiBjb2x1bW5EZWYuaGVhZGVyLm1lbnUuaXRlbXMpIHtcclxuICAgICAgICBpZiAoIWNvbHVtbkRlZi5leGNsdWRlRnJvbUhlYWRlck1lbnUpIHtcclxuICAgICAgICAgIGNvbnN0IGNvbHVtbkhlYWRlck1lbnVJdGVtczogQXJyYXk8TWVudUNvbW1hbmRJdGVtIHwgJ2RpdmlkZXInPiA9IGNvbHVtbkRlZi5oZWFkZXIubWVudS5pdGVtcyB8fCBbXTtcclxuICAgICAgICAgIGNvbHVtbkhlYWRlck1lbnVJdGVtcy5mb3JFYWNoKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IHtcclxuICAgICAgICAgICAgaWYgKGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSkge1xyXG4gICAgICAgICAgICAgIHN3aXRjaCAoaXRlbS5jb21tYW5kKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdjbGVhci1maWx0ZXInOlxyXG4gICAgICAgICAgICAgICAgICBpdGVtLnRpdGxlID0gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnUkVNT1ZFX0ZJTFRFUicpIHx8IHRoaXMuX2xvY2FsZXMgJiYgdGhpcy5fbG9jYWxlcy5URVhUX1JFTU9WRV9GSUxURVI7XHJcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnY2xlYXItc29ydCc6XHJcbiAgICAgICAgICAgICAgICAgIGl0ZW0udGl0bGUgPSB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdSRU1PVkVfU09SVCcpIHx8IHRoaXMuX2xvY2FsZXMgJiYgdGhpcy5fbG9jYWxlcy5URVhUX1JFTU9WRV9TT1JUO1xyXG4gICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3NvcnQtYXNjJzpcclxuICAgICAgICAgICAgICAgICAgaXRlbS50aXRsZSA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ1NPUlRfQVNDRU5ESU5HJykgfHwgdGhpcy5fbG9jYWxlcyAmJiB0aGlzLl9sb2NhbGVzLlRFWFRfU09SVF9BU0NFTkRJTkc7XHJcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnc29ydC1kZXNjJzpcclxuICAgICAgICAgICAgICAgICAgaXRlbS50aXRsZSA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ1NPUlRfREVTQ0VORElORycpIHx8IHRoaXMuX2xvY2FsZXMgJiYgdGhpcy5fbG9jYWxlcy5URVhUX1NPUlRfREVTQ0VORElORztcclxuICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdoaWRlJzpcclxuICAgICAgICAgICAgICAgICAgaXRlbS50aXRsZSA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQoJ0hJREVfQ09MVU1OJykgfHwgdGhpcy5fbG9jYWxlcyAmJiB0aGlzLl9sb2NhbGVzLlRFWFRfSElERV9DT0xVTU47XHJcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gcmUtdHJhbnNsYXRlIGlmIHRoZXJlJ3MgYSBcInRpdGxlS2V5XCJcclxuICAgICAgICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZUl0ZW1zKGNvbHVtbkhlYWRlck1lbnVJdGVtcywgJ3RpdGxlS2V5JywgJ3RpdGxlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKiogQ2xlYXIgdGhlIEZpbHRlciBvbiB0aGUgY3VycmVudCBjb2x1bW4gKGlmIGl0J3MgYWN0dWFsbHkgZmlsdGVyZWQpICovXHJcbiAgcHJpdmF0ZSBjbGVhckNvbHVtbkZpbHRlcihldmVudDogRXZlbnQsIGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykge1xyXG4gICAgaWYgKGFyZ3MgJiYgYXJncy5jb2x1bW4pIHtcclxuICAgICAgdGhpcy5maWx0ZXJTZXJ2aWNlLmNsZWFyRmlsdGVyQnlDb2x1bW5JZChldmVudCwgYXJncy5jb2x1bW4uaWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIENsZWFyIHRoZSBTb3J0IG9uIHRoZSBjdXJyZW50IGNvbHVtbiAoaWYgaXQncyBhY3R1YWxseSBzb3J0ZWQpICovXHJcbiAgcHJpdmF0ZSBjbGVhckNvbHVtblNvcnQoZXZlbnQ6IEV2ZW50LCBhcmdzOiBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MpIHtcclxuICAgIGlmIChhcmdzICYmIGFyZ3MuY29sdW1uICYmIHRoaXMuc2hhcmVkU2VydmljZSkge1xyXG4gICAgICAvLyBnZXQgY3VycmVudCBzb3J0ZWQgY29sdW1ucywgcHJpb3IgdG8gY2FsbGluZyB0aGUgbmV3IGNvbHVtbiBzb3J0XHJcbiAgICAgIGNvbnN0IGFsbFNvcnRlZENvbHM6IENvbHVtblNvcnRbXSA9IHRoaXMuc29ydFNlcnZpY2UuZ2V0Q3VycmVudENvbHVtblNvcnRzKCk7XHJcbiAgICAgIGNvbnN0IHNvcnRlZENvbHNXaXRob3V0Q3VycmVudDogQ29sdW1uU29ydFtdID0gdGhpcy5zb3J0U2VydmljZS5nZXRDdXJyZW50Q29sdW1uU29ydHMoYXJncy5jb2x1bW4uaWQgKyAnJyk7XHJcblxyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShhbGxTb3J0ZWRDb2xzKSAmJiBBcnJheS5pc0FycmF5KHNvcnRlZENvbHNXaXRob3V0Q3VycmVudCkgJiYgYWxsU29ydGVkQ29scy5sZW5ndGggIT09IHNvcnRlZENvbHNXaXRob3V0Q3VycmVudC5sZW5ndGgpIHtcclxuICAgICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5iYWNrZW5kU2VydmljZUFwaSkge1xyXG4gICAgICAgICAgdGhpcy5zb3J0U2VydmljZS5vbkJhY2tlbmRTb3J0Q2hhbmdlZChldmVudCwgeyBtdWx0aUNvbHVtblNvcnQ6IHRydWUsIHNvcnRDb2xzOiBzb3J0ZWRDb2xzV2l0aG91dEN1cnJlbnQsIGdyaWQ6IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkIH0pO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmRhdGFWaWV3KSB7XHJcbiAgICAgICAgICB0aGlzLnNvcnRTZXJ2aWNlLm9uTG9jYWxTb3J0Q2hhbmdlZCh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCwgdGhpcy5zaGFyZWRTZXJ2aWNlLmRhdGFWaWV3LCBzb3J0ZWRDb2xzV2l0aG91dEN1cnJlbnQsIHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyB3aGVuIHVzaW5nIGN1c3RvbURhdGFWaWV3LCB3ZSB3aWxsIHNpbXBseSBzZW5kIGl0IGFzIGEgb25Tb3J0IGV2ZW50IHdpdGggbm90aWZ5XHJcbiAgICAgICAgICBjb25zdCBpc011bHRpU29ydCA9IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMubXVsdGlDb2x1bW5Tb3J0IHx8IGZhbHNlO1xyXG4gICAgICAgICAgY29uc3Qgc29ydE91dHB1dCA9IGlzTXVsdGlTb3J0ID8gc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50IDogc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50WzBdO1xyXG4gICAgICAgICAgYXJncy5ncmlkLm9uU29ydC5ub3RpZnkoc29ydE91dHB1dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB1cGRhdGUgdGhlIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT2JqIHNvcnRDb2x1bW5zIGFycmF5IHdoaWNoIHdpbGwgYXQgdGhlIHNhbWUgYWRkIHRoZSB2aXN1YWwgc29ydCBpY29uKHMpIG9uIHRoZSBVSVxyXG4gICAgICAgIGNvbnN0IHVwZGF0ZWRTb3J0Q29sdW1uczogQ29sdW1uU29ydFtdID0gc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50Lm1hcCgoY29sKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBjb2x1bW5JZDogY29sICYmIGNvbC5zb3J0Q29sICYmIGNvbC5zb3J0Q29sLmlkLFxyXG4gICAgICAgICAgICBzb3J0QXNjOiBjb2wgJiYgY29sLnNvcnRBc2MsXHJcbiAgICAgICAgICAgIHNvcnRDb2w6IGNvbCAmJiBjb2wuc29ydENvbCxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQuc2V0U29ydENvbHVtbnModXBkYXRlZFNvcnRDb2x1bW5zKTsgLy8gYWRkIHNvcnQgaWNvbiBpbiBVSVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiogRXhlY3V0ZSB0aGUgSGVhZGVyIE1lbnUgQ29tbWFuZHMgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBvbkNvbW1hbmQgc3Vic2NyaWJlICovXHJcbiAgcHJpdmF0ZSBleGVjdXRlSGVhZGVyTWVudUludGVybmFsQ29tbWFuZHMoZXZlbnQ6IEV2ZW50LCBhcmdzOiBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MpIHtcclxuICAgIGlmIChhcmdzICYmIGFyZ3MuY29tbWFuZCkge1xyXG4gICAgICBzd2l0Y2ggKGFyZ3MuY29tbWFuZCkge1xyXG4gICAgICAgIGNhc2UgJ2hpZGUnOlxyXG4gICAgICAgICAgdGhpcy5oaWRlQ29sdW1uKGFyZ3MuY29sdW1uKTtcclxuICAgICAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmVuYWJsZUF1dG9TaXplQ29sdW1ucykge1xyXG4gICAgICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZC5hdXRvc2l6ZUNvbHVtbnMoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NsZWFyLWZpbHRlcic6XHJcbiAgICAgICAgICB0aGlzLmNsZWFyQ29sdW1uRmlsdGVyKGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2NsZWFyLXNvcnQnOlxyXG4gICAgICAgICAgdGhpcy5jbGVhckNvbHVtblNvcnQoZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnc29ydC1hc2MnOlxyXG4gICAgICAgIGNhc2UgJ3NvcnQtZGVzYyc6XHJcbiAgICAgICAgICBjb25zdCBpc1NvcnRpbmdBc2MgPSAoYXJncy5jb21tYW5kID09PSAnc29ydC1hc2MnKTtcclxuICAgICAgICAgIHRoaXMuc29ydENvbHVtbihldmVudCwgYXJncywgaXNTb3J0aW5nQXNjKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIFNvcnQgdGhlIGN1cnJlbnQgY29sdW1uICovXHJcbiAgcHJpdmF0ZSBzb3J0Q29sdW1uKGV2ZW50OiBFdmVudCwgYXJnczogTWVudUNvbW1hbmRJdGVtQ2FsbGJhY2tBcmdzLCBpc1NvcnRpbmdBc2MgPSB0cnVlKSB7XHJcbiAgICBpZiAoYXJncyAmJiBhcmdzLmNvbHVtbikge1xyXG4gICAgICAvLyBnZXQgcHJldmlvdXNseSBzb3J0ZWQgY29sdW1uc1xyXG4gICAgICBjb25zdCBzb3J0ZWRDb2xzV2l0aG91dEN1cnJlbnQ6IENvbHVtblNvcnRbXSA9IHRoaXMuc29ydFNlcnZpY2UuZ2V0Q3VycmVudENvbHVtblNvcnRzKGFyZ3MuY29sdW1uLmlkICsgJycpO1xyXG5cclxuICAgICAgbGV0IGVtaXR0ZXJUeXBlOiBFbWl0dGVyVHlwZTtcclxuXHJcbiAgICAgIC8vIGFkZCB0byB0aGUgY29sdW1uIGFycmF5LCB0aGUgY29sdW1uIHNvcnRlZCBieSB0aGUgaGVhZGVyIG1lbnVcclxuICAgICAgc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50LnB1c2goeyBzb3J0Q29sOiBhcmdzLmNvbHVtbiwgc29ydEFzYzogaXNTb3J0aW5nQXNjIH0pO1xyXG4gICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmJhY2tlbmRTZXJ2aWNlQXBpKSB7XHJcbiAgICAgICAgdGhpcy5zb3J0U2VydmljZS5vbkJhY2tlbmRTb3J0Q2hhbmdlZChldmVudCwgeyBtdWx0aUNvbHVtblNvcnQ6IHRydWUsIHNvcnRDb2xzOiBzb3J0ZWRDb2xzV2l0aG91dEN1cnJlbnQsIGdyaWQ6IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkIH0pO1xyXG4gICAgICAgIGVtaXR0ZXJUeXBlID0gRW1pdHRlclR5cGUucmVtb3RlO1xyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5kYXRhVmlldykge1xyXG4gICAgICAgIHRoaXMuc29ydFNlcnZpY2Uub25Mb2NhbFNvcnRDaGFuZ2VkKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLCB0aGlzLnNoYXJlZFNlcnZpY2UuZGF0YVZpZXcsIHNvcnRlZENvbHNXaXRob3V0Q3VycmVudCk7XHJcbiAgICAgICAgZW1pdHRlclR5cGUgPSBFbWl0dGVyVHlwZS5sb2NhbDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyB3aGVuIHVzaW5nIGN1c3RvbURhdGFWaWV3LCB3ZSB3aWxsIHNpbXBseSBzZW5kIGl0IGFzIGEgb25Tb3J0IGV2ZW50IHdpdGggbm90aWZ5XHJcbiAgICAgICAgY29uc3QgaXNNdWx0aVNvcnQgPSB0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5tdWx0aUNvbHVtblNvcnQgfHwgZmFsc2U7XHJcbiAgICAgICAgY29uc3Qgc29ydE91dHB1dCA9IGlzTXVsdGlTb3J0ID8gc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50IDogc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50WzBdO1xyXG4gICAgICAgIGFyZ3MuZ3JpZC5vblNvcnQubm90aWZ5KHNvcnRPdXRwdXQpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyB1cGRhdGUgdGhlIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT2JqIHNvcnRDb2x1bW5zIGFycmF5IHdoaWNoIHdpbGwgYXQgdGhlIHNhbWUgYWRkIHRoZSB2aXN1YWwgc29ydCBpY29uKHMpIG9uIHRoZSBVSVxyXG4gICAgICBjb25zdCBuZXdTb3J0Q29sdW1uczogQ29sdW1uU29ydFtdID0gc29ydGVkQ29sc1dpdGhvdXRDdXJyZW50Lm1hcCgoY29sKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGNvbHVtbklkOiBjb2wgJiYgY29sLnNvcnRDb2wgJiYgY29sLnNvcnRDb2wuaWQsXHJcbiAgICAgICAgICBzb3J0QXNjOiBjb2wgJiYgY29sLnNvcnRBc2MsXHJcbiAgICAgICAgICBzb3J0Q29sOiBjb2wgJiYgY29sLnNvcnRDb2wsXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBhZGQgc29ydCBpY29uIGluIFVJXHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLnNldFNvcnRDb2x1bW5zKG5ld1NvcnRDb2x1bW5zKTtcclxuXHJcbiAgICAgIC8vIGlmIHdlIGhhdmUgYW4gZW1pdHRlciB0eXBlIHNldCwgd2Ugd2lsbCBlbWl0IGEgc29ydCBjaGFuZ2VkXHJcbiAgICAgIC8vIGZvciB0aGUgR3JpZCBTdGF0ZSBTZXJ2aWNlIHRvIHNlZSB0aGUgY2hhbmdlLlxyXG4gICAgICAvLyBXZSBhbHNvIG5lZWQgdG8gcGFzcyBjdXJyZW50IHNvcnRlcnMgY2hhbmdlZCB0byB0aGUgZW1pdFNvcnRDaGFuZ2VkIG1ldGhvZFxyXG4gICAgICBpZiAoZW1pdHRlclR5cGUpIHtcclxuICAgICAgICBjb25zdCBjdXJyZW50TG9jYWxTb3J0ZXJzOiBDdXJyZW50U29ydGVyW10gPSBbXTtcclxuICAgICAgICBuZXdTb3J0Q29sdW1ucy5mb3JFYWNoKChzb3J0Q29sKSA9PiB7XHJcbiAgICAgICAgICBjdXJyZW50TG9jYWxTb3J0ZXJzLnB1c2goe1xyXG4gICAgICAgICAgICBjb2x1bW5JZDogc29ydENvbC5jb2x1bW5JZCArICcnLFxyXG4gICAgICAgICAgICBkaXJlY3Rpb246IHNvcnRDb2wuc29ydEFzYyA/ICdBU0MnIDogJ0RFU0MnXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNvcnRTZXJ2aWNlLmVtaXRTb3J0Q2hhbmdlZChlbWl0dGVyVHlwZSwgY3VycmVudExvY2FsU29ydGVycyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19