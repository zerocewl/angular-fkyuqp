import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { DelimiterType, ExtensionName, FileType, } from '../models/index';
import { ExtensionUtility } from './extensionUtility';
import { SharedService } from '../services/shared.service';
import { ExportService } from '../services/export.service';
import { ExcelExportService } from '../services/excelExport.service';
import { exportWithFormatterWhenDefined } from '../services/export-utilities';
var ContextMenuExtension = /** @class */ (function () {
    function ContextMenuExtension(excelExportService, exportService, extensionUtility, sharedService, translate) {
        this.excelExportService = excelExportService;
        this.exportService = exportService;
        this.extensionUtility = extensionUtility;
        this.sharedService = sharedService;
        this.translate = translate;
        this._eventHandler = new Slick.EventHandler();
    }
    Object.defineProperty(ContextMenuExtension.prototype, "eventHandler", {
        get: function () {
            return this._eventHandler;
        },
        enumerable: true,
        configurable: true
    });
    ContextMenuExtension.prototype.dispose = function () {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu && this.sharedService.gridOptions.contextMenu.commandItems) {
            this.sharedService.gridOptions.contextMenu = this._userOriginalContextMenu;
        }
    };
    /** Get the instance of the SlickGrid addon (control or plugin). */
    ContextMenuExtension.prototype.getAddonInstance = function () {
        return this._addon;
    };
    /**
     * Create the Action Cell Menu and expose all the available hooks that user can subscribe (onCommand, onBeforeMenuShow, ...)
     * @param grid
     * @param dataView
     * @param columnDefinitions
     */
    ContextMenuExtension.prototype.register = function () {
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.enableTranslate && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            var contextMenu_1 = this.sharedService.gridOptions.contextMenu;
            // keep original user context menu, useful when switching locale to translate
            this._userOriginalContextMenu = tslib_1.__assign({}, contextMenu_1);
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.contextMenu);
            this.sharedService.gridOptions.contextMenu = tslib_1.__assign({}, contextMenu_1);
            // sort all menu items by their position order when defined
            contextMenu_1.commandItems = this.addMenuCustomCommands([]);
            this.extensionUtility.sortItems(contextMenu_1.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(contextMenu_1.optionItems || [], 'positionOrder');
            this._addon = new Slick.Plugins.ContextMenu(contextMenu_1);
            this.sharedService.grid.registerPlugin(this._addon);
            // translate the item keys when necessary
            if (this.sharedService.gridOptions.enableTranslate) {
                this.translateContextMenu();
            }
            // hook all events
            if (this.sharedService.grid && contextMenu_1) {
                if (contextMenu_1.onExtensionRegistered) {
                    contextMenu_1.onExtensionRegistered(this._addon);
                }
                if (contextMenu_1 && typeof contextMenu_1.onCommand === 'function') {
                    this._eventHandler.subscribe(this._addon.onCommand, function (event, args) {
                        contextMenu_1.onCommand(event, args);
                    });
                }
                if (contextMenu_1 && typeof contextMenu_1.onOptionSelected === 'function') {
                    this._eventHandler.subscribe(this._addon.onOptionSelected, function (event, args) {
                        contextMenu_1.onOptionSelected(event, args);
                    });
                }
                if (contextMenu_1 && typeof contextMenu_1.onBeforeMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuShow, function (event, args) {
                        contextMenu_1.onBeforeMenuShow(event, args);
                    });
                }
                if (contextMenu_1 && typeof contextMenu_1.onBeforeMenuClose === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuClose, function (event, args) {
                        contextMenu_1.onBeforeMenuClose(event, args);
                    });
                }
                if (contextMenu_1 && typeof contextMenu_1.onAfterMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onAfterMenuShow, function (event, args) {
                        contextMenu_1.onAfterMenuShow(event, args);
                    });
                }
            }
            return this._addon;
        }
        return null;
    };
    /** Translate the Cell Menu titles, we need to loop through all column definition to re-translate them */
    ContextMenuExtension.prototype.translateContextMenu = function () {
        if (this.sharedService && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            var contextMenu = this.sharedService.gridOptions.contextMenu;
            var menuOptions = {};
            if (contextMenu.commandTitleKey) {
                contextMenu.commandTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.commandTitleKey) || contextMenu.commandTitle;
                menuOptions.commandTitle = contextMenu.commandTitle;
            }
            if (contextMenu.optionTitleKey) {
                contextMenu.optionTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.optionTitleKey) || contextMenu.optionTitle;
                menuOptions.optionTitle = contextMenu.optionTitle;
            }
            var originalCommandItems = this._userOriginalContextMenu && Array.isArray(this._userOriginalContextMenu.commandItems) ? this._userOriginalContextMenu.commandItems : [];
            contextMenu.commandItems = tslib_1.__spread(originalCommandItems, this.addMenuCustomCommands(originalCommandItems));
            menuOptions.commandItems = contextMenu.commandItems; // copy it also to the menuOptions else they won't be translated when locale changes
            // translate all command/options and resort them afterward
            this.extensionUtility.translateItems(contextMenu.commandItems || [], 'titleKey', 'title');
            this.extensionUtility.translateItems(contextMenu.optionItems || [], 'titleKey', 'title');
            this.extensionUtility.sortItems(contextMenu.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(contextMenu.optionItems || [], 'positionOrder');
            // update the title options so that it has latest translated values
            if (this._addon && this._addon.setOptions) {
                this._addon.setOptions(menuOptions);
            }
        }
    };
    // --
    // private functions
    // ------------------
    /** Create Context Menu with Custom Commands (copy cell value, export) */
    ContextMenuExtension.prototype.addMenuCustomCommands = function (originalCustomItems) {
        var _this = this;
        var menuCustomItems = [];
        var gridOptions = this.sharedService && this.sharedService.gridOptions || {};
        var contextMenu = gridOptions && gridOptions.contextMenu;
        var dataView = this.sharedService && this.sharedService.dataView;
        // show context menu: Copy (cell value)
        if (contextMenu && !contextMenu.hideCopyCellValueCommand) {
            var commandName_1 = 'copy';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_1; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconCopyCellValueCommand || 'fa fa-clone',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('COPY', 'TEXT_COPY'),
                    disabled: false,
                    command: commandName_1,
                    positionOrder: 50,
                    action: function (e, args) {
                        _this.copyToClipboard(args);
                    },
                    itemUsabilityOverride: function (args) {
                        // make sure there's an item to copy before enabling this command
                        var columnDef = args && args.column;
                        var dataContext = args && args.dataContext;
                        if (columnDef && dataContext.hasOwnProperty(columnDef.field)) {
                            return dataContext[columnDef.field] !== '' && dataContext[columnDef.field] !== null && dataContext[columnDef.field] !== undefined;
                        }
                        return false;
                    }
                });
            }
        }
        // show context menu: Export to file
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportCsvCommand) {
            var commandName_2 = 'export-csv';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_2; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportCsvCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPORT_TO_CSV', 'TEXT_EXPORT_TO_CSV'),
                    disabled: false,
                    command: commandName_2,
                    positionOrder: 51,
                    action: function () { return _this.exportService.exportToFile({
                        delimiter: DelimiterType.comma,
                        filename: 'export',
                        format: FileType.csv,
                        useUtf8WithBom: true,
                    }); },
                });
            }
        }
        // show context menu: Export to Excel
        if (gridOptions && gridOptions.enableExcelExport && contextMenu && !contextMenu.hideExportExcelCommand) {
            var commandName_3 = 'export-excel';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_3; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportExcelCommand || 'fa fa-file-excel-o text-success',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPORT_TO_EXCEL', 'TEXT_EXPORT_TO_EXCEL'),
                    disabled: false,
                    command: commandName_3,
                    positionOrder: 52,
                    action: function () { return _this.excelExportService.exportToExcel({
                        filename: 'export',
                        format: FileType.xlsx,
                    }); },
                });
            }
        }
        // show context menu: export to text file as tab delimited
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportTextDelimitedCommand) {
            var commandName_4 = 'export-text-delimited';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_4; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportTextDelimitedCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPORT_TO_TAB_DELIMITED', 'TEXT_EXPORT_TO_TAB_DELIMITED'),
                    disabled: false,
                    command: commandName_4,
                    positionOrder: 53,
                    action: function () { return _this.exportService.exportToFile({
                        delimiter: DelimiterType.tab,
                        filename: 'export',
                        format: FileType.txt,
                        useUtf8WithBom: true,
                    }); },
                });
            }
        }
        // -- Grouping Commands
        if (gridOptions && (gridOptions.enableGrouping || gridOptions.enableDraggableGrouping)) {
            // add a divider (separator) between the top sort commands and the other clear commands
            menuCustomItems.push({ divider: true, command: '', positionOrder: 54 });
            // show context menu: Clear Grouping
            if (gridOptions && contextMenu && !contextMenu.hideClearAllGrouping) {
                var commandName_5 = 'clear-grouping';
                if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_5; })) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconClearGroupingCommand || 'fa fa-times',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist('CLEAR_ALL_GROUPING', 'TEXT_CLEAR_ALL_GROUPING'),
                        disabled: false,
                        command: commandName_5,
                        positionOrder: 55,
                        action: function () { return dataView.setGrouping([]); },
                        itemUsabilityOverride: function () {
                            // only enable the command when there's an actually grouping in play
                            var groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Collapse all Groups
            if (gridOptions && contextMenu && !contextMenu.hideCollapseAllGroups) {
                var commandName_6 = 'collapse-all-groups';
                if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_6; })) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconCollapseAllGroupsCommand || 'fa fa-compress',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist('COLLAPSE_ALL_GROUPS', 'TEXT_COLLAPSE_ALL_GROUPS'),
                        disabled: false,
                        command: commandName_6,
                        positionOrder: 56,
                        action: function () { return dataView.collapseAllGroups(); },
                        itemUsabilityOverride: function () {
                            // only enable the command when there's an actually grouping in play
                            var groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Expand all Groups
            if (gridOptions && contextMenu && !contextMenu.hideExpandAllGroups) {
                var commandName_7 = 'expand-all-groups';
                if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_7; })) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconExpandAllGroupsCommand || 'fa fa-expand',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist('EXPAND_ALL_GROUPS', 'TEXT_EXPAND_ALL_GROUPS'),
                        disabled: false,
                        command: commandName_7,
                        positionOrder: 57,
                        action: function () { return dataView.expandAllGroups(); },
                        itemUsabilityOverride: function () {
                            // only enable the command when there's an actually grouping in play
                            var groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
        }
        return menuCustomItems;
    };
    /**
     * First get the value, if "exportWithFormatter" is set then we'll use the formatter output
     * Then we create the DOM trick to copy a text value by creating a fake <div> that is not shown to the user
     * and from there we can call the execCommand 'copy' command and expect the value to be in clipboard
     * @param args
     */
    ContextMenuExtension.prototype.copyToClipboard = function (args) {
        try {
            if (args && args.grid && args.command) {
                // get the value, if "exportWithFormatter" is set then we'll use the formatter output
                var gridOptions = this.sharedService && this.sharedService.gridOptions || {};
                var cell = args && args.cell || 0;
                var row = args && args.row || 0;
                var column = args && args.column;
                var dataContext = args && args.dataContext;
                var grid = this.sharedService && this.sharedService.grid;
                var exportOptions = gridOptions && (gridOptions.excelExportOptions || gridOptions.exportOptions);
                var textToCopy = exportWithFormatterWhenDefined(row, cell, dataContext, column, grid, exportOptions);
                // create fake <div> to copy into clipboard & delete it from the DOM once we're done
                var range = document.createRange();
                var tmpElem = $('<div>').css({ position: 'absolute', left: '-1000px', top: '-1000px' }).text(textToCopy);
                $('body').append(tmpElem);
                range.selectNodeContents(tmpElem.get(0));
                var selection = window.getSelection();
                if (selection && selection.addRange && selection.removeAllRanges) {
                    selection.removeAllRanges();
                    selection.addRange(range);
                    var success = document.execCommand('copy', false, textToCopy);
                    if (success) {
                        tmpElem.remove();
                    }
                }
            }
        }
        catch (e) { }
    };
    ContextMenuExtension = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(4, Optional()),
        tslib_1.__metadata("design:paramtypes", [ExcelExportService,
            ExportService,
            ExtensionUtility,
            SharedService,
            TranslateService])
    ], ContextMenuExtension);
    return ContextMenuExtension;
}());
export { ContextMenuExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dE1lbnVFeHRlbnNpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2V4dGVuc2lvbnMvY29udGV4dE1lbnVFeHRlbnNpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sRUFHTCxhQUFhLEVBRWIsYUFBYSxFQUNiLFFBQVEsR0FNVCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDckUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFNOUU7SUFLRSw4QkFDVSxrQkFBc0MsRUFDdEMsYUFBNEIsRUFDNUIsZ0JBQWtDLEVBQ2xDLGFBQTRCLEVBQ2hCLFNBQTJCO1FBSnZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUNoQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUUvQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2hELENBQUM7SUFFRCxzQkFBSSw4Q0FBWTthQUFoQjtZQUNFLE9BQU8sSUFBSSxDQUFDLGFBQWEs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QUFFLEdBQUc7SUFDakIsQ0FBQztJQTlWVSxvQkFBb0I7UUFEaEMsVUFBVSxFQUFFO1FBV1IsbUJBQUEsUUFBUSxFQUFFLENBQUE7aURBSmlCLGtCQUFrQjtZQUN2QixhQUFhO1lBQ1YsZ0JBQWdCO1lBQ25CLGFBQWE7WUFDTCxnQkFBZ0I7T0FWdEMsb0JBQW9CLENBK1ZoQztJQUFELDJCQUFDO0NBQUEsQUEvVkQsSUErVkM7U0EvVlksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xyXG5cclxuaW1wb3J0IHtcclxuICBDb2x1bW4sXHJcbiAgQ29udGV4dE1lbnUsXHJcbiAgRGVsaW1pdGVyVHlwZSxcclxuICBFeHRlbnNpb24sXHJcbiAgRXh0ZW5zaW9uTmFtZSxcclxuICBGaWxlVHlwZSxcclxuICBNZW51Q2FsbGJhY2tBcmdzLFxyXG4gIE1lbnVDb21tYW5kSXRlbSxcclxuICBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MsXHJcbiAgTWVudU9wdGlvbkl0ZW1DYWxsYmFja0FyZ3MsXHJcbiAgU2xpY2tFdmVudEhhbmRsZXIsXHJcbn0gZnJvbSAnLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgRXh0ZW5zaW9uVXRpbGl0eSB9IGZyb20gJy4vZXh0ZW5zaW9uVXRpbGl0eSc7XHJcbmltcG9ydCB7IFNoYXJlZFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zaGFyZWQuc2VydmljZSc7XHJcbmltcG9ydCB7IEV4cG9ydFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9leHBvcnQuc2VydmljZSc7XHJcbmltcG9ydCB7IEV4Y2VsRXhwb3J0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2V4Y2VsRXhwb3J0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBleHBvcnRXaXRoRm9ybWF0dGVyV2hlbkRlZmluZWQgfSBmcm9tICcuLi9zZXJ2aWNlcy9leHBvcnQtdXRpbGl0aWVzJztcclxuXHJcbi8vIHVzaW5nIGV4dGVybmFsIG5vbi10eXBlZCBqcyBsaWJyYXJpZXNcclxuZGVjbGFyZSB2YXIgU2xpY2s6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENvbnRleHRNZW51RXh0ZW5zaW9uIGltcGxlbWVudHMgRXh0ZW5zaW9uIHtcclxuICBwcml2YXRlIF9hZGRvbjogYW55O1xyXG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlcjogU2xpY2tFdmVudEhhbmRsZXI7XHJcbiAgcHJpdmF0ZSBfdXNlck9yaWdpbmFsQ29udGV4dE1lbnU6IENvbnRleHRNZW51O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZXhjZWxFeHBvcnRTZXJ2aWNlOiBFeGNlbEV4cG9ydFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGV4cG9ydFNlcnZpY2U6IEV4cG9ydFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGV4dGVuc2lvblV0aWxpdHk6IEV4dGVuc2lvblV0aWxpdHksXHJcbiAgICBwcml2YXRlIHNoYXJlZFNlcnZpY2U6IFNoYXJlZFNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcclxuICApIHtcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlciA9IG5ldyBTbGljay5FdmVudEhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIGdldCBldmVudEhhbmRsZXIoKTogU2xpY2tFdmVudEhhbmRsZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX2V2ZW50SGFuZGxlcjtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICAvLyB1bnN1YnNjcmliZSBhbGwgU2xpY2tHcmlkIGV2ZW50c1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyLnVuc3Vic2NyaWJlQWxsKCk7XHJcblxyXG4gICAgaWYgKHRoaXMuX2FkZG9uICYmIHRoaXMuX2FkZG9uLmRlc3Ryb3kpIHtcclxuICAgICAgdGhpcy5fYWRkb24uZGVzdHJveSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51LmNvbW1hbmRJdGVtcykge1xyXG4gICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUgPSB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKiBHZXQgdGhlIGluc3RhbmNlIG9mIHRoZSBTbGlja0dyaWQgYWRkb24gKGNvbnRyb2wgb3IgcGx1Z2luKS4gKi9cclxuICBnZXRBZGRvbkluc3RhbmNlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2FkZG9uO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIHRoZSBBY3Rpb24gQ2VsbCBNZW51IGFuZCBleHBvc2UgYWxsIHRoZSBhdmFpbGFibGUgaG9va3MgdGhhdCB1c2VyIGNhbiBzdWJzY3JpYmUgKG9uQ29tbWFuZCwgb25CZWZvcmVNZW51U2hvdywgLi4uKVxyXG4gICAqIEBwYXJhbSBncmlkXHJcbiAgICogQHBhcmFtIGRhdGFWaWV3XHJcbiAgICogQHBhcmFtIGNvbHVtbkRlZmluaXRpb25zXHJcbiAgICovXHJcbiAgcmVnaXN0ZXIoKTogYW55IHtcclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmVuYWJsZVRyYW5zbGF0ZSAmJiAoIXRoaXMudHJhbnNsYXRlIHx8ICF0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tBbmd1bGFyLVNsaWNrZ3JpZF0gcmVxdWlyZXMgXCJuZ3gtdHJhbnNsYXRlXCIgdG8gYmUgaW5zdGFsbGVkIGFuZCBjb25maWd1cmVkIHdoZW4gdGhlIGdyaWQgb3B0aW9uIFwiZW5hYmxlVHJhbnNsYXRlXCIgaXMgZW5hYmxlZC4nKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUpIHtcclxuICAgICAgY29uc3QgY29udGV4dE1lbnUgPSB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnU7XHJcblxyXG4gICAgICAvLyBrZWVwIG9yaWdpbmFsIHVzZXIgY29udGV4dCBtZW51LCB1c2VmdWwgd2hlbiBzd2l0Y2hpbmcgbG9jYWxlIHRvIHRyYW5zbGF0ZVxyXG4gICAgICB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudSA9IHsgLi4uY29udGV4dE1lbnUgfTtcclxuXHJcbiAgICAgIC8vIGR5bmFtaWNhbGx5IGltcG9ydCB0aGUgU2xpY2tHcmlkIHBsdWdpbiAoYWRkb24pIHdpdGggUmVxdWlyZUpTXHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5sb2FkRXh0ZW5zaW9uRHluYW1pY2FsbHkoRXh0ZW5zaW9uTmFtZS5jb250ZXh0TWVudSk7XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSA9IHsgLi4uY29udGV4dE1lbnUgfTtcclxuXHJcbiAgICAgIC8vIHNvcnQgYWxsIG1lbnUgaXRlbXMgYnkgdGhlaXIgcG9zaXRpb24gb3JkZXIgd2hlbiBkZWZpbmVkXHJcbiAgICAgIGNvbnRleHRNZW51LmNvbW1hbmRJdGVtcyA9IHRoaXMuYWRkTWVudUN1c3RvbUNvbW1hbmRzKFtdKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyhjb250ZXh0TWVudS5jb21tYW5kSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5zb3J0SXRlbXMoY29udGV4dE1lbnUub3B0aW9uSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcblxyXG4gICAgICB0aGlzLl9hZGRvbiA9IG5ldyBTbGljay5QbHVnaW5zLkNvbnRleHRNZW51KGNvbnRleHRNZW51KTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQucmVnaXN0ZXJQbHVnaW4odGhpcy5fYWRkb24pO1xyXG5cclxuICAgICAgLy8gdHJhbnNsYXRlIHRoZSBpdGVtIGtleXMgd2hlbiBuZWNlc3NhcnlcclxuICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5lbmFibGVUcmFuc2xhdGUpIHtcclxuICAgICAgICB0aGlzLnRyYW5zbGF0ZUNvbnRleHRNZW51KCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGhvb2sgYWxsIGV2ZW50c1xyXG4gICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQgJiYgY29udGV4dE1lbnUpIHtcclxuICAgICAgICBpZiAoY29udGV4dE1lbnUub25FeHRlbnNpb25SZWdpc3RlcmVkKSB7XHJcbiAgICAgICAgICBjb250ZXh0TWVudS5vbkV4dGVuc2lvblJlZ2lzdGVyZWQodGhpcy5fYWRkb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29udGV4dE1lbnUgJiYgdHlwZW9mIGNvbnRleHRNZW51Lm9uQ29tbWFuZCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkNvbW1hbmQsIChldmVudDogRXZlbnQsIGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0TWVudS5vbkNvbW1hbmQoZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb250ZXh0TWVudSAmJiB0eXBlb2YgY29udGV4dE1lbnUub25PcHRpb25TZWxlY3RlZCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbk9wdGlvblNlbGVjdGVkLCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiBNZW51T3B0aW9uSXRlbUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0TWVudS5vbk9wdGlvblNlbGVjdGVkKGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29udGV4dE1lbnUgJiYgdHlwZW9mIGNvbnRleHRNZW51Lm9uQmVmb3JlTWVudVNob3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25CZWZvcmVNZW51U2hvdywgKGV2ZW50OiBFdmVudCwgYXJnczogeyBjZWxsOiBudW1iZXI7IHJvdzogbnVtYmVyOyBncmlkOiBhbnk7IH0pID0+IHtcclxuICAgICAgICAgICAgY29udGV4dE1lbnUub25CZWZvcmVNZW51U2hvdyhldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvbnRleHRNZW51ICYmIHR5cGVvZiBjb250ZXh0TWVudS5vbkJlZm9yZU1lbnVDbG9zZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkJlZm9yZU1lbnVDbG9zZSwgKGV2ZW50OiBFdmVudCwgYXJnczogeyBjZWxsOiBudW1iZXI7IHJvdzogbnVtYmVyOyBncmlkOiBhbnk7IG1lbnU6IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0TWVudS5vbkJlZm9yZU1lbnVDbG9zZShldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvbnRleHRNZW51ICYmIHR5cGVvZiBjb250ZXh0TWVudS5vbkFmdGVyTWVudVNob3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25BZnRlck1lbnVTaG93LCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiB7IGNlbGw6IG51bWJlcjsgcm93OiBudW1iZXI7IGdyaWQ6IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0TWVudS5vbkFmdGVyTWVudVNob3coZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLl9hZGRvbjtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqIFRyYW5zbGF0ZSB0aGUgQ2VsbCBNZW51IHRpdGxlcywgd2UgbmVlZCB0byBsb29wIHRocm91Z2ggYWxsIGNvbHVtbiBkZWZpbml0aW9uIHRvIHJlLXRyYW5zbGF0ZSB0aGVtICovXHJcbiAgdHJhbnNsYXRlQ29udGV4dE1lbnUoKSB7XHJcbiAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUpIHtcclxuICAgICAgY29uc3QgY29udGV4dE1lbnUgPSB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnU7XHJcbiAgICAgIGNvbnN0IG1lbnVPcHRpb25zOiBQYXJ0aWFsPENvbnRleHRNZW51PiA9IHt9O1xyXG5cclxuICAgICAgaWYgKGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZUtleSkge1xyXG4gICAgICAgIGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZSA9IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChjb250ZXh0TWVudS5jb21tYW5kVGl0bGVLZXkpIHx8IGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZTtcclxuICAgICAgICBtZW51T3B0aW9ucy5jb21tYW5kVGl0bGUgPSBjb250ZXh0TWVudS5jb21tYW5kVGl0bGU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGNvbnRleHRNZW51Lm9wdGlvblRpdGxlS2V5KSB7XHJcbiAgICAgICAgY29udGV4dE1lbnUub3B0aW9uVGl0bGUgPSB0aGlzLnRyYW5zbGF0ZSAmJiB0aGlzLnRyYW5zbGF0ZS5jdXJyZW50TGFuZyAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50ICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoY29udGV4dE1lbnUub3B0aW9uVGl0bGVLZXkpIHx8IGNvbnRleHRNZW51Lm9wdGlvblRpdGxlO1xyXG4gICAgICAgIG1lbnVPcHRpb25zLm9wdGlvblRpdGxlID0gY29udGV4dE1lbnUub3B0aW9uVGl0bGU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3Qgb3JpZ2luYWxDb21tYW5kSXRlbXMgPSB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudSAmJiBBcnJheS5pc0FycmF5KHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51LmNvbW1hbmRJdGVtcykgPyB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudS5jb21tYW5kSXRlbXMgOiBbXTtcclxuICAgICAgY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zID0gWy4uLm9yaWdpbmFsQ29tbWFuZEl0ZW1zLCAuLi50aGlzLmFkZE1lbnVDdXN0b21Db21tYW5kcyhvcmlnaW5hbENvbW1hbmRJdGVtcyldO1xyXG4gICAgICBtZW51T3B0aW9ucy5jb21tYW5kSXRlbXMgPSBjb250ZXh0TWVudS5jb21tYW5kSXRlbXM7IC8vIGNvcHkgaXQgYWxzbyB0byB0aGUgbWVudU9wdGlvbnMgZWxzZSB0aGV5IHdvbid0IGJlIHRyYW5zbGF0ZWQgd2hlbiBsb2NhbGUgY2hhbmdlc1xyXG5cclxuICAgICAgLy8gdHJhbnNsYXRlIGFsbCBjb21tYW5kL29wdGlvbnMgYW5kIHJlc29ydCB0aGVtIGFmdGVyd2FyZFxyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlSXRlbXMoY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zIHx8IFtdLCAndGl0bGVLZXknLCAndGl0bGUnKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZUl0ZW1zKGNvbnRleHRNZW51Lm9wdGlvbkl0ZW1zIHx8IFtdLCAndGl0bGVLZXknLCAndGl0bGUnKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyhjb250ZXh0TWVudS5jb21tYW5kSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5zb3J0SXRlbXMoY29udGV4dE1lbnUub3B0aW9uSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcblxyXG4gICAgICAvLyB1cGRhdGUgdGhlIHRpdGxlIG9wdGlvbnMgc28gdGhhdCBpdCBoYXMgbGF0ZXN0IHRyYW5zbGF0ZWQgdmFsdWVzXHJcbiAgICAgIGlmICh0aGlzLl9hZGRvbiAmJiB0aGlzLl9hZGRvbi5zZXRPcHRpb25zKSB7XHJcbiAgICAgICAgdGhpcy5fYWRkb24uc2V0T3B0aW9ucyhtZW51T3B0aW9ucyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIC0tXHJcbiAgLy8gcHJpdmF0ZSBmdW5jdGlvbnNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgLyoqIENyZWF0ZSBDb250ZXh0IE1lbnUgd2l0aCBDdXN0b20gQ29tbWFuZHMgKGNvcHkgY2VsbCB2YWx1ZSwgZXhwb3J0KSAqL1xyXG4gIHByaXZhdGUgYWRkTWVudUN1c3RvbUNvbW1hbmRzKG9yaWdpbmFsQ3VzdG9tSXRlbXM6IEFycmF5PE1lbnVDb21tYW5kSXRlbSB8ICdkaXZpZGVyJz4pIHtcclxuICAgIGNvbnN0IG1lbnVDdXN0b21JdGVtczogQXJyYXk8TWVudUNvbW1hbmRJdGVtIHwgJ2RpdmlkZXInPiA9IFtdO1xyXG4gICAgY29uc3QgZ3JpZE9wdGlvbnMgPSB0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zIHx8IHt9O1xyXG4gICAgY29uc3QgY29udGV4dE1lbnUgPSBncmlkT3B0aW9ucyAmJiBncmlkT3B0aW9ucy5jb250ZXh0TWVudTtcclxuICAgIGNvbnN0IGRhdGFWaWV3ID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5kYXRhVmlldztcclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogQ29weSAoY2VsbCB2YWx1ZSlcclxuICAgIGlmIChjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUNvcHlDZWxsVmFsdWVDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2NvcHknO1xyXG4gICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uQ29weUNlbGxWYWx1ZUNvbW1hbmQgfHwgJ2ZhIGZhLWNsb25lJyxcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVXaGVuRW5hYmxlZEFuZFNlcnZpY2VFeGlzdCgnQ09QWScsICdURVhUX0NPUFknKSxcclxuICAgICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTAsXHJcbiAgICAgICAgICAgIGFjdGlvbjogKGU6IEV2ZW50LCBhcmdzOiBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmNvcHlUb0NsaXBib2FyZChhcmdzKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgaXRlbVVzYWJpbGl0eU92ZXJyaWRlOiAoYXJnczogTWVudUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0aGVyZSdzIGFuIGl0ZW0gdG8gY29weSBiZWZvcmUgZW5hYmxpbmcgdGhpcyBjb21tYW5kXHJcbiAgICAgICAgICAgICAgY29uc3QgY29sdW1uRGVmID0gYXJncyAmJiBhcmdzLmNvbHVtbiBhcyBDb2x1bW47XHJcbiAgICAgICAgICAgICAgY29uc3QgZGF0YUNvbnRleHQgPSBhcmdzICYmIGFyZ3MuZGF0YUNvbnRleHQ7XHJcbiAgICAgICAgICAgICAgaWYgKGNvbHVtbkRlZiAmJiBkYXRhQ29udGV4dC5oYXNPd25Qcm9wZXJ0eShjb2x1bW5EZWYuZmllbGQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YUNvbnRleHRbY29sdW1uRGVmLmZpZWxkXSAhPT0gJycgJiYgZGF0YUNvbnRleHRbY29sdW1uRGVmLmZpZWxkXSAhPT0gbnVsbCAmJiBkYXRhQ29udGV4dFtjb2x1bW5EZWYuZmllbGRdICE9PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogRXhwb3J0IHRvIGZpbGVcclxuICAgIGlmIChncmlkT3B0aW9ucyAmJiBncmlkT3B0aW9ucy5lbmFibGVFeHBvcnQgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVFeHBvcnRDc3ZDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cG9ydC1jc3YnO1xyXG4gICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uRXhwb3J0Q3N2Q29tbWFuZCB8fCAnZmEgZmEtZG93bmxvYWQnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdFWFBPUlRfVE9fQ1NWJywgJ1RFWFRfRVhQT1JUX1RPX0NTVicpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MSxcclxuICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmV4cG9ydFNlcnZpY2UuZXhwb3J0VG9GaWxlKHtcclxuICAgICAgICAgICAgICBkZWxpbWl0ZXI6IERlbGltaXRlclR5cGUuY29tbWEsXHJcbiAgICAgICAgICAgICAgZmlsZW5hbWU6ICdleHBvcnQnLFxyXG4gICAgICAgICAgICAgIGZvcm1hdDogRmlsZVR5cGUuY3N2LFxyXG4gICAgICAgICAgICAgIHVzZVV0ZjhXaXRoQm9tOiB0cnVlLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IEV4cG9ydCB0byBFeGNlbFxyXG4gICAgaWYgKGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmVuYWJsZUV4Y2VsRXhwb3J0ICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlRXhwb3J0RXhjZWxDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cG9ydC1leGNlbCc7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25FeHBvcnRFeGNlbENvbW1hbmQgfHwgJ2ZhIGZhLWZpbGUtZXhjZWwtbyB0ZXh0LXN1Y2Nlc3MnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdFWFBPUlRfVE9fRVhDRUwnLCAnVEVYVF9FWFBPUlRfVE9fRVhDRUwnKSxcclxuICAgICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTIsXHJcbiAgICAgICAgICAgIGFjdGlvbjogKCkgPT4gdGhpcy5leGNlbEV4cG9ydFNlcnZpY2UuZXhwb3J0VG9FeGNlbCh7XHJcbiAgICAgICAgICAgICAgZmlsZW5hbWU6ICdleHBvcnQnLFxyXG4gICAgICAgICAgICAgIGZvcm1hdDogRmlsZVR5cGUueGxzeCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBleHBvcnQgdG8gdGV4dCBmaWxlIGFzIHRhYiBkZWxpbWl0ZWRcclxuICAgIGlmIChncmlkT3B0aW9ucyAmJiBncmlkT3B0aW9ucy5lbmFibGVFeHBvcnQgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVFeHBvcnRUZXh0RGVsaW1pdGVkQ29tbWFuZCkge1xyXG4gICAgICBjb25zdCBjb21tYW5kTmFtZSA9ICdleHBvcnQtdGV4dC1kZWxpbWl0ZWQnO1xyXG4gICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uRXhwb3J0VGV4dERlbGltaXRlZENvbW1hbmQgfHwgJ2ZhIGZhLWRvd25sb2FkJyxcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVXaGVuRW5hYmxlZEFuZFNlcnZpY2VFeGlzdCgnRVhQT1JUX1RPX1RBQl9ERUxJTUlURUQnLCAnVEVYVF9FWFBPUlRfVE9fVEFCX0RFTElNSVRFRCcpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MyxcclxuICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmV4cG9ydFNlcnZpY2UuZXhwb3J0VG9GaWxlKHtcclxuICAgICAgICAgICAgICBkZWxpbWl0ZXI6IERlbGltaXRlclR5cGUudGFiLFxyXG4gICAgICAgICAgICAgIGZpbGVuYW1lOiAnZXhwb3J0JyxcclxuICAgICAgICAgICAgICBmb3JtYXQ6IEZpbGVUeXBlLnR4dCxcclxuICAgICAgICAgICAgICB1c2VVdGY4V2l0aEJvbTogdHJ1ZSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIC0tIEdyb3VwaW5nIENvbW1hbmRzXHJcbiAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgKGdyaWRPcHRpb25zLmVuYWJsZUdyb3VwaW5nIHx8IGdyaWRPcHRpb25zLmVuYWJsZURyYWdnYWJsZUdyb3VwaW5nKSkge1xyXG4gICAgICAvLyBhZGQgYSBkaXZpZGVyIChzZXBhcmF0b3IpIGJldHdlZW4gdGhlIHRvcCBzb3J0IGNvbW1hbmRzIGFuZCB0aGUgb3RoZXIgY2xlYXIgY29tbWFuZHNcclxuICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goeyBkaXZpZGVyOiB0cnVlLCBjb21tYW5kOiAnJywgcG9zaXRpb25PcmRlcjogNTQgfSk7XHJcblxyXG4gICAgICAvLyBzaG93IGNvbnRleHQgbWVudTogQ2xlYXIgR3JvdXBpbmdcclxuICAgICAgaWYgKGdyaWRPcHRpb25zICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlQ2xlYXJBbGxHcm91cGluZykge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2NsZWFyLWdyb3VwaW5nJztcclxuICAgICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uQ2xlYXJHcm91cGluZ0NvbW1hbmQgfHwgJ2ZhIGZhLXRpbWVzJyxcclxuICAgICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KCdDTEVBUl9BTExfR1JPVVBJTkcnLCAnVEVYVF9DTEVBUl9BTExfR1JPVVBJTkcnKSxcclxuICAgICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTUsXHJcbiAgICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiBkYXRhVmlldy5zZXRHcm91cGluZyhbXSksXHJcbiAgICAgICAgICAgICAgaXRlbVVzYWJpbGl0eU92ZXJyaWRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBvbmx5IGVuYWJsZSB0aGUgY29tbWFuZCB3aGVuIHRoZXJlJ3MgYW4gYWN0dWFsbHkgZ3JvdXBpbmcgaW4gcGxheVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBpbmdBcnJheSA9IGRhdGFWaWV3ICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShncm91cGluZ0FycmF5KSAmJiBncm91cGluZ0FycmF5Lmxlbmd0aCA+IDA7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IENvbGxhcHNlIGFsbCBHcm91cHNcclxuICAgICAgaWYgKGdyaWRPcHRpb25zICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlQ29sbGFwc2VBbGxHcm91cHMpIHtcclxuICAgICAgICBjb25zdCBjb21tYW5kTmFtZSA9ICdjb2xsYXBzZS1hbGwtZ3JvdXBzJztcclxuICAgICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uQ29sbGFwc2VBbGxHcm91cHNDb21tYW5kIHx8ICdmYSBmYS1jb21wcmVzcycsXHJcbiAgICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVXaGVuRW5hYmxlZEFuZFNlcnZpY2VFeGlzdCgnQ09MTEFQU0VfQUxMX0dST1VQUycsICdURVhUX0NPTExBUFNFX0FMTF9HUk9VUFMnKSxcclxuICAgICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTYsXHJcbiAgICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiBkYXRhVmlldy5jb2xsYXBzZUFsbEdyb3VwcygpLFxyXG4gICAgICAgICAgICAgIGl0ZW1Vc2FiaWxpdHlPdmVycmlkZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gb25seSBlbmFibGUgdGhlIGNvbW1hbmQgd2hlbiB0aGVyZSdzIGFuIGFjdHVhbGx5IGdyb3VwaW5nIGluIHBsYXlcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwaW5nQXJyYXkgPSBkYXRhVmlldyAmJiBkYXRhVmlldy5nZXRHcm91cGluZyAmJiBkYXRhVmlldy5nZXRHcm91cGluZygpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZ3JvdXBpbmdBcnJheSkgJiYgZ3JvdXBpbmdBcnJheS5sZW5ndGggPiAwO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBFeHBhbmQgYWxsIEdyb3Vwc1xyXG4gICAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVFeHBhbmRBbGxHcm91cHMpIHtcclxuICAgICAgICBjb25zdCBjb21tYW5kTmFtZSA9ICdleHBhbmQtYWxsLWdyb3Vwcyc7XHJcbiAgICAgICAgaWYgKCFvcmlnaW5hbEN1c3RvbUl0ZW1zLmZpbmQoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgIGljb25Dc3NDbGFzczogY29udGV4dE1lbnUuaWNvbkV4cGFuZEFsbEdyb3Vwc0NvbW1hbmQgfHwgJ2ZhIGZhLWV4cGFuZCcsXHJcbiAgICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVXaGVuRW5hYmxlZEFuZFNlcnZpY2VFeGlzdCgnRVhQQU5EX0FMTF9HUk9VUFMnLCAnVEVYVF9FWFBBTkRfQUxMX0dST1VQUycpLFxyXG4gICAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NyxcclxuICAgICAgICAgICAgICBhY3Rpb246ICgpID0+IGRhdGFWaWV3LmV4cGFuZEFsbEdyb3VwcygpLFxyXG4gICAgICAgICAgICAgIGl0ZW1Vc2FiaWxpdHlPdmVycmlkZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gb25seSBlbmFibGUgdGhlIGNvbW1hbmQgd2hlbiB0aGVyZSdzIGFuIGFjdHVhbGx5IGdyb3VwaW5nIGluIHBsYXlcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwaW5nQXJyYXkgPSBkYXRhVmlldyAmJiBkYXRhVmlldy5nZXRHcm91cGluZyAmJiBkYXRhVmlldy5nZXRHcm91cGluZygpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZ3JvdXBpbmdBcnJheSkgJiYgZ3JvdXBpbmdBcnJheS5sZW5ndGggPiAwO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbWVudUN1c3RvbUl0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlyc3QgZ2V0IHRoZSB2YWx1ZSwgaWYgXCJleHBvcnRXaXRoRm9ybWF0dGVyXCIgaXMgc2V0IHRoZW4gd2UnbGwgdXNlIHRoZSBmb3JtYXR0ZXIgb3V0cHV0XHJcbiAgICogVGhlbiB3ZSBjcmVhdGUgdGhlIERPTSB0cmljayB0byBjb3B5IGEgdGV4dCB2YWx1ZSBieSBjcmVhdGluZyBhIGZha2UgPGRpdj4gdGhhdCBpcyBub3Qgc2hvd24gdG8gdGhlIHVzZXJcclxuICAgKiBhbmQgZnJvbSB0aGVyZSB3ZSBjYW4gY2FsbCB0aGUgZXhlY0NvbW1hbmQgJ2NvcHknIGNvbW1hbmQgYW5kIGV4cGVjdCB0aGUgdmFsdWUgdG8gYmUgaW4gY2xpcGJvYXJkXHJcbiAgICogQHBhcmFtIGFyZ3NcclxuICAgKi9cclxuICBwcml2YXRlIGNvcHlUb0NsaXBib2FyZChhcmdzOiBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChhcmdzICYmIGFyZ3MuZ3JpZCAmJiBhcmdzLmNvbW1hbmQpIHtcclxuICAgICAgICAvLyBnZXQgdGhlIHZhbHVlLCBpZiBcImV4cG9ydFdpdGhGb3JtYXR0ZXJcIiBpcyBzZXQgdGhlbiB3ZSdsbCB1c2UgdGhlIGZvcm1hdHRlciBvdXRwdXRcclxuICAgICAgICBjb25zdCBncmlkT3B0aW9ucyA9IHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgfHwge307XHJcbiAgICAgICAgY29uc3QgY2VsbCA9IGFyZ3MgJiYgYXJncy5jZWxsIHx8IDA7XHJcbiAgICAgICAgY29uc3Qgcm93ID0gYXJncyAmJiBhcmdzLnJvdyB8fCAwO1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbiA9IGFyZ3MgJiYgYXJncy5jb2x1bW47XHJcbiAgICAgICAgY29uc3QgZGF0YUNvbnRleHQgPSBhcmdzICYmIGFyZ3MuZGF0YUNvbnRleHQ7XHJcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZDtcclxuICAgICAgICBjb25zdCBleHBvcnRPcHRpb25zID0gZ3JpZE9wdGlvbnMgJiYgKGdyaWRPcHRpb25zLmV4Y2VsRXhwb3J0T3B0aW9ucyB8fCBncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zKTtcclxuICAgICAgICBjb25zdCB0ZXh0VG9Db3B5ID0gZXhwb3J0V2l0aEZvcm1hdHRlcldoZW5EZWZpbmVkKHJvdywgY2VsbCwgZGF0YUNvbnRleHQsIGNvbHVtbiwgZ3JpZCwgZXhwb3J0T3B0aW9ucyk7XHJcblxyXG4gICAgICAgIC8vIGNyZWF0ZSBmYWtlIDxkaXY+IHRvIGNvcHkgaW50byBjbGlwYm9hcmQgJiBkZWxldGUgaXQgZnJvbSB0aGUgRE9NIG9uY2Ugd2UncmUgZG9uZVxyXG4gICAgICAgIGNvbnN0IHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTtcclxuICAgICAgICBjb25zdCB0bXBFbGVtID0gJCgnPGRpdj4nKS5jc3MoeyBwb3NpdGlvbjogJ2Fic29sdXRlJywgbGVmdDogJy0xMDAwcHgnLCB0b3A6ICctMTAwMHB4JyB9KS50ZXh0KHRleHRUb0NvcHkpO1xyXG4gICAgICAgICQoJ2JvZHknKS5hcHBlbmQodG1wRWxlbSk7XHJcbiAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKHRtcEVsZW0uZ2V0KDApKTtcclxuICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgICAgaWYgKHNlbGVjdGlvbiAmJiBzZWxlY3Rpb24uYWRkUmFuZ2UgJiYgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcykge1xyXG4gICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlKTtcclxuICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScsIGZhbHNlLCB0ZXh0VG9Db3B5KTtcclxuICAgICAgICAgIGlmIChzdWNjZXNzKSB7XHJcbiAgICAgICAgICAgIHRtcEVsZW0ucmVtb3ZlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7IH1cclxuICB9XHJcbn1cclxuIl19