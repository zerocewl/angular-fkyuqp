import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { ExtensionName, } from '../models/index';
import { ExtensionUtility } from './extensionUtility';
import { sanitizeHtmlToText } from '../services/utilities';
import { SharedService } from '../services/shared.service';
var CellExternalCopyManagerExtension = /** @class */ (function () {
    function CellExternalCopyManagerExtension(extensionUtility, sharedService) {
        this.extensionUtility = extensionUtility;
        this.sharedService = sharedService;
        this._eventHandler = new Slick.EventHandler();
    }
    Object.defineProperty(CellExternalCopyManagerExtension.prototype, "addonOptions", {
        get: function () {
            return this._addonOptions;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(CellExternalCopyManagerExtension.prototype, "eventHandler", {
        get: function () {
            return this._eventHandler;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(CellExternalCopyManagerExtension.prototype, "commandQueue", {
        get: function () {
            return this._commandQueue;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(CellExternalCopyManagerExtension.prototype, "undoRedoBuffer", {
        get: function () {
            return this._undoRedoBuffer;
        },
        enumerable: true,
        configurable: true
    });
    CellExternalCopyManagerExtension.prototype.dispose = function () {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
    };
    /** Get the instance of the SlickGrid addon (control or plugin). */
    CellExternalCopyManagerExtension.prototype.getAddonInstance = function () {
        return this._addon;
    };
    CellExternalCopyManagerExtension.prototype.register = function () {
        var _this = this;
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions) {
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.cellExternalCopyManager);
            this.createUndoRedoBuffer();
            this.hookUndoShortcutKey();
            this._addonOptions = tslib_1.__assign({}, this.getDefaultOptions(), this.sharedService.gridOptions.excelCopyBufferOptions);
            this.sharedService.grid.setSelectionModel(new Slick.CellSelectionModel());
            this._addon = new Slick.CellExternalCopyManager(this._addonOptions);
            this.sharedService.grid.registerPlugin(this._addon);
            // hook to all possible events
            if (this.sharedService.grid && this.sharedService.gridOptions.excelCopyBufferOptions) {
                if (this.sharedService.gridOptions.excelCopyBufferOptions.onExtensionRegistered) {
                    this.sharedService.gridOptions.excelCopyBufferOptions.onExtensionRegistered(this._addon);
                }
                this._eventHandler.subscribe(this._addon.onCopyCells, function (e, args) {
                    if (_this.sharedService.gridOptions.excelCopyBufferOptions && typeof _this.sharedService.gridOptions.excelCopyBufferOptions.onCopyCells === 'function') {
                        _this.sharedService.gridOptions.excelCopyBufferOptions.onCopyCells(e, args);
                    }
                });
                this._eventHandler.subscribe(this._addon.onCopyCancelled, function (e, args) {
                    if (_this.sharedService.gridOptions.excelCopyBufferOptions && typeof _this.sharedService.gridOptions.excelCopyBufferOptions.onCopyCancelled === 'function') {
                        _this.sharedService.gridOptions.excelCopyBufferOptions.onCopyCancelled(e, args);
                    }
                });
                this._eventHandler.subscribe(this._addon.onPasteCells, function (e, args) {
                    if (_this.sharedService.gridOptions.excelCopyBufferOptions && typeof _this.sharedService.gridOptions.excelCopyBufferOptions.onPasteCells === 'function') {
                        _this.sharedService.gridOptions.excelCopyBufferOptions.onPasteCells(e, args);
                    }
                });
            }
            return this._addon;
        }
        return null;
    };
    /** Create an undo redo buffer used by the Excel like copy */
    CellExternalCopyManagerExtension.prototype.createUndoRedoBuffer = function () {
        var _this = this;
        var commandCtr = 0;
        this._commandQueue = [];
        this._undoRedoBuffer = {
            queueAndExecuteCommand: function (editCommand) {
                _this._commandQueue[commandCtr] = editCommand;
                commandCtr++;
                editCommand.execute();
            },
            undo: function () {
                if (commandCtr === 0) {
                    return;
                }
                commandCtr--;
                var command = _this._commandQueue[commandCtr];
                if (command && Slick.GlobalEditorLock.cancelCurrentEdit()) {
                    command.undo();
                }
            },
            redo: function () {
                if (commandCtr >= _this._commandQueue.length) {
                    return;
                }
                var command = _this._commandQueue[commandCtr];
                commandCtr++;
                if (command && Slick.GlobalEditorLock.cancelCurrentEdit()) {
                    command.execute();
                }
            }
        };
    };
    /** @return default plugin (addon) options */
    CellExternalCopyManagerExtension.prototype.getDefaultOptions = function () {
        var _this = this;
        var newRowIds = 0;
        return {
            clipboardCommandHandler: function (editCommand) {
                _this._undoRedoBuffer.queueAndExecuteCommand.call(_this._undoRedoBuffer, editCommand);
            },
            dataItemColumnValueExtractor: function (item, columnDef) {
                // when grid or cell is not editable, we will possibly evaluate the Formatter if it was passed
                // to decide if we evaluate the Formatter, we will use the same flag from Export which is "exportWithFormatter"
                if (!_this.sharedService.gridOptions.editable || !columnDef.editor) {
                    var isEvaluatingFormatter = (columnDef.exportWithFormatter !== undefined) ? columnDef.exportWithFormatter : (_this.sharedService.gridOptions.exportOptions && _this.sharedService.gridOptions.exportOptions.exportWithFormatter);
                    if (columnDef.formatter && isEvaluatingFormatter) {
                        var formattedOutput = columnDef.formatter(0, 0, item[columnDef.field], columnDef, item, _this.sharedService.grid);
                        if (columnDef.sanitizeDataExport || (_this.sharedService.gridOptions.exportOptions && _this.sharedService.gridOptions.exportOptions.sanitizeDataExport)) {
                            var outputString = formattedOutput;
                            if (formattedOutput && typeof formattedOutput === 'object' && formattedOutput.hasOwnProperty('text')) {
                                outputString = formattedOutput.text;
                            }
                            if (outputString === null) {
                                outputString = '';
                            }
                            return sanitizeHtmlToText(outputString);
                        }
                        return formattedOutput;
                    }
                }
                // else use the default "dataItemColumnValueExtractor" from the plugin itself
                // we can do that by setting back the getter with null
                return null;
            },
            readOnlyMode: false,
            includeHeaderWhenCopying: false,
            newRowCreator: function (count) {
                for (var i = 0; i < count; i++) {
                    var item = {
                        id: 'newRow_' + newRowIds++
                    };
                    _this.sharedService.grid.getData().addItem(item);
                }
            }
        };
    };
    /** Hook an undo shortcut key hook that will redo/undo the copy buffer using Ctrl+(Shift)+Z keyboard events */
    CellExternalCopyManagerExtension.prototype.hookUndoShortcutKey = function () {
        var _this = this;
        document.addEventListener('keydown', function (e) {
            var keyCode = e.keyCode || e.code;
            if (keyCode === 90 && (e.ctrlKey || e.metaKey)) {
                if (e.shiftKey) {
                    _this._undoRedoBuffer.redo(); // Ctrl + Shift + Z
                }
                else {
                    _this._undoRedoBuffer.undo(); // Ctrl + Z
                }
            }
        });
    };
    CellExternalCopyManagerExtension = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [ExtensionUtility, SharedService])
    ], CellExternalCopyManagerExtension);
    return CellExternalCopyManagerExtension;
}());
export { CellExternalCopyManagerExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VsbEV4dGVybmFsQ29weU1hbmFnZXJFeHRlbnNpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2V4dGVuc2lvbnMvY2VsbEV4dGVybmFsQ29weU1hbmFnZXJFeHRlbnNpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQU1MLGFBQWEsR0FHZCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQU8zRDtJQU9FLDBDQUFvQixnQkFBa0MsRUFBVSxhQUE0QjtRQUF4RSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDMUYsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNoRCxDQUFDO0lBRUQsc0JBQUksMERBQVk7YUFBaEI7WUFDRSxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSwwREFBWTthQUFoQjtZQUNFLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUM1QixDQUFDOzs7T0FBQTtJQUVELHNCQUFJLDBEQUFZO2FBQWhCO1lBQ0UsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQzVCLENBQUM7OztPQUFBO0lBRUQsc0JBQUksNERBQWM7YUFBbEI7WUFDRSxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7UUFDOUIsQ0FBQzs7O09BQUE7SUFFRCxrREFBTyxHQUFQO1FBQ0UsbUNBQW1D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O1lBQ0gsQ0FBQztTQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsOEdBQThHO0lBQ3RHLDhEQUFtQixHQUEzQjtRQUFBLGlCQVdDO1FBVkMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxVQUFDLENBQWdCO1lBQ3BELElBQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNwQyxJQUFJLE9BQU8sS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO29CQUNkLEtBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxtQkFBbUI7aUJBQ2pEO3FCQUFNO29CQUNMLEtBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxXQUFXO2lCQUN6QzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBMUtVLGdDQUFnQztRQUQ1QyxVQUFVLEVBQUU7aURBUTJCLGdCQUFnQixFQUF5QixhQUFhO09BUGpGLGdDQUFnQyxDQTJLNUM7SUFBRCx1Q0FBQztDQUFBLEFBM0tELElBMktDO1NBM0tZLGdDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICBDb2x1bW4sXHJcbiAgRWRpdENvbW1hbmQsXHJcbiAgRWRpdFVuZG9SZWRvQnVmZmVyLFxyXG4gIEV4Y2VsQ29weUJ1ZmZlck9wdGlvbixcclxuICBFeHRlbnNpb24sXHJcbiAgRXh0ZW5zaW9uTmFtZSxcclxuICBTZWxlY3RlZFJhbmdlLFxyXG4gIFNsaWNrRXZlbnRIYW5kbGVyLFxyXG59IGZyb20gJy4uL21vZGVscy9pbmRleCc7XHJcbmltcG9ydCB7IEV4dGVuc2lvblV0aWxpdHkgfSBmcm9tICcuL2V4dGVuc2lvblV0aWxpdHknO1xyXG5pbXBvcnQgeyBzYW5pdGl6ZUh0bWxUb1RleHQgfSBmcm9tICcuLi9zZXJ2aWNlcy91dGlsaXRpZXMnO1xyXG5pbXBvcnQgeyBTaGFyZWRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc2hhcmVkLnNlcnZpY2UnO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIHZhciBTbGljazogYW55O1xyXG5kZWNsYXJlIHZhciAkOiBhbnk7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDZWxsRXh0ZXJuYWxDb3B5TWFuYWdlckV4dGVuc2lvbiBpbXBsZW1lbnRzIEV4dGVuc2lvbiB7XHJcbiAgcHJpdmF0ZSBfYWRkb246IGFueTtcclxuICBwcml2YXRlIF9hZGRvbk9wdGlvbnM6IEV4Y2VsQ29weUJ1ZmZlck9wdGlvbjtcclxuICBwcml2YXRlIF9ldmVudEhhbmRsZXI6IFNsaWNrRXZlbnRIYW5kbGVyO1xyXG4gIHByaXZhdGUgX2NvbW1hbmRRdWV1ZTogRWRpdENvbW1hbmRbXTtcclxuICBwcml2YXRlIF91bmRvUmVkb0J1ZmZlcjogRWRpdFVuZG9SZWRvQnVmZmVyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGV4dGVuc2lvblV0aWxpdHk6IEV4dGVuc2lvblV0aWxpdHksIHByaXZhdGUgc2hhcmVkU2VydmljZTogU2hhcmVkU2VydmljZSkge1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyID0gbmV3IFNsaWNrLkV2ZW50SGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGFkZG9uT3B0aW9ucygpOiBFeGNlbENvcHlCdWZmZXJPcHRpb24ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2FkZG9uT3B0aW9ucztcclxuICB9XHJcblxyXG4gIGdldCBldmVudEhhbmRsZXIoKTogU2xpY2tFdmVudEhhbmRsZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX2V2ZW50SGFuZGxlcjtcclxuICB9XHJcblxyXG4gIGdldCBjb21tYW5kUXVldWUoKTogRWRpdENvbW1hbmRbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29tbWFuZFF1ZXVlO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHVuZG9SZWRvQnVmZmVyKCk6IEVkaXRVbmRvUmVkb0J1ZmZlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fdW5kb1JlZG9CdWZmZXI7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCkge1xyXG4gICAgLy8gdW5zdWJzY3JpYmUgYWxsIFNsaWNrR3JpZCBldmVudHNcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlci51bnN1YnNjcmliZUFsbCgpO1xyXG4gICAgaWYgKHRoaXMuX2FkZG9uICYmIHRoaXMuX2FkZG9uLmRlc3Ryb3kpIHtcclxuICAgICAgdGhpcy5fYWRkb24uZGVzdHJveSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqIEdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlIFNsaWNrR3JpZCBhZGRvbiAoY29udHJvbCBvciBwbHVnaW4pLiAqL1xyXG4gIGdldEFkZG9uSW5zdGFuY2UoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgfVxyXG5cclxuICByZWdpc3RlcigpOiBhbnkge1xyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMpIHtcclxuICAgICAgLy8gZHluYW1pY2FsbHkgaW1wb3J0IHRoZSBTbGlja0dyaWQgcGx1Z2luIChhZGRvbikgd2l0aCBSZXF1aXJlSlNcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LmxvYWRFeHRlbnNpb25EeW5hbWljYWxseShFeHRlbnNpb25OYW1lLmNlbGxFeHRlcm5hbENvcHlNYW5hZ2VyKTtcclxuICAgICAgdGhpcy5jcmVhdGVVbmRvUmVkb0J1ZmZlcigpO1xyXG4gICAgICB0aGlzLmhvb2tVbmRvU2hvcnRjdXRLZXkoKTtcclxuXHJcbiAgICAgIHRoaXMuX2FkZG9uT3B0aW9ucyA9IHsgLi4udGhpcy5nZXREZWZhdWx0T3B0aW9ucygpLCAuLi50aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucyB9IGFzIEV4Y2VsQ29weUJ1ZmZlck9wdGlvbjtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQuc2V0U2VsZWN0aW9uTW9kZWwobmV3IFNsaWNrLkNlbGxTZWxlY3Rpb25Nb2RlbCgpKTtcclxuICAgICAgdGhpcy5fYWRkb24gPSBuZXcgU2xpY2suQ2VsbEV4dGVybmFsQ29weU1hbmFnZXIodGhpcy5fYWRkb25PcHRpb25zKTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQucmVnaXN0ZXJQbHVnaW4odGhpcy5fYWRkb24pO1xyXG5cclxuICAgICAgLy8gaG9vayB0byBhbGwgcG9zc2libGUgZXZlbnRzXHJcbiAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucykge1xyXG4gICAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucy5vbkV4dGVuc2lvblJlZ2lzdGVyZWQpIHtcclxuICAgICAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leGNlbENvcHlCdWZmZXJPcHRpb25zLm9uRXh0ZW5zaW9uUmVnaXN0ZXJlZCh0aGlzLl9hZGRvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25Db3B5Q2VsbHMsIChlOiBhbnksIGFyZ3M6IHsgcmFuZ2VzOiBTZWxlY3RlZFJhbmdlW10gfSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leGNlbENvcHlCdWZmZXJPcHRpb25zICYmIHR5cGVvZiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucy5vbkNvcHlDZWxscyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucy5vbkNvcHlDZWxscyhlLCBhcmdzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uQ29weUNhbmNlbGxlZCwgKGU6IGFueSwgYXJnczogeyByYW5nZXM6IFNlbGVjdGVkUmFuZ2VbXSB9KSA9PiB7XHJcbiAgICAgICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmV4Y2VsQ29weUJ1ZmZlck9wdGlvbnMgJiYgdHlwZW9mIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leGNlbENvcHlCdWZmZXJPcHRpb25zLm9uQ29weUNhbmNlbGxlZCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucy5vbkNvcHlDYW5jZWxsZWQoZSwgYXJncyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vblBhc3RlQ2VsbHMsIChlOiBhbnksIGFyZ3M6IHsgcmFuZ2VzOiBTZWxlY3RlZFJhbmdlW10gfSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leGNlbENvcHlCdWZmZXJPcHRpb25zICYmIHR5cGVvZiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZXhjZWxDb3B5QnVmZmVyT3B0aW9ucy5vblBhc3RlQ2VsbHMgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmV4Y2VsQ29weUJ1ZmZlck9wdGlvbnMub25QYXN0ZUNlbGxzKGUsIGFyZ3MpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKiBDcmVhdGUgYW4gdW5kbyByZWRvIGJ1ZmZlciB1c2VkIGJ5IHRoZSBFeGNlbCBsaWtlIGNvcHkgKi9cclxuICBwcml2YXRlIGNyZWF0ZVVuZG9SZWRvQnVmZmVyKCkge1xyXG4gICAgbGV0IGNvbW1hbmRDdHIgPSAwO1xyXG4gICAgdGhpcy5fY29tbWFuZFF1ZXVlID0gW107XHJcblxyXG4gICAgdGhpcy5fdW5kb1JlZG9CdWZmZXIgPSB7XHJcbiAgICAgIHF1ZXVlQW5kRXhlY3V0ZUNvbW1hbmQ6IChlZGl0Q29tbWFuZDogRWRpdENvbW1hbmQpID0+IHtcclxuICAgICAgICB0aGlzLl9jb21tYW5kUXVldWVbY29tbWFuZEN0cl0gPSBlZGl0Q29tbWFuZDtcclxuICAgICAgICBjb21tYW5kQ3RyKys7XHJcbiAgICAgICAgZWRpdENvbW1hbmQuZXhlY3V0ZSgpO1xyXG4gICAgICB9LFxyXG4gICAgICB1bmRvOiAoKSA9PiB7XHJcbiAgICAgICAgaWYgKGNvbW1hbmRDdHIgPT09IDApIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29tbWFuZEN0ci0tO1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLl9jb21tYW5kUXVldWVbY29tbWFuZEN0cl07XHJcbiAgICAgICAgaWYgKGNvbW1hbmQgJiYgU2xpY2suR2xvYmFsRWRpdG9yTG9jay5jYW5jZWxDdXJyZW50RWRpdCgpKSB7XHJcbiAgICAgICAgICBjb21tYW5kLnVuZG8oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlZG86ICgpID0+IHtcclxuICAgICAgICBpZiAoY29tbWFuZEN0ciA+PSB0aGlzLl9jb21tYW5kUXVldWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLl9jb21tYW5kUXVldWVbY29tbWFuZEN0cl07XHJcbiAgICAgICAgY29tbWFuZEN0cisrO1xyXG4gICAgICAgIGlmIChjb21tYW5kICYmIFNsaWNrLkdsb2JhbEVkaXRvckxvY2suY2FuY2VsQ3VycmVudEVkaXQoKSkge1xyXG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqIEByZXR1cm4gZGVmYXVsdCBwbHVnaW4gKGFkZG9uKSBvcHRpb25zICovXHJcbiAgcHJpdmF0ZSBnZXREZWZhdWx0T3B0aW9ucygpOiBFeGNlbENvcHlCdWZmZXJPcHRpb24ge1xyXG4gICAgbGV0IG5ld1Jvd0lkcyA9IDA7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgY2xpcGJvYXJkQ29tbWFuZEhhbmRsZXI6IChlZGl0Q29tbWFuZDogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy5fdW5kb1JlZG9CdWZmZXIucXVldWVBbmRFeGVjdXRlQ29tbWFuZC5jYWxsKHRoaXMuX3VuZG9SZWRvQnVmZmVyLCBlZGl0Q29tbWFuZCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGRhdGFJdGVtQ29sdW1uVmFsdWVFeHRyYWN0b3I6IChpdGVtOiBhbnksIGNvbHVtbkRlZjogQ29sdW1uKSA9PiB7XHJcbiAgICAgICAgLy8gd2hlbiBncmlkIG9yIGNlbGwgaXMgbm90IGVkaXRhYmxlLCB3ZSB3aWxsIHBvc3NpYmx5IGV2YWx1YXRlIHRoZSBGb3JtYXR0ZXIgaWYgaXQgd2FzIHBhc3NlZFxyXG4gICAgICAgIC8vIHRvIGRlY2lkZSBpZiB3ZSBldmFsdWF0ZSB0aGUgRm9ybWF0dGVyLCB3ZSB3aWxsIHVzZSB0aGUgc2FtZSBmbGFnIGZyb20gRXhwb3J0IHdoaWNoIGlzIFwiZXhwb3J0V2l0aEZvcm1hdHRlclwiXHJcbiAgICAgICAgaWYgKCF0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZWRpdGFibGUgfHwgIWNvbHVtbkRlZi5lZGl0b3IpIHtcclxuICAgICAgICAgIGNvbnN0IGlzRXZhbHVhdGluZ0Zvcm1hdHRlciA9IChjb2x1bW5EZWYuZXhwb3J0V2l0aEZvcm1hdHRlciAhPT0gdW5kZWZpbmVkKSA/IGNvbHVtbkRlZi5leHBvcnRXaXRoRm9ybWF0dGVyIDogKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zLmV4cG9ydFdpdGhGb3JtYXR0ZXIpO1xyXG4gICAgICAgICAgaWYgKGNvbHVtbkRlZi5mb3JtYXR0ZXIgJiYgaXNFdmFsdWF0aW5nRm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1hdHRlZE91dHB1dCA9IGNvbHVtbkRlZi5mb3JtYXR0ZXIoMCwgMCwgaXRlbVtjb2x1bW5EZWYuZmllbGRdLCBjb2x1bW5EZWYsIGl0ZW0sIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkKTtcclxuICAgICAgICAgICAgaWYgKGNvbHVtbkRlZi5zYW5pdGl6ZURhdGFFeHBvcnQgfHwgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zLnNhbml0aXplRGF0YUV4cG9ydCkpIHtcclxuICAgICAgICAgICAgICBsZXQgb3V0cHV0U3RyaW5nID0gZm9ybWF0dGVkT3V0cHV0IGFzIHN0cmluZztcclxuICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVkT3V0cHV0ICYmIHR5cGVvZiBmb3JtYXR0ZWRPdXRwdXQgPT09ICdvYmplY3QnICYmIGZvcm1hdHRlZE91dHB1dC5oYXNPd25Qcm9wZXJ0eSgndGV4dCcpKSB7XHJcbiAgICAgICAgICAgICAgICBvdXRwdXRTdHJpbmcgPSBmb3JtYXR0ZWRPdXRwdXQudGV4dDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgaWYgKG91dHB1dFN0cmluZyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgb3V0cHV0U3RyaW5nID0gJyc7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJldHVybiBzYW5pdGl6ZUh0bWxUb1RleHQob3V0cHV0U3RyaW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZm9ybWF0dGVkT3V0cHV0O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBlbHNlIHVzZSB0aGUgZGVmYXVsdCBcImRhdGFJdGVtQ29sdW1uVmFsdWVFeHRyYWN0b3JcIiBmcm9tIHRoZSBwbHVnaW4gaXRzZWxmXHJcbiAgICAgICAgLy8gd2UgY2FuIGRvIHRoYXQgYnkgc2V0dGluZyBiYWNrIHRoZSBnZXR0ZXIgd2l0aCBudWxsXHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlYWRPbmx5TW9kZTogZmFsc2UsXHJcbiAgICAgIGluY2x1ZGVIZWFkZXJXaGVuQ29weWluZzogZmFsc2UsXHJcbiAgICAgIG5ld1Jvd0NyZWF0b3I6IChjb3VudDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtID0ge1xyXG4gICAgICAgICAgICBpZDogJ25ld1Jvd18nICsgbmV3Um93SWRzKytcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZC5nZXREYXRhKCkuYWRkSXRlbShpdGVtKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKiogSG9vayBhbiB1bmRvIHNob3J0Y3V0IGtleSBob29rIHRoYXQgd2lsbCByZWRvL3VuZG8gdGhlIGNvcHkgYnVmZmVyIHVzaW5nIEN0cmwrKFNoaWZ0KStaIGtleWJvYXJkIGV2ZW50cyAqL1xyXG4gIHByaXZhdGUgaG9va1VuZG9TaG9ydGN1dEtleSgpIHtcclxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZTogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICBjb25zdCBrZXlDb2RlID0gZS5rZXlDb2RlIHx8IGUuY29kZTtcclxuICAgICAgaWYgKGtleUNvZGUgPT09IDkwICYmIChlLmN0cmxLZXkgfHwgZS5tZXRhS2V5KSkge1xyXG4gICAgICAgIGlmIChlLnNoaWZ0S2V5KSB7XHJcbiAgICAgICAgICB0aGlzLl91bmRvUmVkb0J1ZmZlci5yZWRvKCk7IC8vIEN0cmwgKyBTaGlmdCArIFpcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5fdW5kb1JlZG9CdWZmZXIudW5kbygpOyAvLyBDdHJsICsgWlxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==